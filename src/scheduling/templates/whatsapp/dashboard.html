{% extends "base_dashboard.html" %}{% extends "base_dashboard.html" %}

{% load static %}{% load static %}



{% block title %}Gerenciar WhatsApp - Bora Agendar{% endblock %}{% block title %}Gerenciar WhatsApp - Bora Agendar{% endblock %}



{% block extra_css %}{% block extra_css %}

<style><style>

    .whatsapp-container {    .whatsapp-container {

        max-width: 1100px;        max-width: 1100px;

        margin: 40px auto;        margin: 40px auto;

        padding: 30px;        padding: 30px;

        background: white;        background: white;

        border-radius: 8px;        border-radius: 8px;

        box-shadow: 0 2px 8px rgba(0,0,0,0.06);        box-shadow: 0 2px 8px rgba(0,0,0,0.06);

    }    }

        

    .header { margin-bottom: 18px }    .header { margin-bottom: 18px }

    .header h1 { color: #111827; margin: 6px 0 }    .header h1 { color: #111827; margin: 6px 0 }



    .loading { text-align:center; padding:30px }    .loading { text-align:center; padding:30px }

    .loading::after { content:""; display:inline-block; width:40px; height:40px; border:4px solid #f3f3f3; border-top:4px solid #10b981; border-radius:50%; animation:spin 1s linear infinite }    .loading::after { content:""; display:inline-block; width:40px; height:40px; border:4px solid #f3f3f3; border-top:4px solid #10b981; border-radius:50%; animation:spin 1s linear infinite }

    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }



    .grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:18px; align-items:start }    .grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:18px; align-items:start }

    .info-box { background:#f8fafc; border-radius:6px; padding:18px; border-left:6px solid #10b981 }    .info-box { background:#f8fafc; border-radius:6px; padding:18px; border-left:6px solid #10b981 }



    .btn-connect { display:inline-flex; align-items:center; gap:8px; padding:10px 16px; border-radius:6px; border:none; font-weight:600; cursor:pointer }    .btn-connect { display:inline-flex; align-items:center; gap:8px; padding:10px 16px; border-radius:6px; border:none; font-weight:600; cursor:pointer }

    .btn-green{background:#10b981;color:white} .btn-teal{background:#0f766e;color:white} .btn-yellow{background:#f59e0b;color:white} .btn-red{background:#ef4444;color:white}    .btn-green{background:#10b981;color:white} .btn-teal{background:#0f766e;color:white} .btn-yellow{background:#f59e0b;color:white} .btn-red{background:#ef4444;color:white}



    .panel { background:#fff; border-radius:8px; padding:20px; box-shadow:0 1px 3px rgba(0,0,0,0.03); margin-bottom:18px }    .panel { background:#fff; border-radius:8px; padding:20px; box-shadow:0 1px 3px rgba(0,0,0,0.03); margin-bottom:18px }

    .form-control{width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:6px}    .form-control{width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:6px}

    .help-muted{color:#6b7280; font-size:0.95em}    .help-muted{color:#6b7280; font-size:0.95em}

    .qr-display img{max-width:320px; border-radius:8px}    .qr-display img{max-width:320px; border-radius:8px}

    .alert{padding:12px 16px; border-radius:8px; margin-top:12px}    .alert{padding:12px 16px; border-radius:8px; margin-top:12px}

    .alert-success{background:#d1fae5; border:1px solid #34d399; color:#065f46}    .alert-success{background:#d1fae5; border:1px solid #34d399; color:#065f46}

    .alert-danger{background:#fee2e2; border:1px solid #f87171; color:#991b1b}    .alert-danger{background:#fee2e2; border:1px solid #f87171; color:#991b1b}

</style></style>

{% endblock %}{% endblock %}



{% block content %}{% block content %}

<div class="whatsapp-container"><div class="whatsapp-container">

    <div class="header"><h1>Gerenciador WhatsApp Evolution API</h1></div>    <div class="header"><h1>Gerenciador WhatsApp Evolution API</h1></div>



    {% if whatsapps and whatsapps.0 %}    {% if whatsapps and whatsapps.0 %}

    <div data-whatsapp-id="{{ whatsapps.0.id }}"></div>    <div data-whatsapp-id="{{ whatsapps.0.id }}"></div>

    {% endif %}    {% endif %}



    <div class="panel">    <div class="panel">

        <h3 style="margin:0 0 8px">Status da Conex√£o</h3>        <h3 style="margin:0 0 8px">Status da Conex√£o</h3>

        <p style="margin:6px 0 14px; color:#6b7280"><span id="status-dot">üî¥</span> <strong id="status-text">Desconectado</strong></p>        <p style="margin:6px 0 14px; color:#6b7280"><span id="status-dot">üî¥</span> <strong id="status-text">Desconectado</strong></p>



        <div class="grid-3">        <div class="grid-3">

            <div class="info-box">            <div class="info-box">

                <div style="font-size:0.9em; color:#6b7280">URL da API</div>                <div style="font-size:0.9em; color:#6b7280">URL da API</div>

                <div style="margin-top:8px; word-break:break-all; font-weight:600">{{ EVOLUTION_API_URL }}</div>                <div style="margin-top:8px; word-break:break-all; font-weight:600">{{ EVOLUTION_API_URL }}</div>

            </div>            </div>



            <div class="info-box">            <div class="info-box">

                <div style="font-size:0.9em; color:#6b7280">Inst√¢ncia</div>                <div style="font-size:0.9em; color:#6b7280">Inst√¢ncia</div>

                <div style="margin-top:8px; font-weight:600">{% if whatsapps and whatsapps.0.instance_name %}{{ whatsapps.0.instance_name }}{% else %}-{% endif %}</div>                <div style="margin-top:8px; font-weight:600">{% if whatsapps and whatsapps.0.instance_name %}{{ whatsapps.0.instance_name }}{% else %}-{% endif %}</div>

            </div>            </div>



            <div class="info-box">            <div class="info-box">

                <div style="font-size:0.9em; color:#6b7280">Estado</div>                <div style="font-size:0.9em; color:#6b7280">Estado</div>

                <div style="margin-top:8px; font-weight:600" id="instance-state">{% if whatsapps and whatsapps.0.connection_status %}{{ whatsapps.0.connection_status }}{% else %}disconnected{% endif %}</div>                <div style="margin-top:8px; font-weight:600" id="instance-state">{% if whatsapps and whatsapps.0.connection_status %}{{ whatsapps.0.connection_status }}{% else %}disconnected{% endif %}</div>

            </div>            </div>

        </div>        </div>



        <div style="margin-top:14px; display:flex; gap:12px">        <div style="margin-top:14px; display:flex; gap:12px">

            <button class="btn-connect btn-green" onclick="updateStatusAll()">üîÑ Atualizar Status</button>            <button class="btn-connect btn-green" onclick="updateStatusAll()">üîÑ Atualizar Status</button>

            <button class="btn-connect btn-teal" onclick="reconectar()">üì± Reconectar WhatsApp</button>            <button class="btn-connect btn-teal" onclick="reconectar()">ÔøΩ Reconectar WhatsApp</button>

            <button class="btn-connect btn-yellow" onclick="showQr()">üì∑ Mostrar QR Code</button>            <button class="btn-connect btn-yellow" onclick="showQr()">ÔøΩ Mostrar QR Code</button>

            <button class="btn-connect btn-red" onclick="disconnect()">‚õî Desconectar WhatsApp</button>            <button class="btn-connect btn-red" onclick="disconnect()">‚õî Desconectar WhatsApp</button>

        </div>        </div>

    </div>    </div>



    <div class="panel">    <div class="panel">

        <h3 style="margin:0 0 8px">Enviar Mensagem de Teste</h3>        <h3 style="margin:0 0 8px">Enviar Mensagem de Teste</h3>

        <p class="help-muted">üí° Dica: Voc√™ pode enviar para n√∫meros individuais ou para grupos. Para grupos, copie o ID do grupo do WhatsApp (formato: 120363xxx@g.us)</p>        <p class="help-muted">üí° Dica: Voc√™ pode enviar para n√∫meros individuais ou para grupos. Para grupos, copie o ID do grupo do WhatsApp (formato: 120363xxx@g.us)</p>



        <label style="display:block; margin-top:12px; font-weight:600">N√∫mero do WhatsApp ou ID do Grupo</label>        <label style="display:block; margin-top:12px; font-weight:600">N√∫mero do WhatsApp ou ID do Grupo</label>

        <input id="to-number" class="form-control" placeholder="5511999999999  ou  120363xxx@g.us">        <input id="to-number" class="form-control" placeholder="5511999999999  ou  120363xxx@g.us">

        <div style="margin-top:8px" class="help-muted">üì± Para n√∫mero: Use com ou sem + e c√≥digo do pa√≠s<br>üë• Para grupo: Cole o ID do grupo (termine com @g.us)</div>        <div style="margin-top:8px" class="help-muted">üì± Para n√∫mero: Use com ou sem + e c√≥digo do pa√≠s<br>üë• Para grupo: Cole o ID do grupo (termine com @g.us)</div>



        <label style="display:block; margin-top:14px; font-weight:600">Mensagem</label>        <label style="display:block; margin-top:14px; font-weight:600">Mensagem</label>

        <textarea id="message" class="form-control" rows="4">Ol√°! Esta √© uma mensagem de teste do sistema de rifas. üéâ</textarea>        <textarea id="message" class="form-control" rows="4">Ol√°! Esta √© uma mensagem de teste do sistema de rifas. üéâ</textarea>



        <div style="margin-top:12px">        <div style="margin-top:12px">

            <button class="btn-connect btn-green" onclick="sendTestMessage()">üì© Enviar Mensagem</button>            <button class="btn-connect btn-green" onclick="sendTestMessage()">üì© Enviar Mensagem</button>

        </div>        </div>



        <div id="resultado" style="margin-top:10px"></div>        <div id="resultado" style="margin-top:10px"></div>

    </div>    </div>

</div></div>



<script><script>

console.log('‚úÖ Script carregado');console.log('‚úÖ Script carregado');



// Sincronizar status ao carregar a p√°gina// Sincronizar status ao carregar a p√°gina

window.addEventListener('load', () => {window.addEventListener('load', () => {

    console.log('üìü P√°gina carregada, sincronizando status...');    console.log('üìü P√°gina carregada, sincronizando status...');

    updateStatusAll();    updateStatusAll();

});});



// Sincronizar a cada 10 segundos// Sincronizar a cada 10 segundos

setInterval(updateStatusAll, 10000);setInterval(updateStatusAll, 10000);



function updateStatusAll() {function updateStatusAll() {

    const statusText = document.getElementById('status-text');    const statusText = document.getElementById('status-text');

    const statusDot = document.getElementById('status-dot');    const statusDot = document.getElementById('status-dot');

    const resultado = document.getElementById('resultado');

    // Primeiro, sincroniza com Evolution API via whatsapp_status_api

    // Primeiro, sincroniza com Evolution API via whatsapp_status_api    const whatsappId = document.querySelector('[data-whatsapp-id]')?.getAttribute('data-whatsapp-id');

    const whatsappId = document.querySelector('[data-whatsapp-id]')?.getAttribute('data-whatsapp-id');    if (whatsappId) {

    if (whatsappId) {        fetch(`/dashboard/whatsapp/${whatsappId}/status/`)

        console.log('üîç Sincronizando whatsapp_id:', whatsappId);            .then(r => r.json())

        fetch(`/dashboard/whatsapp/${whatsappId}/status/`)            .then(data => {

            .then(r => {                console.log('‚úÖ Status sincronizado:', data.status);

                console.log('üì° Response status:', r.status);                document.getElementById('instance-state').textContent = data.status || 'disconnected';

                return r.json();                

            })                if (data.status === 'connected') {

            .then(data => {                    statusText.textContent = 'Conectado'; 

                console.log('‚úÖ Resposta completa:', JSON.stringify(data, null, 2));                    statusDot.textContent = 'üü¢';

                console.log('Status sincronizado:', data.status);                } else if (data.status === 'connecting') {

                document.getElementById('instance-state').textContent = data.status || 'disconnected';                    statusText.textContent = 'Conectando'; 

                                    statusDot.textContent = 'ÔøΩ';

                // Debug: mostrar resposta no painel                } else {

                resultado.innerHTML = `<div class="alert alert-success">                    statusText.textContent = 'Desconectado'; 

                    <strong>‚úÖ Debug Info:</strong><br>                    statusDot.textContent = 'üî¥';

                    Status: <code>${data.status}</code><br>                }

                    is_connected: <code>${data.is_connected}</code><br>            })

                    Phone: <code>${data.phone_number}</code><br>            .catch(err => console.error('Erro ao sincronizar:', err));

                    <pre style="font-size:0.85em; background:#f0f0f0; padding:8px; border-radius:4px; overflow-x:auto">${JSON.stringify(data, null, 2)}</pre>    }

                </div>`;

                    // Depois, tenta listar todos

                if (data.status === 'connected') {    fetch('{% url "whatsapp:list_api" %}')

                    statusText.textContent = 'Conectado';         .then(r => r.json())

                    statusDot.textContent = 'üü¢';        .then(data => {

                } else if (data.status === 'connecting') {            const whats = data.whatsapps || [];

                    statusText.textContent = 'Conectando';             if (whats.length === 0) {

                    statusDot.textContent = 'üü°';                statusText.textContent = 'Desconectado';

                } else {                statusDot.textContent = 'üî¥';

                    statusText.textContent = 'Desconectado';                 document.getElementById('instance-state').textContent = 'disconnected';

                    statusDot.textContent = 'üî¥';                return;

                }            }

            })

            .catch(err => {            const first = whats[0];

                console.error('‚ùå Erro ao sincronizar:', err);            console.log('üìä Lista de WhatsApps:', first);

                resultado.innerHTML = `<div class="alert alert-danger">        })

                    <strong>‚ùå Erro ao sincronizar:</strong><br>        .catch(err => console.error(err));

                    ${err.message}<br>}

                    <code>${err.stack}</code>

                </div>`;function showQr() {

            });    const resultado = document.getElementById('resultado');

    } else {    resultado.innerHTML = '<div class="loading"></div>';

        console.warn('‚ö†Ô∏è  Nenhum whatsapp_id encontrado');

        resultado.innerHTML = `<div class="alert alert-danger">‚ö†Ô∏è  Nenhum WhatsApp para sincronizar</div>`;    fetch('{% url "whatsapp:create" %}', { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'} })

    }        .then(resp => resp.json())

        .then(data => {

    // Depois, tenta listar todos            if (data.qr_code) {

    fetch('{% url "whatsapp:list_api" %}')                resultado.innerHTML = `\n                    <div class="qr-display">\n                        <h3>‚úÖ QR Code Gerado!</h3>\n                        <img src="${data.qr_code}" alt="QR Code WhatsApp">\n                        <p style="color: #6b7280;">${data.message || 'Escaneie o QR code com seu WhatsApp'}</p>\n                    </div>\n                `;

        .then(r => r.json())            } else {

        .then(data => {                resultado.innerHTML = `<div class="alert alert-danger">‚ùå Erro: ${data.error || 'Sem QR code'}</div>`;

            console.log('üìä Lista de WhatsApps:', data);            }

            const whats = data.whatsapps || [];        })

            if (whats.length === 0) {        .catch(err => {

                console.warn('‚ö†Ô∏è  Nenhum WhatsApp na lista');            console.error(err);

                return;            resultado.innerHTML = `<div class="alert alert-danger">‚ùå Erro ao gerar QR: ${err.message}</div>`;

            }        });

}

            const first = whats[0];

            console.log('üìä Primeiro WhatsApp:', first);function reconectar() {

        })    const resultado = document.getElementById('resultado');

        .catch(err => console.error('‚ùå Erro ao listar:', err));    resultado.innerHTML = '<div class="loading"></div>';

}

    const whatsappId = document.querySelector('[data-whatsapp-id]')?.getAttribute('data-whatsapp-id');

function showQr() {    if (!whatsappId) {

    const resultado = document.getElementById('resultado');        resultado.innerHTML = '<div class="alert alert-danger">‚ùå Nenhum WhatsApp para reconectar</div>';

    resultado.innerHTML = '<div class="loading"></div>';        return;

    }

    fetch('{% url "whatsapp:create" %}', { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'} })

        .then(resp => resp.json())    fetch('{% url "whatsapp:reconnect" %}', {

        .then(data => {        method: 'POST',

            if (data.qr_code) {        headers: {

                resultado.innerHTML = `            'X-CSRFToken': '{{ csrf_token }}',

                    <div class="qr-display">            'Content-Type': 'application/json'

                        <h3>‚úÖ QR Code Gerado!</h3>        },

                        <img src="${data.qr_code}" alt="QR Code WhatsApp">        body: JSON.stringify({ whatsapp_id: whatsappId })

                        <p style="color: #6b7280;">${data.message || 'Escaneie o QR code com seu WhatsApp'}</p>    })

                    </div>    .then(resp => resp.json())

                `;    .then(data => {

            } else {        if (data.qr_code) {

                resultado.innerHTML = `<div class="alert alert-danger">‚ùå Erro: ${data.error || 'Sem QR code'}</div>`;            resultado.innerHTML = `\n                    <div class="qr-display">\n                        <h3>‚úÖ Reconectando!</h3>\n                        <img src="${data.qr_code}" alt="QR Code WhatsApp">\n                        <p style="color: #6b7280;">${data.message}</p>\n                    </div>\n                `;

            }            updateStatusAll();

        })        } else {

        .catch(err => {            resultado.innerHTML = `<div class="alert alert-danger">‚ùå ${data.error || 'Erro ao reconectar'}</div>`;

            console.error(err);        }

            resultado.innerHTML = `<div class="alert alert-danger">‚ùå Erro ao gerar QR: ${err.message}</div>`;    })

        });    .catch(err => {

}        console.error(err);

        resultado.innerHTML = `<div class="alert alert-danger">‚ùå Erro: ${err.message}</div>`;

function reconectar() {    });

    const resultado = document.getElementById('resultado');}

    resultado.innerHTML = '<div class="loading"></div>';

function restartInstance() {

    const whatsappId = document.querySelector('[data-whatsapp-id]')?.getAttribute('data-whatsapp-id');    if (!confirm('üîÅ Reiniciar inst√¢ncia?')) return;

    if (!whatsappId) {    showQr();

        resultado.innerHTML = '<div class="alert alert-danger">‚ùå Nenhum WhatsApp para reconectar</div>';}

        return;

    }function disconnect() {

    if (!confirm('‚ö†Ô∏è Desconectar WhatsApp? Voc√™ n√£o receber√° mais confirma√ß√µes por este n√∫mero.')) return;

    fetch('{% url "whatsapp:reconnect" %}', {

        method: 'POST',    fetch('{% if whatsapps and whatsapps.0 %}{% url "whatsapp:disconnect" whatsapps.0.id %}{% else %}#{% endif %}', {

        headers: {        method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' }

            'X-CSRFToken': '{{ csrf_token }}',    })

            'Content-Type': 'application/json'    .then(r => r.json())

        },    .then(data => {

        body: JSON.stringify({ whatsapp_id: whatsappId })        if (data.success) {

    })            updateStatusAll();

    .then(resp => resp.json())            alert(data.message);

    .then(data => {        } else {

        if (data.qr_code) {            alert('Erro: ' + (data.error || 'unknown'));

            resultado.innerHTML = `        }

                    <div class="qr-display">    })

                        <h3>‚úÖ Reconectando!</h3>    .catch(err => { console.error(err); alert('Erro ao desconectar') });

                        <img src="${data.qr_code}" alt="QR Code WhatsApp">}

                        <p style="color: #6b7280;">${data.message}</p>

                    </div>function sendTestMessage() {

                `;    const to = document.getElementById('to-number').value.trim();

            updateStatusAll();    const message = document.getElementById('message').value.trim();

        } else {    const resultado = document.getElementById('resultado');

            resultado.innerHTML = `<div class="alert alert-danger">‚ùå ${data.error || 'Erro ao reconectar'}</div>`;    resultado.innerHTML = '';

        }

    })    if (!to || !message) {

    .catch(err => {        resultado.innerHTML = '<div class="alert alert-danger">‚ùå Preencha n√∫mero e mensagem</div>';

        console.error(err);        return;

        resultado.innerHTML = `<div class="alert alert-danger">‚ùå Erro: ${err.message}</div>`;    }

    });

}    fetch('{% url "whatsapp:send_test" %}', {

        method: 'POST',

function restartInstance() {        headers: {

    if (!confirm('üîÅ Reiniciar inst√¢ncia?')) return;            'X-CSRFToken': '{{ csrf_token }}',

    showQr();            'Content-Type': 'application/json'

}        },

        body: JSON.stringify({ to, message })

function disconnect() {    })

    if (!confirm('‚ö†Ô∏è Desconectar WhatsApp? Voc√™ n√£o receber√° mais confirma√ß√µes por este n√∫mero.')) return;    .then(r => r.json())

    .then(data => {

    fetch('{% if whatsapps and whatsapps.0 %}{% url "whatsapp:disconnect" whatsapps.0.id %}{% else %}#{% endif %}', {        if (data.success) {

        method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' }            resultado.innerHTML = '<div class="alert alert-success">‚úÖ ' + data.message + '</div>';

    })        } else {

    .then(r => r.json())            resultado.innerHTML = '<div class="alert alert-danger">‚ùå ' + (data.error || 'Falha') + '</div>';

    .then(data => {        }

        if (data.success) {    })

            updateStatusAll();    .catch(err => {

            alert(data.message);        console.error(err);

        } else {        resultado.innerHTML = '<div class="alert alert-danger">‚ùå Erro ao enviar mensagem</div>';

            alert('Erro: ' + (data.error || 'unknown'));    });

        }}

    })</script>

    .catch(err => { console.error(err); alert('Erro ao desconectar') });{% endblock %}

}

function sendTestMessage() {
    const to = document.getElementById('to-number').value.trim();
    const message = document.getElementById('message').value.trim();
    const resultado = document.getElementById('resultado');
    resultado.innerHTML = '';

    if (!to || !message) {
        resultado.innerHTML = '<div class="alert alert-danger">‚ùå Preencha n√∫mero e mensagem</div>';
        return;
    }

    fetch('{% url "whatsapp:send_test" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ to, message })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            resultado.innerHTML = '<div class="alert alert-success">‚úÖ ' + data.message + '</div>';
        } else {
            resultado.innerHTML = '<div class="alert alert-danger">‚ùå ' + (data.error || 'Falha') + '</div>';
        }
    })
    .catch(err => {
        console.error(err);
        resultado.innerHTML = '<div class="alert alert-danger">‚ùå Erro ao enviar mensagem</div>';
    });
}
</script>
{% endblock %}
