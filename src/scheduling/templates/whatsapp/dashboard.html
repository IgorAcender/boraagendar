{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}WhatsApp Dashboard{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/whatsapp-dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4">üí¨ WhatsApp Manager</h1>
            <p class="text-muted">Gerencie suas conex√µes do WhatsApp</p>
        </div>
    </div>

    {% if whatsapp %}
    <div class="row g-4">
        <!-- Coluna 1: Status -->
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üìä Status</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                    <div class="col-sm-4"><strong>Telefone:</strong></div>
                        <div class="col-sm-8">{{ whatsapp.phone_number }}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong>Status:</strong></div>
                        <div class="col-sm-8">
                            <span id="statusBadge" class="badge" style="background-color: #999; padding: 8px 12px; font-size: 0.95rem;">
                                Carregando...
                            </span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong>Conectado em:</strong></div>
                        <div class="col-sm-8">
                            <small id="connectedTime" class="text-muted">---</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-4"><strong>Inst√¢ncia:</strong></div>
                        <div class="col-sm-8">{{ whatsapp.instance_name }}</div>
                    </div>
                </div>
            </div>

            <!-- Log de A√ß√µes -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üìã Log de A√ß√µes</h5>
                </div>
                <div class="card-body" style="height: 250px; overflow-y: auto; background-color: #f8f9fa;">
                    <div id="actionLog">
                        <p class="text-muted text-center">A√ß√µes aparecer√£o aqui...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coluna 2: QR Code e A√ß√µes -->
        <div class="col-lg-6">
            <!-- QR Code Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üì± Conex√£o QR Code</h5>
                </div>
                <div class="card-body text-center py-5">
                    <button class="btn btn-primary btn-lg" onclick="gerarQR()" style="width: 100%;">
                        üîÑ Gerar QR Code
                    </button>
                    <div id="loadingSpinner" style="display: none; margin-top: 20px;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2">Gerando QR Code...</p>
                    </div>
                </div>
            </div>

            <!-- A√ß√µes -->
            <div class="card shadow-sm">
                <div class="card-header bg-warning">
                    <h5 class="mb-0">‚öôÔ∏è A√ß√µes</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success btn-block mb-2" onclick="verificarStatus()" style="width: 100%;">
                        ‚úì Verificar Status
                    </button>
                    <button class="btn btn-danger" onclick="desconectar()" style="width: 100%;">
                        ‚úï Desconectar
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <div class="alert alert-warning" role="alert">
        <h4 class="alert-heading">‚ö†Ô∏è Nenhuma Inst√¢ncia</h4>
        <p>Voc√™ ainda n√£o tem nenhuma inst√¢ncia WhatsApp configurada.</p>
        <a href="{% url 'whatsapp:create' %}" class="btn btn-primary">‚ûï Adicionar WhatsApp</a>
    </div>
    {% endif %}
</div>

<!-- Modal QR Code -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üì± Escanear QR Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrImage" style="display: none; margin: 20px 0;">
                    <img id="qrImg" src="" alt="QR Code" style="max-width: 100%; height: auto; border: 2px solid #007bff; padding: 10px; border-radius: 8px;">
                </div>
                <div id="modalLoadingSpinner" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Gerando QR Code...</p>
                </div>
                <p id="qrStatus" class="mt-3 text-muted">Aguardando...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Sucesso -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">‚úÖ Sucesso!</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="successMessage">
                Opera√ß√£o realizada com sucesso!
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<script>
const WHATSAPP_ID = '{% if whatsapp %}{{ whatsapp.id }}{% endif %}';
const API_BASE = '/dashboard/whatsapp';
let qrModal = null;
let successModal = null;
let pollInterval = null;

document.addEventListener('DOMContentLoaded', function() {
    qrModal = new bootstrap.Modal(document.getElementById('qrModal'), { backdrop: 'static', keyboard: false });
    successModal = new bootstrap.Modal(document.getElementById('successModal'));
    
    if (WHATSAPP_ID) {
        updateStatus();
        setInterval(updateStatus, 3000);
    }
});

function addLog(message) {
    const log = document.getElementById('actionLog');
    const time = new Date().toLocaleTimeString('pt-BR');
    const item = document.createElement('div');
    item.className = 'log-item';
    item.textContent = '[' + time + '] ' + message;
    log.insertBefore(item, log.firstChild);
    
    while (log.children.length > 10) {
        log.removeChild(log.lastChild);
    }
}

function updateStatus() {
    if (!WHATSAPP_ID) return;
    
    fetch(API_BASE + '/' + WHATSAPP_ID + '/status/')
        .then(r => r.json())
        .then(data => {
            const badge = document.getElementById('statusBadge');
            const time = document.getElementById('connectedTime');
            
            if (data.is_connected) {
                badge.textContent = '‚úì Conectado';
                badge.style.backgroundColor = '#28a745';
            } else {
                badge.textContent = '‚úï Desconectado';
                badge.style.backgroundColor = '#dc3545';
            }
            
            time.textContent = data.connected_at ? new Date(data.connected_at).toLocaleString('pt-BR') : '---';
        })
        .catch(e => {
            console.error('Erro ao atualizar status:', e);
            addLog('Erro ao carregar status');
        });
}

function gerarQR() {
    if (!WHATSAPP_ID) {
        alert('Nenhuma inst√¢ncia configurada');
        return;
    }
    
    addLog('Gerando QR Code...');
    document.getElementById('modalLoadingSpinner').style.display = 'block';
    document.getElementById('qrImage').style.display = 'none';
    document.getElementById('qrStatus').textContent = 'Gerando QR Code...';
    
    qrModal.show();
    
    fetch(API_BASE + '/' + WHATSAPP_ID + '/gerar-qrcode/', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.qr_code) {
                document.getElementById('modalLoadingSpinner').style.display = 'none';
                document.getElementById('qrImg').src = data.qr_code;
                document.getElementById('qrImage').style.display = 'block';
                document.getElementById('qrStatus').textContent = 'Escaneie o QR Code com seu WhatsApp';
                
                addLog('QR Code gerado!');
                
                if (pollInterval) clearInterval(pollInterval);
                pollInterval = setInterval(function() {
                    fetch(API_BASE + '/' + WHATSAPP_ID + '/status/')
                        .then(r => r.json())
                        .then(data => {
                            if (data.is_connected) {
                                document.getElementById('qrStatus').innerHTML = '<strong style="color: green;">‚úÖ Conectado!</strong>';
                                addLog('WhatsApp conectado com sucesso!');
                                
                                setTimeout(function() {
                                    qrModal.hide();
                                    if (pollInterval) clearInterval(pollInterval);
                                    
                                    document.getElementById('successMessage').textContent = 'WhatsApp conectado com sucesso!';
                                    successModal.show();
                                    
                                    updateStatus();
                                }, 1500);
                            }
                        })
                        .catch(e => console.error('Erro ao verificar conex√£o:', e));
                }, 1000);
            } else {
                document.getElementById('modalLoadingSpinner').style.display = 'none';
                document.getElementById('qrStatus').textContent = 'Erro ao gerar QR Code';
                addLog('Erro ao gerar QR Code');
            }
        })
        .catch(e => {
            console.error('Erro:', e);
            document.getElementById('modalLoadingSpinner').style.display = 'none';
            document.getElementById('qrStatus').textContent = 'Erro ao gerar QR Code';
            addLog('Erro: ' + e.message);
        });
}

function desconectar() {
    if (!WHATSAPP_ID || !confirm('Desconectar WhatsApp?')) return;
    
    addLog('Desconectando...');
    
    fetch(API_BASE + '/' + WHATSAPP_ID + '/desconectar/', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            addLog('WhatsApp desconectado');
            updateStatus();
            
            document.getElementById('successMessage').textContent = 'WhatsApp desconectado com sucesso!';
            successModal.show();
        })
        .catch(e => {
            console.error('Erro:', e);
            addLog('Erro ao desconectar: ' + e.message);
        });
}

function verificarStatus() {
    addLog('Verificando status...');
    updateStatus();
    
    document.getElementById('successMessage').textContent = 'Status verificado!';
    successModal.show();
}
</script>
{% endblock %}
