{% extends "base_dashboard.html" %}
{% load static %}

{% block title %}Gerenciar WhatsApp - Bora Agendar{% endblock %}

{% block extra_css %}
<style>
    .whatsapp-container {
        max-width: 1100px;
        margin: 40px auto;
        padding: 30px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .header { margin-bottom: 18px }
    .header h1 { color: #111827; margin: 6px 0 }

    .loading { text-align:center; padding:30px }
    .loading::after { content:""; display:inline-block; width:40px; height:40px; border:4px solid #f3f3f3; border-top:4px solid #10b981; border-radius:50%; animation:spin 1s linear infinite }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    .grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:18px; align-items:start }
    .info-box { background:#f8fafc; border-radius:6px; padding:18px; border-left:6px solid #10b981 }

    .btn-connect { display:inline-flex; align-items:center; gap:8px; padding:10px 16px; border-radius:6px; border:none; font-weight:600; cursor:pointer }
    .btn-green{background:#10b981;color:white} .btn-teal{background:#0f766e;color:white} .btn-yellow{background:#f59e0b;color:white} .btn-red{background:#ef4444;color:white}

    .panel { background:#fff; border-radius:8px; padding:20px; box-shadow:0 1px 3px rgba(0,0,0,0.03); margin-bottom:18px }
    .form-control{width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:6px}
    .help-muted{color:#6b7280; font-size:0.95em}
    .qr-display img{max-width:320px; border-radius:8px}
    .alert{padding:12px 16px; border-radius:8px; margin-top:12px}
    .alert-success{background:#d1fae5; border:1px solid #34d399; color:#065f46}
    .alert-danger{background:#fee2e2; border:1px solid #f87171; color:#991b1b}
</style>
{% endblock %}

{% block content %}
<div class="whatsapp-container">
    <div class="header"><h1>Gerenciador WhatsApp Evolution API</h1></div>

    {% if whatsapps and whatsapps.0 %}
    <div data-whatsapp-id="{{ whatsapps.0.id }}"></div>
    {% endif %}

    <div class="panel">
        <h3 style="margin:0 0 8px">Status da Conex√£o</h3>
        <p style="margin:6px 0 14px; color:#6b7280"><span id="status-dot">üî¥</span> <strong id="status-text">Desconectado</strong></p>

        <div class="grid-3">
            <div class="info-box">
                <div style="font-size:0.9em; color:#6b7280">URL da API</div>
                <div style="margin-top:8px; word-break:break-all; font-weight:600">{{ EVOLUTION_API_URL }}</div>
            </div>

            <div class="info-box">
                <div style="font-size:0.9em; color:#6b7280">Inst√¢ncia</div>
                <div style="margin-top:8px; font-weight:600">{% if whatsapps and whatsapps.0.instance_name %}{{ whatsapps.0.instance_name }}{% else %}-{% endif %}</div>
            </div>

            <div class="info-box">
                <div style="font-size:0.9em; color:#6b7280">Estado</div>
                <div style="margin-top:8px; font-weight:600" id="instance-state">{% if whatsapps and whatsapps.0.connection_status %}{{ whatsapps.0.connection_status }}{% else %}disconnected{% endif %}</div>
            </div>
        </div>

        <div style="margin-top:14px; display:flex; gap:12px">
            <button class="btn-connect btn-green" onclick="updateStatusAll()">üîÑ Atualizar Status</button>
            <button class="btn-connect btn-teal" onclick="reconectar()">ÔøΩ Reconectar WhatsApp</button>
            <button class="btn-connect btn-yellow" onclick="showQr()">ÔøΩ Mostrar QR Code</button>
            <button class="btn-connect btn-red" onclick="disconnect()">‚õî Desconectar WhatsApp</button>
        </div>
    </div>

    <div class="panel">
        <h3 style="margin:0 0 8px">Enviar Mensagem de Teste</h3>
        <p class="help-muted">üí° Dica: Voc√™ pode enviar para n√∫meros individuais ou para grupos. Para grupos, copie o ID do grupo do WhatsApp (formato: 120363xxx@g.us)</p>

        <label style="display:block; margin-top:12px; font-weight:600">N√∫mero do WhatsApp ou ID do Grupo</label>
        <input id="to-number" class="form-control" placeholder="5511999999999  ou  120363xxx@g.us">
        <div style="margin-top:8px" class="help-muted">üì± Para n√∫mero: Use com ou sem + e c√≥digo do pa√≠s<br>üë• Para grupo: Cole o ID do grupo (termine com @g.us)</div>

        <label style="display:block; margin-top:14px; font-weight:600">Mensagem</label>
        <textarea id="message" class="form-control" rows="4">Ol√°! Esta √© uma mensagem de teste do sistema de rifas. üéâ</textarea>

        <div style="margin-top:12px">
            <button class="btn-connect btn-green" onclick="sendTestMessage()">üì© Enviar Mensagem</button>
        </div>

        <div id="resultado" style="margin-top:10px"></div>
    </div>
</div>

<script>
console.log('‚úÖ Script carregado');

function updateStatusAll() {
    const statusText = document.getElementById('status-text');
    const statusDot = document.getElementById('status-dot');

    fetch('{% url "whatsapp:list_api" %}')
        .then(r => r.json())
        .then(data => {
            const whats = data.whatsapps || [];
            if (whats.length === 0) {
                statusText.textContent = 'Desconectado';
                statusDot.textContent = 'üî¥';
                document.getElementById('instance-state').textContent = 'disconnected';
                return;
            }

            const first = whats[0];
            document.getElementById('instance-state').textContent = first.status || 'disconnected';
            if (first.status === 'connected') {
                statusText.textContent = 'Conectado'; statusDot.textContent = 'üü¢';
            } else if (first.status === 'connecting') {
                statusText.textContent = 'Conectando'; statusDot.textContent = 'üü°';
            } else {
                statusText.textContent = 'Desconectado'; statusDot.textContent = 'üî¥';
            }
        })
        .catch(err => console.error(err));
}

function showQr() {
    const resultado = document.getElementById('resultado');
    resultado.innerHTML = '<div class="loading"></div>';

    fetch('{% url "whatsapp:create" %}', { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'} })
        .then(resp => resp.json())
        .then(data => {
            if (data.qr_code) {
                resultado.innerHTML = `\n                    <div class="qr-display">\n                        <h3>‚úÖ QR Code Gerado!</h3>\n                        <img src="${data.qr_code}" alt="QR Code WhatsApp">\n                        <p style="color: #6b7280;">${data.message || 'Escaneie o QR code com seu WhatsApp'}</p>\n                    </div>\n                `;
            } else {
                resultado.innerHTML = `<div class="alert alert-danger">‚ùå Erro: ${data.error || 'Sem QR code'}</div>`;
            }
        })
        .catch(err => {
            console.error(err);
            resultado.innerHTML = `<div class="alert alert-danger">‚ùå Erro ao gerar QR: ${err.message}</div>`;
        });
}

function reconectar() {
    const resultado = document.getElementById('resultado');
    resultado.innerHTML = '<div class="loading"></div>';

    const whatsappId = document.querySelector('[data-whatsapp-id]')?.getAttribute('data-whatsapp-id');
    if (!whatsappId) {
        resultado.innerHTML = '<div class="alert alert-danger">‚ùå Nenhum WhatsApp para reconectar</div>';
        return;
    }

    fetch('{% url "whatsapp:reconnect" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ whatsapp_id: whatsappId })
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.qr_code) {
            resultado.innerHTML = `\n                    <div class="qr-display">\n                        <h3>‚úÖ Reconectando!</h3>\n                        <img src="${data.qr_code}" alt="QR Code WhatsApp">\n                        <p style="color: #6b7280;">${data.message}</p>\n                    </div>\n                `;
            updateStatusAll();
        } else {
            resultado.innerHTML = `<div class="alert alert-danger">‚ùå ${data.error || 'Erro ao reconectar'}</div>`;
        }
    })
    .catch(err => {
        console.error(err);
        resultado.innerHTML = `<div class="alert alert-danger">‚ùå Erro: ${err.message}</div>`;
    });
}

function restartInstance() {
    if (!confirm('üîÅ Reiniciar inst√¢ncia?')) return;
    showQr();
}

function disconnect() {
    if (!confirm('‚ö†Ô∏è Desconectar WhatsApp? Voc√™ n√£o receber√° mais confirma√ß√µes por este n√∫mero.')) return;

    fetch('{% if whatsapps and whatsapps.0 %}{% url "whatsapp:disconnect" whatsapps.0.id %}{% else %}#{% endif %}', {
        method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            updateStatusAll();
            alert(data.message);
        } else {
            alert('Erro: ' + (data.error || 'unknown'));
        }
    })
    .catch(err => { console.error(err); alert('Erro ao desconectar') });
}

function sendTestMessage() {
    const to = document.getElementById('to-number').value.trim();
    const message = document.getElementById('message').value.trim();
    const resultado = document.getElementById('resultado');
    resultado.innerHTML = '';

    if (!to || !message) {
        resultado.innerHTML = '<div class="alert alert-danger">‚ùå Preencha n√∫mero e mensagem</div>';
        return;
    }

    fetch('{% url "whatsapp:send_test" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ to, message })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            resultado.innerHTML = '<div class="alert alert-success">‚úÖ ' + data.message + '</div>';
        } else {
            resultado.innerHTML = '<div class="alert alert-danger">‚ùå ' + (data.error || 'Falha') + '</div>';
        }
    })
    .catch(err => {
        console.error(err);
        resultado.innerHTML = '<div class="alert alert-danger">‚ùå Erro ao enviar mensagem</div>';
    });
}
</script>
{% endblock %}
