{% extends "base_dashboard.html" %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/whatsapp-dashboard.css' %}">
{% endblock %}

{% block content %}
<div style="padding: 20px;">
  <h1>WhatsApp Dashboard</h1>
  
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
    <div>
      <h2>Status</h2>
      {% if whatsapps %}
        {% with wa=whatsapps.0 %}
        <p>Instância: {{ wa.instance_name }}</p>
        <p>Status: {{ wa.connection_status }}</p>
        {% endwith %}
      {% else %}
        <p>Nenhuma instância</p>
      {% endif %}
    </div>
    
    <div>
      <h2>Conectar</h2>
      <button onclick="reconectarWhatsApp()">Novo QR</button>
    </div>
  </div>
  
  <div id="qrModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;">
    <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
      <button onclick="fecharModal()" style="float: right;">X</button>
      <div id="modalQRContent"></div>
    </div>
  </div>
</div>

<script>
let whatsappId = {% if whatsapps %}'{{ whatsapps.0.id }}'{% else %}null{% endif %};
let monitorarConexao = false;
let connectedAtInicial = null;

function abrirModal() {
  document.getElementById('qrModal').style.display = 'flex';
}

function fecharModal() {
  document.getElementById('qrModal').style.display = 'none';
  monitorarConexao = false;
}

function verificarConexao() {
  if (!monitorarConexao || !whatsappId) return;
  
  fetch('/dashboard/whatsapp/' + whatsappId + '/status/')
    .then(r => r.json())
    .then(data => {
      const mudouConnectedAt = connectedAtInicial !== null && data.connected_at !== connectedAtInicial;
      
      if (mudouConnectedAt) {
        console.log('✅ Conectado!');
        monitorarConexao = false;
        document.getElementById('modalQRContent').innerHTML = '<h2>✅ Conectado!</h2>';
        setTimeout(() => { fecharModal(); location.reload(); }, 2000);
      } else {
        connectedAtInicial = data.connected_at;
        setTimeout(verificarConexao, 1000);
      }
    })
    .catch(e => {
      if (monitorarConexao) setTimeout(verificarConexao, 2000);
    });
}

function reconectarWhatsApp() {
  abrirModal();
  monitorarConexao = true;
  connectedAtInicial = null;
  
  fetch('{% url "whatsapp:create" %}', {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({})
  })
  .then(r => r.json())
  .then(data => {
    if (data.success && data.qr_code) {
      document.getElementById('modalQRContent').innerHTML = '<img src="' + data.qr_code + '" style="max-width: 250px;">';
      setTimeout(verificarConexao, 1000);
    } else {
      document.getElementById('modalQRContent').innerHTML = '<p>Erro ao gerar QR</p>';
      monitorarConexao = false;
    }
  })
  .catch(e => { 
    console.error(e);
    monitorarConexao = false; 
  });
}
</script>
{% endblock %}
