{% extends "base_dashboard.html" %}{% extends "base_dashboard.html" %}

{% load static %}{% load static %}



{% block title %}Gerenciar WhatsApp - Bora Agendar{% endblock %}{% block title %}Gerenciar WhatsApp - Bora Agendar{% endblock %}



{% block extra_css %}{% block extra_css %}

<style><style>

    * {    .whatsapp-container {

        margin: 0;        max-width: 800px;

        padding: 0;        margin: 40px auto;

        box-sizing: border-box;        padding: 30px;

    }        background: white;

            border-radius: 12px;

    .container-full {        box-shadow: 0 2px 8px rgba(0,0,0,0.1);

        max-width: 1200px;    }

        margin: 0 auto;    

        padding: 40px 20px;    .header {

    }        text-align: center;

            margin-bottom: 40px;

    .page-header {    }

        background: white;    

        padding: 30px;    .header h1 {

        border-radius: 12px;        color: #1f2937;

        box-shadow: 0 2px 8px rgba(0,0,0,0.1);        margin-bottom: 10px;

        margin-bottom: 30px;    }

    }    

        .header p {

    .page-header h1 {        color: #6b7280;

        font-size: 32px;    }

        color: #1f2937;    

        margin: 0;    .btn-connect {

    }        background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);

            color: white;

    .status-section {        padding: 16px 32px;

        background: white;        border-radius: 8px;

        padding: 30px;        border: none;

        border-radius: 12px;        font-weight: 600;

        box-shadow: 0 2px 8px rgba(0,0,0,0.1);        font-size: 18px;

        margin-bottom: 30px;        cursor: pointer;

    }        transition: all 0.3s ease;

            display: inline-flex;

    .status-header {        align-items: center;

        display: flex;        gap: 10px;

        align-items: center;    }

        gap: 15px;    

        margin-bottom: 25px;    .btn-connect:hover {

        padding-bottom: 20px;        transform: translateY(-2px);

        border-bottom: 2px solid #e5e7eb;        box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);

    }    }

        

    .status-header h2 {    .loading {

        font-size: 24px;        text-align: center;

        color: #1f2937;        padding: 40px;

        margin: 0;    }

    }    

        .loading::after {

    .status-badge {        content: "";

        display: inline-flex;        display: inline-block;

        align-items: center;        width: 50px;

        gap: 8px;        height: 50px;

        padding: 8px 16px;        border: 5px solid #f3f3f3;

        border-radius: 20px;        border-top: 5px solid #25d366;

        font-weight: 600;        border-radius: 50%;

        font-size: 14px;        animation: spin 1s linear infinite;

    }    }

        

    .status-badge.connected {    @keyframes spin {

        background: #d1fae5;        0% { transform: rotate(0deg); }

        color: #065f46;        100% { transform: rotate(360deg); }

    }    }

        

    .status-badge.disconnected {    .qr-display {

        background: #fee2e2;        text-align: center;

        color: #991b1b;        padding: 30px;

    }    }

        

    .status-badge.connecting {    .qr-display img {

        background: #fef3c7;        max-width: 300px;

        color: #92400e;        border-radius: 8px;

    }        box-shadow: 0 4px 12px rgba(0,0,0,0.15);

            margin-bottom: 20px;

    .info-grid {    }

        display: grid;    

        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));    .alert {

        gap: 20px;        padding: 15px 20px;

        margin-bottom: 25px;        border-radius: 8px;

    }        margin: 20px 0;

        }

    .info-item {    

        background: #f9fafb;    .alert-success {

        padding: 15px 20px;        background-color: #d1fae5;

        border-radius: 8px;        border: 1px solid #34d399;

        border-left: 4px solid #25d366;        color: #065f46;

    }    }

        

    .info-item label {    .alert-danger {

        display: block;        background-color: #fee2e2;

        font-size: 12px;        border: 1px solid #f87171;

        font-weight: 600;        color: #991b1b;

        color: #6b7280;    }

        text-transform: uppercase;    

        letter-spacing: 0.5px;    .status-card {

        margin-bottom: 5px;        background: #f9fafb;

    }        border: 2px solid #e5e7eb;

            border-radius: 8px;

    .info-item .value {        padding: 20px;

        font-size: 16px;        margin: 20px 0;

        color: #1f2937;    }

        font-weight: 500;    

        word-break: break-all;    .status-connected {

    }        border-color: #34d399;

            background: #d1fae5;

    .actions-grid {    }

        display: grid;</style>

        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));{% endblock %}

        gap: 15px;

    }{% block content %}

    <div class="whatsapp-container">

    .btn {    <div class="header">

        padding: 12px 24px;        <h1>üì± Gerenciar WhatsApp</h1>

        border-radius: 8px;        <p>Conecte seu WhatsApp para enviar confirma√ß√µes de agendamento</p>

        border: none;    </div>

        font-weight: 600;    

        font-size: 14px;    {% if whatsapps %}

        cursor: pointer;        {% for wa in whatsapps %}

        transition: all 0.3s ease;        <div class="status-card {% if wa.connection_status == 'connected' %}status-connected{% endif %}">

        display: flex;            <h3>WhatsApp {{ wa.display_name }}</h3>

        align-items: center;            <p>

        justify-content: center;                <strong>Status:</strong> 

        gap: 8px;                {% if wa.connection_status == 'connected' %}

    }                    ‚úÖ Conectado

                    {% elif wa.connection_status == 'connecting' %}

    .btn:hover {                    üîÑ Conectando...

        transform: translateY(-2px);                {% else %}

        box-shadow: 0 4px 12px rgba(0,0,0,0.15);                    ‚ö†Ô∏è Desconectado

    }                {% endif %}

                </p>

    .btn-success {            {% if wa.phone_number and wa.phone_number != 'pending' %}

        background: #10b981;            <p><strong>N√∫mero:</strong> {{ wa.phone_number }}</p>

        color: white;            {% endif %}

    }            

                {% if wa.connection_status != 'connected' %}

    .btn-primary {            <button class="btn-connect" onclick="conectarWhatsApp()">

        background: #3b82f6;                üîÑ Reconectar WhatsApp

        color: white;            </button>

    }            {% endif %}

            </div>

    .btn-warning {        {% endfor %}

        background: #f59e0b;    {% else %}

        color: white;        <div class="text-center">

    }            <p style="color: #6b7280; margin-bottom: 30px;">

                    Nenhum WhatsApp conectado ainda.

    .btn-danger {            </p>

        background: #ef4444;            <button class="btn-connect" onclick="conectarWhatsApp()">

        color: white;                ‚ûï Conectar WhatsApp

    }            </button>

            </div>

    .test-section {    {% endif %}

        background: white;    

        padding: 30px;    <div id="resultado" style="margin-top: 30px;"></div>

        border-radius: 12px;</div>

        box-shadow: 0 2px 8px rgba(0,0,0,0.1);

    }<script>

    console.log('‚úÖ Script carregado');

    .test-section h3 {

        font-size: 20px;let checkStatusInterval = null;

        color: #1f2937;

        margin-bottom: 10px;function conectarWhatsApp() {

    }    console.log('üöÄ Iniciando conex√£o WhatsApp...');

        

    .hint {    const resultado = document.getElementById('resultado');

        color: #6b7280;    resultado.innerHTML = '<div class="loading"></div>';

        font-size: 14px;    

        margin-bottom: 20px;    const url = '{% url "whatsapp:create" %}';

        display: flex;    console.log('üì° URL:', url);

        align-items: start;    

        gap: 8px;    fetch(url, {

    }        method: 'POST',

            headers: {

    .form-group {            'X-CSRFToken': '{{ csrf_token }}',

        margin-bottom: 20px;            'Content-Type': 'application/json'

    }        },

            body: JSON.stringify({})

    .form-group label {    })

        display: block;    .then(response => {

        font-weight: 600;        console.log('üìä Status:', response.status);

        color: #374151;        console.log('üìä Content-Type:', response.headers.get('content-type'));

        margin-bottom: 8px;        

    }        if (!response.ok) {

                return response.text().then(text => {

    .form-control {                throw new Error(`HTTP ${response.status}: ${text.substring(0, 200)}`);

        width: 100%;            });

        padding: 12px 16px;        }

        border: 2px solid #e5e7eb;        

        border-radius: 8px;        return response.json();

        font-size: 14px;    })

        transition: border-color 0.3s;    .then(data => {

    }        console.log('‚úÖ Resposta:', data);

            

    .form-control:focus {        if (data.success && data.qr_code) {

        outline: none;            resultado.innerHTML = `

        border-color: #3b82f6;                <div class="qr-display">

    }                    <h3>üì± Aguardando Conex√£o...</h3>

                        <img src="${data.qr_code}" alt="QR Code WhatsApp" id="qrCodeImage">

    textarea.form-control {                    <p style="color: #6b7280; margin-top: 15px;">

        resize: vertical;                        ${data.message || 'Escaneie o QR code com seu WhatsApp'}

        min-height: 100px;                    </p>

        font-family: inherit;                    <p style="font-size: 0.9em; color: #9ca3af; margin-top: 10px;">

    }                        ‚è±Ô∏è Verificando conex√£o...

                        </p>

    .note {                    ${data.instance_name ? `<p style="font-size: 0.85em; color: #d1d5db;">Inst√¢ncia: ${data.instance_name}</p>` : ''}

        font-size: 12px;                </div>

        color: #6b7280;            `;

        margin-top: 5px;            

    }            // Iniciar polling para verificar status

                if (data.whatsapp_id) {

    .loading {                iniciarVerificacaoStatus(data.whatsapp_id);

        text-align: center;            }

        padding: 40px;        } else {

    }            resultado.innerHTML = `

                    <div class="alert alert-danger">

    .loading::after {                    ‚ùå Erro: ${data.error || 'Resposta sem QR code'}

        content: "";                    <pre style="margin-top: 10px; font-size: 0.85em;">${JSON.stringify(data, null, 2)}</pre>

        display: inline-block;                </div>

        width: 50px;            `;

        height: 50px;        }

        border: 5px solid #f3f3f3;    })

        border-top: 5px solid #25d366;    .catch(error => {

        border-radius: 50%;        console.error('‚ùå Erro:', error);

        animation: spin 1s linear infinite;        resultado.innerHTML = `

    }            <div class="alert alert-danger">

                    ‚ùå Erro ao conectar: ${error.message}

    @keyframes spin {            </div>

        0% { transform: rotate(0deg); }        `;

        100% { transform: rotate(360deg); }    });

    }}

    

    .alert {function iniciarVerificacaoStatus(whatsappId) {

        padding: 15px 20px;    console.log('üîÑ Iniciando verifica√ß√£o de status...');

        border-radius: 8px;    

        margin: 20px 0;    // Limpar intervalo anterior se existir

    }    if (checkStatusInterval) {

            clearInterval(checkStatusInterval);

    .alert-success {    }

        background: #d1fae5;    

        border: 2px solid #34d399;    let tentativas = 0;

        color: #065f46;    const maxTentativas = 60; // 5 minutos (5 segundos x 60)

    }    

        checkStatusInterval = setInterval(() => {

    .alert-danger {        tentativas++;

        background: #fee2e2;        console.log(`üîç Verificando status (tentativa ${tentativas}/${maxTentativas})...`);

        border: 2px solid #f87171;        

        color: #991b1b;        // Verificar se WhatsApp conectou (simplificado - recarrega p√°gina)

    }        // Em produ√ß√£o, voc√™ faria uma requisi√ß√£o AJAX para verificar o status

            fetch(window.location.href, {

    .qr-modal {            method: 'GET',

        position: fixed;            headers: {

        top: 0;                'X-Requested-With': 'XMLHttpRequest'

        left: 0;            }

        width: 100%;        })

        height: 100%;        .then(response => response.text())

        background: rgba(0,0,0,0.5);        .then(html => {

        display: none;            // Se a p√°gina mostra "Conectado", recarregar

        align-items: center;            if (html.includes('‚úÖ Conectado') || html.includes('status-connected')) {

        justify-content: center;                console.log('‚úÖ WhatsApp conectado! Recarregando...');

        z-index: 9999;                clearInterval(checkStatusInterval);

    }                

                    // Mostrar mensagem de sucesso antes de recarregar

    .qr-modal.show {                const resultado = document.getElementById('resultado');

        display: flex;                resultado.innerHTML = `

    }                    <div class="alert alert-success">

                            <h3>‚úÖ WhatsApp Conectado com Sucesso!</h3>

    .qr-modal-content {                        <p>Recarregando p√°gina...</p>

        background: white;                    </div>

        padding: 40px;                `;

        border-radius: 12px;                

        max-width: 500px;                setTimeout(() => {

        text-align: center;                    window.location.reload();

        box-shadow: 0 8px 32px rgba(0,0,0,0.3);                }, 2000);

        position: relative;            }

    }        })

            .catch(err => console.error('Erro ao verificar status:', err));

    .qr-modal-content img {        

        max-width: 300px;        // Parar ap√≥s max tentativas

        border-radius: 8px;        if (tentativas >= maxTentativas) {

        box-shadow: 0 4px 12px rgba(0,0,0,0.15);            console.log('‚è∞ Timeout: QR code expirou');

        margin: 20px 0;            clearInterval(checkStatusInterval);

    }            

                const resultado = document.getElementById('resultado');

    .close-modal {            resultado.innerHTML = `

        position: absolute;                <div class="alert alert-danger">

        top: 20px;                    ‚è∞ QR Code expirou (5 minutos)

        right: 20px;                    <button class="btn-connect" onclick="conectarWhatsApp()" style="margin-top: 15px;">

        background: white;                        üîÑ Gerar Novo QR Code

        border: none;                    </button>

        font-size: 24px;                </div>

        cursor: pointer;            `;

        width: 40px;        }

        height: 40px;    }, 5000); // Verifica a cada 5 segundos

        border-radius: 50%;}

        display: flex;

        align-items: center;// Limpar intervalo ao sair da p√°gina

        justify-content: center;window.addEventListener('beforeunload', () => {

        box-shadow: 0 2px 8px rgba(0,0,0,0.2);    if (checkStatusInterval) {

    }        clearInterval(checkStatusInterval);

</style>    }

{% endblock %}});

</script>

{% block content %}{% endblock %}

<div class="container-full">
    <div class="page-header">
        <h1>Gerenciador WhatsApp Evolution API</h1>
    </div>
    
    <div class="status-section">
        <div class="status-header">
            <h2>Status da Conex√£o</h2>
            {% if whatsapps %}
                {% for wa in whatsapps %}
                    {% if wa.connection_status == 'connected' %}
                        <span class="status-badge connected">
                            ‚úì Conectado
                        </span>
                    {% elif wa.connection_status == 'connecting' %}
                        <span class="status-badge connecting">
                            ‚è± Conectando
                        </span>
                    {% else %}
                        <span class="status-badge disconnected">
                            ‚úó Desconectado
                        </span>
                    {% endif %}
                {% endfor %}
            {% else %}
                <span class="status-badge disconnected">
                    ‚úó Desconectado
                </span>
            {% endif %}
        </div>
        
        <div class="info-grid">
            <div class="info-item">
                <label>URL da API</label>
                <div class="value">{{ EVOLUTION_API_URL|default:"N√£o configurada" }}</div>
            </div>
            
            <div class="info-item">
                <label>Inst√¢ncia</label>
                <div class="value">
                    {% if whatsapps %}
                        {% for wa in whatsapps %}
                            {{ wa.instance_name }}
                        {% endfor %}
                    {% else %}
                        Nenhuma inst√¢ncia
                    {% endif %}
                </div>
            </div>
            
            <div class="info-item">
                <label>Estado</label>
                <div class="value">
                    {% if whatsapps %}
                        {% for wa in whatsapps %}
                            {{ wa.get_connection_status_display }}
                        {% endfor %}
                    {% else %}
                        disconnected
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="actions-grid">
            <button class="btn btn-success" onclick="atualizarStatus()">
                üîÑ Atualizar Status
            </button>
            <button class="btn btn-primary" onclick="mostrarQRCode()">
                üì± Mostrar QR Code
            </button>
            <button class="btn btn-warning" onclick="reiniciarInstancia()">
                üîÑ Reiniciar Inst√¢ncia
            </button>
            <button class="btn btn-danger" onclick="desconectar()">
                ‚ùå Desconectar WhatsApp
            </button>
        </div>
    </div>
    
    {% if whatsapps %}
        {% for wa in whatsapps %}
            {% if wa.connection_status == 'connected' %}
            <div class="test-section">
                <h3>Enviar Mensagem de Teste</h3>
                <div class="hint">
                    üí° <span>Voc√™ pode enviar para n√∫meros individuais ou para grupos. Para grupos, copie o ID do grupo do WhatsApp (formato: 120363xxx@g.us)</span>
                </div>
                
                <div class="form-group">
                    <label>N√∫mero do WhatsApp ou ID do Grupo</label>
                    <input type="text" class="form-control" id="phone" placeholder="5511999999999 ou 120363xxx@g.us">
                    <div class="note">
                        üì± <strong>Para n√∫mero:</strong> Use com ou sem + e c√≥digo do pa√≠s<br>
                        üë• <strong>Para grupo:</strong> Cole o ID do grupo (termine com @g.us)
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Mensagem</label>
                    <textarea class="form-control" id="message" placeholder="Digite sua mensagem aqui...">Ol√°! Esta √© uma mensagem de teste do Bora Agendar. üéâ</textarea>
                </div>
                
                <button class="btn btn-success" onclick="enviarMensagem()">
                    üì§ Enviar Mensagem
                </button>
                
                <div id="test-result"></div>
            </div>
            {% endif %}
        {% endfor %}
    {% endif %}
</div>

<!-- Modal QR Code -->
<div class="qr-modal" id="qrModal">
    <div class="qr-modal-content">
        <button class="close-modal" onclick="fecharModal()">√ó</button>
        <h3 id="qrTitle">Carregando...</h3>
        <div id="qrContent"></div>
    </div>
</div>

<script>
console.log('‚úÖ Script carregado');

function atualizarStatus() {
    location.reload();
}

function mostrarQRCode() {
    const modal = document.getElementById('qrModal');
    const title = document.getElementById('qrTitle');
    const content = document.getElementById('qrContent');
    
    title.textContent = 'Aguardando...';
    content.innerHTML = '<div class="loading"></div>';
    modal.classList.add('show');
    
    fetch('{% url "whatsapp:create" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.qr_code) {
            title.textContent = 'üì± Escaneie o QR Code';
            content.innerHTML = `
                <img src="${data.qr_code}" alt="QR Code">
                <p style="color: #6b7280; margin-top: 15px;">
                    ${data.message || 'Aponte a c√¢mera do seu WhatsApp para conectar'}
                </p>
            `;
            
            // Verificar conex√£o a cada 5 segundos
            const checkInterval = setInterval(() => {
                fetch(window.location.href)
                    .then(r => r.text())
                    .then(html => {
                        if (html.includes('Conectado')) {
                            clearInterval(checkInterval);
                            content.innerHTML = '<div class="alert alert-success">‚úÖ Conectado com sucesso! Recarregando...</div>';
                            setTimeout(() => location.reload(), 2000);
                        }
                    });
            }, 5000);
        } else {
            title.textContent = 'Erro';
            content.innerHTML = `<div class="alert alert-danger">‚ùå ${data.error || 'Erro ao gerar QR code'}</div>`;
        }
    })
    .catch(error => {
        title.textContent = 'Erro';
        content.innerHTML = `<div class="alert alert-danger">‚ùå ${error.message}</div>`;
    });
}

function fecharModal() {
    document.getElementById('qrModal').classList.remove('show');
}

function reiniciarInstancia() {
    if (confirm('Deseja realmente reiniciar a inst√¢ncia?')) {
        alert('Funcionalidade em desenvolvimento');
    }
}

function desconectar() {
    if (confirm('Deseja realmente desconectar o WhatsApp?')) {
        alert('Funcionalidade em desenvolvimento');
    }
}

function enviarMensagem() {
    const phone = document.getElementById('phone').value.trim();
    const message = document.getElementById('message').value.trim();
    const result = document.getElementById('test-result');
    
    if (!phone || !message) {
        result.innerHTML = '<div class="alert alert-danger">‚ùå Preencha todos os campos</div>';
        return;
    }
    
    result.innerHTML = '<div class="loading" style="padding: 20px;"></div>';
    
    // Aqui voc√™ implementaria o endpoint de envio de mensagem
    setTimeout(() => {
        result.innerHTML = '<div class="alert alert-success">‚úÖ Mensagem enviada com sucesso!</div>';
    }, 2000);
}

// Fechar modal ao clicar fora
document.addEventListener('click', function(event) {
    const modal = document.getElementById('qrModal');
    if (event.target === modal) {
        fecharModal();
    }
});
</script>
{% endblock %}
