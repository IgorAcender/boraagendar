{% extends "base_dashboard.html" %}
{% load static %}

{% block title %}Gerenciador WhatsApp - Bora Agendar{% endblock %}

{% block extra_head %}
<style>
    /* RESET FORCADO */
    .content-wrapper .whatsapp-container,
    .content-wrapper .whatsapp-container * {
        all: revert !important;
    }

    /* Grid 2 Colunas */
    .content-wrapper .whatsapp-container {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 2rem !important;
        padding: 0 !important;
        margin: 0 !important;
        width: 100% !important;
        max-width: none !important;
    }

    .left-column {
        display: flex !important;
        flex-direction: column !important;
        gap: 1.5rem !important;
    }

    .right-column {
        display: flex !important;
        flex-direction: column !important;
        gap: 1.5rem !important;
    }

    /* Aplicar tamb√©m com seletor mais espec√≠fico */
    .content-wrapper .left-column {
        display: flex !important;
        flex-direction: column !important;
        gap: 1.5rem !important;
    }

    .content-wrapper .right-column {
        display: flex !important;
        flex-direction: column !important;
        gap: 1.5rem !important;
    }

    /* Hero Header */
    .hero-header {
        grid-column: 1 / -1 !important;
        background: linear-gradient(135deg, #25d366 0%, #128c7e 100%) !important;
        color: white !important;
        border-radius: 20px !important;
        padding: 2rem !important;
        margin-bottom: 1rem !important;
        box-shadow: 0 10px 40px rgba(37, 211, 102, 0.3) !important;
    }

    .hero-header h1 {
        margin: 0 0 0.5rem 0 !important;
        font-size: 2rem !important;
        font-weight: 700 !important;
    }

    .hero-header p {
        opacity: 0.9 !important;
        margin: 0 !important;
        font-size: 1rem !important;
    }

    /* Status Card */
    .status-card {
        background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
        border-left: 5px solid #25d366;
        border-radius: 14px;
        padding: 1.5rem;
        box-shadow: 0 4px 16px rgba(37, 211, 102, 0.12);
    }

    .status-card h3 {
        margin: 0 0 1rem 0;
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 16px;
        font-weight: 600;
        padding: 0.75rem 1.25rem;
        border-radius: 10px;
        margin-bottom: 1rem;
    }

    .status-badge.connected {
        color: #065f46;
        background: #d1fae5;
    }

    .status-badge.disconnected {
        color: #991b1b;
        background: #fee2e2;
    }

    .status-info {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        font-size: 14px;
        line-height: 1.6;
    }

    .status-info p {
        margin: 0.5rem 0;
        color: #1e293b;
    }

    .status-info strong {
        color: #25d366;
    }

    /* Timeline */
    .timeline {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .timeline-title {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        color: #64748b;
        margin-bottom: 0.75rem;
    }

    .timeline-item {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 0.65rem;
        color: #475569;
        font-size: 13px;
    }

    .timeline-item::before {
        content: "‚úì";
        flex-shrink: 0;
        color: #25d366;
        font-weight: bold;
    }

    /* Form Section */
    .test-section {
        background: white;
        border-radius: 14px;
        padding: 1.5rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    .test-section h2 {
        margin: 0 0 0.5rem 0;
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        font-size: 13px;
        font-weight: 500;
        color: #1e293b;
        margin-bottom: 0.5rem;
        display: block;
    }

    .form-input,
    .form-textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .form-input:focus,
    .form-textarea:focus {
        outline: none;
        border-color: #25d366;
        box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
    }

    .form-textarea {
        min-height: 85px;
        resize: vertical;
    }

    .btn-send {
        background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
    }

    .btn-send:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
    }

    /* QR Code Section */
    .qr-section {
        background: white;
        border-radius: 14px;
        padding: 1.5rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        text-align: center;
    }

    .qr-section h2 {
        margin: 0 0 0.5rem 0;
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
    }

    .qr-section > p {
        font-size: 13px;
        color: #64748b;
        margin-bottom: 1.5rem;
    }

    .qr-container {
        background: #f8fafc;
        border: 2px dashed #cbd5e1;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        min-height: 250px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .qr-container img {
        max-width: 200px;
        height: auto;
        border-radius: 8px;
    }

    .qr-expires {
        font-size: 12px;
        color: #f59e0b;
        font-weight: 500;
    }

    /* Actions Grid 2x2 */
    .actions-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .action-btn {
        padding: 1.25rem;
        border: none;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        color: white;
        transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .action-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .btn-refresh {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    }

    .btn-reconnect {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .btn-qrcode {
        background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
    }

    .btn-disconnect {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    /* Loading & Alerts */
    .loading::after {
        content: "";
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #25d366;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .alert {
        padding: 15px 20px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .alert-success {
        background-color: #d1fae5;
        border: 1px solid #34d399;
        color: #065f46;
    }

    .alert-danger {
        background-color: #fee2e2;
        border: 1px solid #f87171;
        color: #991b1b;
    }

    /* Modal */
    .qr-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .qr-modal-overlay.active {
        display: flex;
    }

    .qr-modal-content {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        position: relative;
    }

    .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
    }

    .modal-qr-title {
        margin: 0 0 0.5rem 0;
        font-size: 20px;
        font-weight: 600;
        color: #1e293b;
        text-align: center;
    }

    .modal-qr-image {
        display: flex;
        justify-content: center;
        padding: 1rem 0;
    }

    .modal-qr-image img {
        max-width: 250px;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .whatsapp-container {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

<!-- CSS Externo que sobrescreve TUDO -->
<link rel="stylesheet" href="{% static 'css/whatsapp-dashboard.css' %}">

{% block content %}

<!-- Hero Header -->
<div class="hero-header">
    <h1>üì± Gerenciador WhatsApp</h1>
    <p>Integra√ß√£o Evolution API ‚Ä¢ Mensagens em Tempo Real</p>
</div>

<div class="whatsapp-container">
    <!-- COLUNA ESQUERDA -->
    <div class="left-column">
        <!-- Status Card -->
        <div class="status-card">
            <h3>üîå Conex√£o WhatsApp</h3>
            
            {% if whatsapps %}
                {% with wa=whatsapps.0 %}
                <div class="status-badge {% if wa.connection_status == 'connected' %}connected{% else %}disconnected{% endif %}">
                    {% if wa.connection_status == 'connected' %}
                        üü¢ ‚úì Conectado
                    {% else %}
                        üî¥ ‚úó Desconectado
                    {% endif %}
                </div>
                
                <div class="status-info">
                    <p><strong>Inst√¢ncia:</strong> {{ wa.instance_name|default:"rifas-whatsapp" }}</p>
                    <p><strong>Status:</strong> {{ wa.connection_status }}</p>
                    <p><strong>URL:</strong> {{ EVOLUTION_API_URL }}</p>
                </div>
                {% endwith %}
            {% else %}
                <div class="status-badge disconnected">
                    üî¥ ‚úó Desconectado
                </div>
                
                <div class="status-info">
                    <p><strong>Inst√¢ncia:</strong> Nenhuma configurada</p>
                    <p><strong>Status:</strong> disconnected</p>
                    <p><strong>URL:</strong> {{ EVOLUTION_API_URL }}</p>
                </div>
            {% endif %}

            <!-- Timeline -->
            <div class="timeline">
                <div class="timeline-title">√öltimas A√ß√µes</div>
                <div class="timeline-item">Reconectou h√° 5 minutos</div>
                <div class="timeline-item">Mensagem enviada h√° 10 minutos</div>
                <div class="timeline-item">QR Code lido h√° 1 hora</div>
            </div>
        </div>

        <!-- Form -->
        <div class="test-section">
            <h2>üí¨ Enviar Mensagem de Teste</h2>
            
            <div class="form-group">
                <label class="form-label">üì± N√∫mero do WhatsApp</label>
                <input type="text" id="recipient" class="form-input" placeholder="Ex: 5511987654321">
            </div>
            
            <div class="form-group">
                <label class="form-label">üí¨ Mensagem</label>
                <textarea id="message" class="form-textarea" placeholder="Digite a mensagem..."></textarea>
            </div>
            
            <button class="btn-send" onclick="enviarMensagemTeste()">üì§ Enviar Mensagem</button>
            <div id="resultado"></div>
        </div>
    </div>

    <!-- COLUNA DIREITA -->
    <div class="right-column">
        <!-- QR Code -->
        <div class="qr-section">
            <h2>üì≤ Conectar WhatsApp</h2>
            <p>Escaneie o QR Code com seu celular</p>
            
            <div class="qr-container">
                <div style="text-align: center; color: #64748b;">
                    <p style="margin: 0; font-size: 48px; margin-bottom: 10px;">üì±</p>
                    <p style="margin: 0; font-size: 13px;">Clique em "Novo QR Code"</p>
                </div>
            </div>
            
            <p class="qr-expires">‚è∞ C√≥digo expira em 2 minutos</p>
        </div>

        <!-- Bot√µes -->
        <div class="actions-grid">
            <button class="action-btn btn-refresh" onclick="atualizarStatus()">üîÑ Atualizar Status</button>
            <button class="action-btn btn-reconnect" onclick="reconectarWhatsApp()">‚ö° Reconectar</button>
            <button class="action-btn btn-qrcode" onclick="mostrarQRCode()">üì≤ Novo QR</button>
            <button class="action-btn btn-disconnect" onclick="desconectarWhatsApp()">‚õî Desconectar</button>
        </div>
    </div>
</div>

<script>
let whatsappId = {% if whatsapps %}'{{ whatsapps.0.id }}'{% else %}null{% endif %};
let monitorarConexao = false;

console.log('üì± P√°gina carregada. WhatsApp ID:', whatsappId);

function atualizarStatus() {
    const waId = whatsappId;
    console.log('üîÑ Atualizando status para ID:', waId);
    
    if (!waId) {
        console.warn('Nenhum WhatsApp configurado');
        return;
    }
    
    fetch(`/dashboard/whatsapp/${waId}/status/`, { 
        method: 'GET', 
        headers: { 'Content-Type': 'application/json' } 
    })
    .then(r => r.json())
    .then(data => {
        console.log('üìä Status recebido:', data);
    })
    .catch(e => console.error('‚ùå Erro ao atualizar status:', e));
}

function abrirModal() {
    console.log('üîì Abrindo modal...');
    document.getElementById('qrModal').classList.add('active');
}

function fecharModal() {
    console.log('üîí Fechando modal...');
    document.getElementById('qrModal').classList.remove('active');
    monitorarConexao = false; // Parar de monitorar quando fechar
}

function verificarConexao() {
    if (!monitorarConexao) {
        console.log('‚èπÔ∏è  Monitoramento parado');
        return;
    }
    
    // Obter o ID do primeiro WhatsApp
    const waId = whatsappId;
    if (!waId) {
        console.warn('Nenhum WhatsApp encontrado para verificar');
        monitorarConexao = false;
        return;
    }
    
    console.log(`‚è≥ Verificando conex√£o... (ID: ${waId})`);
    
    fetch(`/dashboard/whatsapp/${waId}/status/`, { 
        method: 'GET', 
        headers: { 'Content-Type': 'application/json' } 
    })
    .then(r => {
        console.log('üì° Resposta recebida:', r.status);
        return r.json();
    })
    .then(data => {
        console.log('üìä Dados de status:', data);
        
        // Verificar se a conex√£o foi estabelecida
        // O campo √© 'status' (n√£o 'connection_status') e pode ter valor 'connected'
        const isConnected = data.status === 'connected' || data.is_connected === true;
        
        console.log(`üìã status: "${data.status}", is_connected: ${data.is_connected}, isConnected calculado: ${isConnected}`);
        
        if (isConnected) {
            console.log('‚úÖ‚úÖ‚úÖ CONEX√ÉO ESTABELECIDA! FECHANDO MODAL...');
            monitorarConexao = false;
            
            // Mostrar mensagem de sucesso
            const modal = document.getElementById('qrModal');
            modal.classList.add('active');
            document.getElementById('modalQRContent').innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 60px; margin-bottom: 1rem;">‚úÖ</div>
                    <h3 style="color: #065f46; margin: 0;">Conectado com Sucesso!</h3>
                    <p style="color: #64748b; margin-top: 0.5rem;">WhatsApp conectado e pronto para usar.</p>
                </div>
            `;
            
            // Fechar automaticamente ap√≥s 2 segundos
            setTimeout(() => {
                console.log('üîÑ Recarregando p√°gina...');
                fecharModal();
                location.reload(); // Recarregar para atualizar status
            }, 2000);
        } else {
            // Continuar monitorando...
            console.log('‚è≥ Aguardando conex√£o... Status atual:', data.status);
            setTimeout(verificarConexao, 3000); // Verificar a cada 3 segundos
        }
    })
    .catch(e => {
        console.error('‚ùå Erro ao verificar conex√£o:', e);
        if (monitorarConexao) {
            console.log('üîÅ Tentando novamente em 5 segundos...');
            setTimeout(verificarConexao, 5000); // Tentar novamente em 5 segundos
        }
    });
}

function reconectarWhatsApp() {
    console.log('üöÄ Reconectando WhatsApp...');
    abrirModal();
    monitorarConexao = true; // Come√ßar a monitorar conex√£o
    
    fetch('{% url "whatsapp:create" %}', {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
        body: JSON.stringify({})
    })
    .then(r => r.json())
    .then(data => {
        console.log('üì≤ Resposta de criar inst√¢ncia:', data);
        if (data.success && data.qr_code) {
            document.getElementById('modalQRContent').innerHTML = `<div class="modal-qr-image"><img src="${data.qr_code}"></div>`;
            console.log('‚úÖ QR Code exibido. Escaneie com seu celular...');
            
            // Come√ßar a verificar conex√£o ap√≥s 2 segundos (tempo de leitura m√≠nimo)
            setTimeout(verificarConexao, 2000);
            
            // Timeout: parar de monitorar ap√≥s 2 minutos se n√£o conectar
            setTimeout(() => {
                if (monitorarConexao) {
                    console.warn('‚è±Ô∏è Timeout: QR Code expirou. Feche o modal e tente novamente.');
                    monitorarConexao = false;
                }
            }, 120000); // 2 minutos
        } else {
            console.error('‚ùå Erro ao obter QR Code:', data);
            document.getElementById('modalQRContent').innerHTML = `<div style="color: #991b1b;">‚ùå Erro ao gerar QR Code</div>`;
            monitorarConexao = false;
        }
    })
    .catch(e => {
        console.error('‚ùå Erro ao reconectar:', e);
        monitorarConexao = false;
    });
}

function mostrarQRCode() {
    reconectarWhatsApp();
}

function desconectarWhatsApp() {
    if (!whatsappId || !confirm('Deseja desconectar?')) return;
    fetch(`/dashboard/whatsapp/${whatsappId}/desconectar/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) location.reload();
    }).catch(e => console.error(e));
}

function enviarMensagemTeste() {
    const recipient = document.getElementById('recipient').value.trim();
    const message = document.getElementById('message').value.trim();
    if (!recipient || !message) { alert('Preencha todos os campos'); return; }
    
    fetch('/dashboard/whatsapp/send-test/', {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
        body: JSON.stringify({ recipient, message })
    })
    .then(r => r.json())
    .then(data => {
        const resultado = document.getElementById('resultado');
        resultado.innerHTML = data.success ? '<div class="alert alert-success">‚úÖ Enviado!</div>' : '<div class="alert alert-danger">‚ùå Erro!</div>';
    }).catch(e => console.error(e));
}
</script>

<!-- Modal -->
<div id="qrModal" class="qr-modal-overlay" onclick="this.id === 'qrModal' && fecharModal()">
    <div class="qr-modal-content" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="fecharModal()">√ó</button>
        <h2 class="modal-qr-title">üì± Conectar WhatsApp</h2>
        <div id="modalQRContent"></div>
    </div>
</div>

{% endblock %}
