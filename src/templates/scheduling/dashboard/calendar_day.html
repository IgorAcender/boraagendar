{% extends "base_dashboard.html" %}
{% load calendar_filters %}
{% block title %}Agenda do Dia{% endblock %}

{% block extra_head %}
<style>
    /* Page Container */
    .calendar-day-page {
        padding: 1rem;
        max-width: 100%;
        overflow-x: auto;
    }
        font-weight: 700;
        margin: 0;
    }

    .date-subtitle {
        font-size: 1rem;
        opacity: 0.9;
        margin-top: 0.25rem;
    }

    /* Live Clock */
    .live-clock {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 0.875rem 1.25rem;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .clock-time {
        font-size: 1.75rem;
        font-weight: 700;
        font-family: 'Courier New', monospace;
        margin-bottom: 0.25rem;
    }

    .clock-date {
        font-size: 0.875rem;
        opacity: 0.9;
    }

    /* New Booking Button */
    .btn-new-booking {
        background: rgba(255, 255, 255, 0.95);
        color: var(--brand-primary);
        padding: 0.875rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1rem;
        font-family: inherit;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        text-decoration: none;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .btn-new-booking:hover {
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .btn-new-booking i {
        font-size: 1rem;
    }

    /* Calendar Controls */
    .calendar-controls {
        background: white;
        border-radius: 16px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .nav-buttons {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .nav-btn {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: rgba(102, 126, 234, 0.1);
        border: none;
        color: var(--brand-primary);
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .nav-btn:hover {
        background: var(--brand-primary);
        color: white;
        transform: scale(1.1);
    }

    /* Date Picker */
    .date-picker-wrapper {
        position: relative;
        display: inline-block;
    }

    .date-picker-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
        z-index: 3;
    }

    .date-picker-input::-webkit-calendar-picker-indicator {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        cursor: pointer;
    }

    .date-picker-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: white;
        border: 2px solid var(--brand-primary);
        border-radius: 8px;
        color: var(--brand-primary);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
        pointer-events: none;
        position: relative;
        z-index: 1;
    }

    .date-picker-wrapper:hover .date-picker-label {
        background: rgba(102, 126, 234, 0.1);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .date-picker-label i {
        font-size: 1rem;
    }

    .view-toggle {
        display: flex;
        gap: 0.5rem;
    }

    .toggle-btn {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        background: white;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        font-size: 0.875rem;
    }

    .toggle-btn:hover {
        background: rgba(102, 126, 234, 0.1);
        color: var(--brand-primary);
        border-color: var(--brand-primary);
    }

    .toggle-btn.active {
        background: var(--brand-primary);
        color: white;
        border-color: var(--brand-primary);
    }

    /* Calendar Grid */
    .calendar-container {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        min-width: 800px;
    }

    .day-grid {
        display: grid;
        grid-template-columns: 60px repeat({{ professionals|length }}, minmax(150px, 1fr));
        position: relative;
    }

    /* Header Row */
    .header-cell {
        padding: 1rem;
        text-align: center;
        font-weight: 600;
        border-bottom: 2px solid #e5e7eb;
        background: #f9fafb;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .header-cell.time-header {
        border-right: 2px solid #e5e7eb;
    }

    .professional-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }

    .professional-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.875rem;
    }

    .professional-name {
        font-size: 0.875rem;
        color: #374151;
    }

    /* Time Column */
    .time-cell {
        padding: 0.5rem;
        text-align: center;
        font-size: 0.75rem;
        color: #6b7280;
        border-right: 2px solid #e5e7eb;
        border-bottom: 1px solid #f3f4f6;
        background: #f9fafb;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
    }

    /* Day Cells */
    .day-cell {
        border-bottom: 1px solid #f3f4f6;
        border-right: 1px solid #f3f4f6;
        height: 60px;
        position: relative;
        transition: background 0.2s;
    }

    .day-cell.available {
        background: #f0fdf4;
    }

    .day-cell.available:hover {
        background: #dcfce7;
    }

    .day-cell.unavailable {
        background: #f3f4f6;
    }

    .day-cell.break-time {
        background: #fffbeb;
    }

    /* Bookings */
    .booking {
        position: absolute;
        left: 2px;
        right: 2px;
        background: var(--brand-primary);
        color: white;
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        z-index: 10;
    }

    .booking:hover {
        transform: scale(1.01);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        z-index: 20;
    }

    .booking.status-confirmed {
        background: #10b981;
    }

    .booking.status-pending {
        background: #f59e0b;
    }

    .booking.status-cancelled {
        background: #ef4444;
        opacity: 0.6;
    }

    .booking-time {
        font-weight: 600;
        font-size: 0.7rem;
    }

    .booking-customer {
        font-size: 0.65rem;
        opacity: 0.9;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Current Time Indicator */
    #current-time-indicator {
        position: absolute;
        left: 0;
        right: 0;
        height: 2px;
        background: #ef4444;
        z-index: 1000;
        pointer-events: none;
        box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
    }

    /* Modal */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease-out;
    }

    .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
    }

    .modal-content {
        position: relative;
        background: white;
        border-radius: 8px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        animation: slideUp 0.3s ease-out;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        background: white;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #1e293b;
    }

    .modal-close {
        background: transparent;
        border: none;
        width: 28px;
        height: 28px;
        padding: 0;
        color: #94a3b8;
        font-size: 1.125rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        position: static;
        top: auto;
        right: auto;
        border-radius: 0;
    }

    .modal-close:hover {
        color: #1e293b;
    }

    .modal-body {
        padding: 1.5rem;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .hero-content {
            flex-direction: column;
            align-items: flex-start;
        }

        .calendar-controls {
            flex-direction: column;
            align-items: stretch;
        }

        .day-grid {
            grid-template-columns: 60px repeat({{ professionals|length }}, minmax(120px, 1fr));
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="calendar-day-page">
    <!-- Page Header -->
    <div class="page-header">
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <div>
                <h1 class="page-title">
                    <i class="fas fa-calendar-day"></i> Agenda do Dia
                </h1>
                <p class="page-subtitle">
                    {{ day_name }}, {{ selected_date|date:"d/m/Y" }}
                    {% if is_today %}<span style="margin-left: 0.5rem; background: #10b981; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem;">(Hoje)</span>{% endif %}
                </p>
            </div>

            <!-- Actions -->
            <div style="display: flex; align-items: center; gap: 1rem;">
                <!-- Live Clock -->
                <div class="live-clock">
                    <div class="clock-time" id="liveTime">--:--:--</div>
                    <div class="clock-date" id="liveDate">--/--/----</div>
                </div>

                <!-- New Booking Button -->
                <button onclick="openNewBookingModal()" class="btn-new-booking">
                    <i class="fas fa-plus"></i>
                    Novo Agendamento
                </button>
            </div>
        </div>
    </div>

    <!-- Calendar Controls -->
    <div class="calendar-controls">
        <div class="nav-buttons">
            <button class="nav-btn" onclick="navigateDay(-1)" title="Dia Anterior">
                <i class="fas fa-chevron-left"></i>
            </button>

            <div class="date-picker-wrapper">
                <input type="date"
                       id="datePicker"
                       value="{{ selected_date|date:'Y-m-d' }}"
                       onchange="navigateToDate(this.value)"
                       class="date-picker-input">
                <label for="datePicker" class="date-picker-label">
                    <i class="fas fa-calendar-alt"></i>
                    <span>{{ selected_date|date:"d/m/Y" }}</span>
                </label>
            </div>

            <button class="nav-btn" onclick="navigateDay(1)" title="PrÃ³ximo Dia">
                <i class="fas fa-chevron-right"></i>
            </button>

            <button class="nav-btn" onclick="navigateDay(0)" title="Hoje" style="margin-left: 0.5rem;">
                <i class="fas fa-calendar-day"></i>
            </button>
        </div>

        <div class="view-toggle">
            <a href="{% url 'dashboard:calendar' %}" class="toggle-btn">
                <i class="fas fa-calendar-week"></i> Semana
            </a>
            <a href="{% url 'dashboard:calendar_day' %}" class="toggle-btn active">
                <i class="fas fa-calendar-day"></i> Dia
            </a>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="calendar-container">
        <div class="day-grid">
            <!-- Header Row -->
            <div class="header-cell time-header">Hora</div>
            {% for professional in professionals %}
            <div class="header-cell">
                <div class="professional-header">
                    <div class="professional-avatar">
                        {{ professional.display_name|slice:":2"|upper }}
                    </div>
                    <div class="professional-name">{{ professional.display_name }}</div>
                </div>
            </div>
            {% endfor %}

            <!-- Time Rows -->
            {% for hour in hours %}
                <!-- Time Label -->
                <div class="time-cell">{{ hour }}</div>

                <!-- Cells for each professional -->
                {% for professional in professionals %}
                <div class="day-cell"
                     data-professional="{{ professional.id }}"
                     data-hour="{{ hour }}">

                    <!-- Bookings for this professional at this hour -->
                    {% for booking in bookings_by_professional_hour|get_item:professional.id|get_item:hour %}
                    <div class="booking status-{{ booking.status }}"
                         style="top: {{ booking.offset|stringformat:'f' }}%; height: {{ booking.height|stringformat:'f' }}%; min-height: 35px;"
                         onclick="openBookingModal({{ booking.id }})">
                        <div class="booking-time">{{ booking.time_display }}</div>
                        <div class="booking-customer">{{ booking.customer_name }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            {% endfor %}
        </div>
    </div>
</div>

<!-- Modal de Agendamento -->
<div id="bookingModal" class="modal">
    <div class="modal-overlay" onclick="closeBookingModal()"></div>
    <div class="modal-content">
        <button class="modal-close" onclick="closeBookingModal()">
            <i class="fas fa-times"></i>
        </button>
        <div id="modalBody">
            <p style="padding: 2rem; text-align: center; color: #6b7280;">Carregando...</p>
        </div>
    </div>
</div>

<!-- Availability Data -->
{{ availability_by_professional|json_script:"availability-data" }}

<script>
// Navigation
function navigateDay(offset) {
    const currentOffset = {{ day_offset }};
    const newOffset = offset === 0 ? 0 : currentOffset + offset;
    window.location.href = `?day_offset=${newOffset}`;
}

// Navigate to specific date
function navigateToDate(dateStr) {
    window.location.href = `?date=${dateStr}`;
}

// Modal functions
function openBookingModal(bookingId) {
    const modal = document.getElementById('bookingModal');
    const modalBody = document.getElementById('modalBody');

    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    modalBody.innerHTML = '<p style="padding: 2rem; text-align: center; color: #6b7280;">Carregando...</p>';

    fetch(`/dashboard/agendamentos/${bookingId}/`)
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const content = doc.querySelector('.booking-card, .booking-details, .card, main, .content') || doc.body;
            modalBody.innerHTML = content.innerHTML;

            // Reexecutar scripts marcados para o modal (ex.: updateBookingStatus)
            const modalScripts = doc.querySelectorAll('script[data-modal-script]');
            modalScripts.forEach(script => {
                const newScript = document.createElement('script');
                if (script.src) {
                    newScript.src = script.src;
                } else {
                    newScript.textContent = script.textContent;
                }
                modalBody.appendChild(newScript);
            });
        })
        .catch(error => {
            modalBody.innerHTML = '<p style="padding: 2rem; text-align: center; color: #ef4444;">Erro ao carregar agendamento.</p>';
            console.error('Error loading booking:', error);
        });
}

function closeBookingModal() {
    const modal = document.getElementById('bookingModal');
    modal.style.display = 'none';
    document.body.style.overflow = '';
}

// Update clock in real-time
function updateClock() {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');

    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = now.getFullYear();

    document.getElementById('liveTime').textContent = `${hours}:${minutes}:${seconds}`;
    document.getElementById('liveDate').textContent = `${day}/${month}/${year}`;
}

updateClock();
setInterval(updateClock, 1000);

// Add current time indicator
function updateTimeIndicator() {
    {% if is_today %}
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinutes = now.getMinutes();

    // Remove previous indicator
    const oldIndicator = document.getElementById('current-time-indicator');
    if (oldIndicator) {
        oldIndicator.remove();
    }

    const dayGrid = document.querySelector('.day-grid');
    if (dayGrid) {
        const indicator = document.createElement('div');
        indicator.id = 'current-time-indicator';

        // Calculate position: header row (1) + current time position
        // Each hour cell is 60px, plus header
        const headerHeight = 80; // Approximate header height
        const topPosition = headerHeight + (currentHour * 60) + (currentMinutes * 60 / 60);

        indicator.style.cssText = `
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: #ef4444;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
            top: ${topPosition}px;
        `;

        // Add red dot
        const dot = document.createElement('div');
        dot.style.cssText = `
            position: absolute;
            left: 30px;
            top: -5px;
            width: 12px;
            height: 12px;
            background: #ef4444;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        `;
        indicator.appendChild(dot);

        dayGrid.appendChild(indicator);
    }
    {% endif %}
}

// Mark availability on cells
document.addEventListener('DOMContentLoaded', function() {
    const availabilityData = JSON.parse(document.getElementById('availability-data').textContent);

    document.querySelectorAll('.day-cell').forEach(cell => {
        const professionalId = parseInt(cell.dataset.professional);
        const hourStr = cell.dataset.hour;
        const availability = availabilityData[professionalId] || [];

        let isAvailable = false;
        let isBreakTime = false;

        availability.forEach(rule => {
            const startTime = rule.start_time;
            const endTime = rule.end_time;

            if (hourStr >= startTime && hourStr < endTime) {
                if (rule.break_start && rule.break_end) {
                    if (hourStr >= rule.break_start && hourStr < rule.break_end) {
                        isBreakTime = true;
                        return;
                    }
                }
                isAvailable = true;
            }
        });

        if (isBreakTime) {
            cell.classList.add('break-time');
        } else if (isAvailable) {
            cell.classList.add('available');
        } else {
            cell.classList.add('unavailable');
        }
    });

    // Update time indicator
    updateTimeIndicator();
    setInterval(updateTimeIndicator, 60000);
});
</script>
{% endblock %}
