{% extends "base_dashboard.html" %}
{% block title %}Clientes{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">
            <i class="fas fa-users"></i>
            Clientes
        </h1>
    </div>
    <button class="btn-primary" onclick="openClientModal()">
        <i class="fas fa-plus"></i>
        Novo Cliente
    </button>
</div>

<div class="data-card">
    <div class="data-card-header">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Buscar por nome, e-mail ou telefone..." id="searchInput">
        </div>
        <button class="btn-outline" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i>
            Atualizar
        </button>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th class="sortable">Cliente</th>
                <th>Telefone</th>
                <th>CPF</th>
                <th>Cidade</th>
                <th>Status</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for client in clients %}
            <tr>
                <td>
                    <div class="client-info">
                        <span class="client-name">{{ client.name }}</span>
                        <span class="client-email">{{ client.email }}</span>
                    </div>
                </td>
                <td>{{ client.phone|default:"-" }}</td>
                <td>{{ client.cpf|default:"-" }}</td>
                <td>{{ client.city|default:"-" }}</td>
                <td>
                    {% if client.is_active %}
                        <span class="status-badge status-active">Ativo</span>
                    {% else %}
                        <span class="status-badge status-inactive">Inativo</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-action btn-edit" onclick="openClientModal({{ client.id }})">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button class="btn-action btn-delete" onclick="confirmDelete({{ client.id }})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" style="text-align: center; padding: 2rem; color: #94a3b8;">
                    <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                    Nenhum cliente encontrado
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal de Cliente -->
<div class="client-modal-overlay" id="clientModalOverlay" onclick="closeClientModal(event)">
    <div class="client-modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 id="modalTitle"><i class="fas fa-user-plus"></i> Novo Cliente</h2>
            <button class="modal-close" onclick="closeClientModal()"><i class="fas fa-times"></i></button>
        </div>
        
        <form id="clientForm" method="POST">
            {% csrf_token %}
            <input type="hidden" id="clientId" name="client_id" value="">
            
            <div class="avatar-section">
                <div class="avatar-preview" id="avatarPreview"><i class="fas fa-user"></i></div>
            </div>

            <div class="form-tabs">
                <button type="button" class="tab-button active" data-tab="cadastro"><i class="fas fa-user-edit"></i> Cadastro</button>
                <button type="button" class="tab-button" data-tab="endereco"><i class="fas fa-map-marker-alt"></i> Endereço</button>
                <button type="button" class="tab-button" data-tab="config"><i class="fas fa-cog"></i> Config</button>
            </div>

            <div class="tab-content active" data-content="cadastro">
                <div class="form-grid">
                    <div class="form-group"><label>Nome *</label><input type="text" id="name" name="name" required></div>
                    <div class="form-group"><label>Apelido</label><input type="text" id="nickname" name="nickname"></div>
                    <div class="form-group"><label>E-mail</label><input type="email" id="email" name="email"></div>
                    <div class="form-group"><label>Celular *</label><input type="tel" id="phone" name="phone" required></div>
                    <div class="form-group"><label>Telefone</label><input type="tel" id="telephone" name="telephone"></div>
                    <div class="form-group"><label>Aniversário</label><input type="date" id="birth_date" name="birth_date"></div>
                    <div class="form-group"><label>Gênero</label><select id="gender" name="gender"><option value="">Selecione</option><option value="M">Masculino</option><option value="F">Feminino</option><option value="O">Outro</option></select></div>
                    <div class="form-group"><label>CPF</label><input type="text" id="cpf" name="cpf"></div>
                    <div class="form-group"><label>RG</label><input type="text" id="rg" name="rg"></div>
                    <div class="form-group"><label>Indicado por</label><input type="text" id="referred_by" name="referred_by"></div>
                    <div class="form-group full-width"><label>Tags</label><input type="text" id="tags" name="tags" placeholder="vip, fidelidade"></div>
                </div>
            </div>

            <div class="tab-content" data-content="endereco">
                <div class="form-grid">
                    <div class="form-group"><label>CEP</label><input type="text" id="cep" name="cep"></div>
                    <div class="form-group"><label>Rua</label><input type="text" id="street" name="street"></div>
                    <div class="form-group"><label>Número</label><input type="text" id="number" name="number"></div>
                    <div class="form-group"><label>Complemento</label><input type="text" id="complement" name="complement"></div>
                    <div class="form-group"><label>Bairro</label><input type="text" id="neighborhood" name="neighborhood"></div>
                    <div class="form-group"><label>Cidade</label><input type="text" id="city" name="city"></div>
                    <div class="form-group"><label>Estado</label><select id="state" name="state"><option value="">Selecione</option><option value="SP">São Paulo</option><option value="RJ">Rio de Janeiro</option><option value="MG">Minas Gerais</option><option value="RS">Rio Grande do Sul</option><option value="PR">Paraná</option><option value="SC">Santa Catarina</option><option value="BA">Bahia</option><option value="CE">Ceará</option><option value="PE">Pernambuco</option><option value="GO">Goiás</option></select></div>
                </div>
            </div>

            <div class="tab-content" data-content="config">
                <div class="form-grid">
                    <div class="form-group full-width"><label class="checkbox-label"><input type="checkbox" name="is_active" id="is_active" checked> Cliente Ativo</label></div>
                    <div class="form-group full-width"><label class="checkbox-label"><input type="checkbox" name="allow_whatsapp" id="allow_whatsapp" checked> Permitir WhatsApp</label></div>
                    <div class="form-group full-width"><label class="checkbox-label"><input type="checkbox" name="allow_email" id="allow_email" checked> Permitir E-mail</label></div>
                    <div class="form-group full-width"><label>Observações</label><textarea id="notes" name="notes" rows="3"></textarea></div>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeClientModal()"><i class="fas fa-times"></i> Cancelar</button>
                <button type="submit" class="btn-save"><i class="fas fa-check"></i> Salvar</button>
            </div>
        </form>
    </div>
</div>

<style>
.client-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 9999; justify-content: center; align-items: flex-start; padding: 2rem; overflow-y: auto; }
.client-modal-overlay.active { display: flex; }
.client-modal { background: white; border-radius: 16px; width: 100%; max-width: 650px; max-height: calc(100vh - 4rem); overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); animation: modalSlideIn 0.3s ease; }
@keyframes modalSlideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
.modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem 1.5rem; border-bottom: 1px solid #e2e8f0; background: white; position: sticky; top: 0; z-index: 10; }
.modal-header h2 { display: flex; align-items: center; gap: 0.5rem; margin: 0; font-size: 1.15rem; color: #1e293b; }
.modal-header h2 i { color: var(--brand-primary, #3b82f6); }
.modal-close { width: 32px; height: 32px; border: none; background: #f1f5f9; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #64748b; }
.modal-close:hover { background: #e2e8f0; }
#clientForm { padding: 1.25rem; }
.avatar-section { display: flex; flex-direction: column; align-items: center; margin-bottom: 1.25rem; padding-bottom: 1.25rem; border-bottom: 1px solid #e2e8f0; }
.avatar-preview { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
.form-tabs { display: flex; gap: 0.25rem; margin-bottom: 1.25rem; border-bottom: 2px solid #e2e8f0; }
.tab-button { display: flex; align-items: center; gap: 0.35rem; padding: 0.65rem 0.9rem; background: none; border: none; color: #64748b; font-weight: 600; font-size: 0.8rem; cursor: pointer; position: relative; }
.tab-button:hover { color: var(--brand-primary, #3b82f6); }
.tab-button.active { color: var(--brand-primary, #3b82f6); }
.tab-button.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px; background: var(--brand-primary, #3b82f6); }
.tab-content { display: none; }
.tab-content.active { display: block; }
.form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.9rem; }
.form-group { display: flex; flex-direction: column; }
.form-group.full-width { grid-column: 1 / -1; }
.form-group label { margin-bottom: 0.35rem; color: #334155; font-weight: 600; font-size: 0.78rem; }
.form-group input, .form-group select, .form-group textarea { padding: 0.55rem 0.7rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.85rem; }
.form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--brand-primary, #3b82f6); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
.checkbox-label { display: flex !important; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500; }
.checkbox-label input { width: 18px; height: 18px; }
.form-actions { display: flex; justify-content: flex-end; gap: 0.65rem; margin-top: 1.25rem; padding-top: 1.25rem; border-top: 1px solid #e2e8f0; }
.btn-cancel, .btn-save { display: flex; align-items: center; gap: 0.4rem; padding: 0.55rem 1.25rem; border: none; border-radius: 8px; font-weight: 600; font-size: 0.85rem; cursor: pointer; }
.btn-cancel { background: #f1f5f9; color: #64748b; }
.btn-cancel:hover { background: #e2e8f0; }
.btn-save { background: var(--brand-primary, #3b82f6); color: white; }
.btn-save:hover { background: #2563eb; }
@media (max-width: 640px) { .form-grid { grid-template-columns: 1fr; } }
</style>

<script>
function openClientModal(clientId = null) {
    const overlay = document.getElementById('clientModalOverlay');
    const form = document.getElementById('clientForm');
    const title = document.getElementById('modalTitle');
    form.reset();
    document.getElementById('clientId').value = clientId || '';
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('.tab-button[data-tab="cadastro"]').classList.add('active');
    document.querySelector('.tab-content[data-content="cadastro"]').classList.add('active');
    document.getElementById('is_active').checked = true;
    document.getElementById('allow_whatsapp').checked = true;
    document.getElementById('allow_email').checked = true;
    title.innerHTML = clientId ? '<i class="fas fa-user-edit"></i> Editar Cliente' : '<i class="fas fa-user-plus"></i> Novo Cliente';
    if (clientId) { loadClientData(clientId); }
    overlay.classList.add('active');
    document.body.style.overflow = 'hidden';
    setTimeout(() => document.getElementById('name').focus(), 100);
}

function closeClientModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('clientModalOverlay').classList.remove('active');
    document.body.style.overflow = '';
}

function loadClientData(id) {
    fetch('/dashboard/clientes/' + id + '/dados/')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const c = data.client;
                Object.keys(c).forEach(k => {
                    const el = document.getElementById(k);
                    if (el) {
                        if (el.type === 'checkbox') el.checked = c[k];
                        else el.value = c[k] || '';
                    }
                });
            }
        }).catch(e => console.error(e));
}

document.querySelectorAll('.tab-button').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.querySelector('[data-content="' + btn.dataset.tab + '"]').classList.add('active');
    });
});

document.getElementById('cep')?.addEventListener('blur', function() {
    const cep = this.value.replace(/\D/g, '');
    if (cep.length === 8) {
        fetch('https://viacep.com.br/ws/' + cep + '/json/')
            .then(r => r.json())
            .then(d => {
                if (!d.erro) {
                    document.getElementById('street').value = d.logradouro || '';
                    document.getElementById('neighborhood').value = d.bairro || '';
                    document.getElementById('city').value = d.localidade || '';
                    document.getElementById('state').value = d.uf || '';
                }
            });
    }
});

document.getElementById('clientForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const clientId = document.getElementById('clientId').value;
    const url = clientId ? '/dashboard/clientes/' + clientId + '/editar/' : '{% url "dashboard:client_create" %}';
    
    fetch(url, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(r => r.json())
        .then(data => {
            if (data.success) { closeClientModal(); location.reload(); }
            else { alert(data.error || 'Erro ao salvar'); }
        }).catch(() => this.submit());
});

document.getElementById('searchInput').addEventListener('input', function(e) {
    const term = e.target.value.toLowerCase();
    document.querySelectorAll('.data-table tbody tr').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
    });
});

function confirmDelete(id) {
    if (confirm('Excluir este cliente?')) window.location.href = '/dashboard/clientes/' + id + '/excluir/';
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeClientModal(); });
</script>
{% endblock %}
