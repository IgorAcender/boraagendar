{% extends "base_dashboard.html" %}
{% block title %}Calendário{% endblock %}

{% block extra_head %}
<style>
    /* Page Container */
    .calendar-page {
        padding: 1rem;
        max-width: 100%;
    }

    /* Hero Header */
    .hero-header {
        background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-secondary) 100%);
        color: white;
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    }

    .hero-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .hero-title {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .hero-icon {
        width: 50px;
        height: 50px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .hero-title h1 {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
    }

    /* Live Clock */
    .live-clock {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 0.875rem 1.25rem;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .clock-time {
        font-size: 1.75rem;
        font-weight: 700;
        font-family: 'Courier New', monospace;
        margin-bottom: 0.25rem;
    }

    .clock-date {
        font-size: 0.875rem;
        opacity: 0.9;
    }

    /* New Booking Button */
    .btn-new-booking {
        background: rgba(255, 255, 255, 0.95);
        color: var(--brand-primary);
        padding: 0.875rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1rem;
        font-family: inherit;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        text-decoration: none;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .btn-new-booking:hover {
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .btn-new-booking i {
        font-size: 1rem;
    }

    /* Calendar Controls */
    .calendar-controls {
        background: white;
        border-radius: 16px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .nav-buttons {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .nav-btn {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: rgba(102, 126, 234, 0.1);
        border: none;
        color: var(--brand-primary);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .nav-btn:hover {
        background: var(--brand-primary);
        color: white;
        transform: scale(1.05);
    }

    .current-week {
        font-weight: 600;
        color: #1e293b;
        font-size: 1.1rem;
    }

    .btn-today {
        background: var(--brand-primary);
        color: white;
        border: none;
        padding: 0.5rem 1.25rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
        text-decoration: none;
    }

    .btn-today:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* View Toggle Buttons */
    .view-toggle-btn {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        background: white;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .view-toggle-btn:hover {
        background: rgba(102, 126, 234, 0.1);
        color: var(--brand-primary);
        border-color: var(--brand-primary);
    }

    .view-toggle-btn.active {
        background: var(--brand-primary);
        color: white;
        border-color: var(--brand-primary);
    }

    /* Calendar Grid */
    .calendar-container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: 80px repeat(7, 1fr);
        position: relative;
    }

    /* Header Row */
    .calendar-header {
        display: contents;
    }

    .time-column-header {
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
        border-right: 2px solid #e2e8f0;
        padding: 1rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .day-header {
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
        padding: 1rem 0.5rem;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .day-header.today {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
    }

    .day-name {
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        margin-bottom: 0.25rem;
    }

    .day-date {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
    }

    .day-header.today .day-date {
        color: var(--brand-primary);
    }

    /* Time Cells */
    .time-cell {
        background: #f8fafc;
        border-right: 2px solid #e2e8f0;
        border-bottom: 1px solid #e2e8f0;
        padding: 0.5rem;
        font-size: 0.75rem;
        font-weight: 500;
        color: #64748b;
        text-align: right;
        position: sticky;
        left: 0;
        z-index: 5;
    }

    /* Day Cells */
    .day-cell {
        border-bottom: 1px solid #e2e8f0;
        border-right: 1px solid #e2e8f0;
        height: 60px;  /* Altura fixa para posicionamento correto */
        position: relative;
        background: white;
        transition: background 0.2s;
    }

    .day-cell:hover {
        background: #f8fafc;
    }

    /* Horário de atendimento (highlighted) */
    .day-cell.available {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15));
    }

    .day-cell.available:hover {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.25), rgba(5, 150, 105, 0.25));
    }

    /* Horário de intervalo */
    .day-cell.break-time {
        background: repeating-linear-gradient(
            45deg,
            #fef3c7,
            #fef3c7 10px,
            #fef08a 10px,
            #fef08a 20px
        );
        opacity: 0.3;
    }

    /* Horário FORA do atendimento (não disponível) */
    .day-cell.unavailable {
        background: #f1f5f9;
    }

    /* Bookings */
    .booking {
        position: absolute;
        left: 2px;
        right: 2px;
        /* top é definido inline via style="top: X%" */
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
        color: white;
        border-radius: 6px;
        padding: 0.375rem;
        font-size: 0.75rem;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 3;
        text-decoration: none;
    }

    .booking:hover {
        transform: translateX(2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        z-index: 4;
    }

    .booking-customer {
        font-weight: 600;
        margin-bottom: 0.125rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .booking-service {
        font-size: 0.65rem;
        opacity: 0.9;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .booking.status-confirmed {
        background: linear-gradient(135deg, #10b981, #059669);
    }

    .booking.status-pending {
        background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .booking.status-cancelled {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        opacity: 0.6;
    }

    /* Legend */
    .calendar-legend {
        display: flex;
        gap: 1.5rem;
        padding: 1rem 1.5rem;
        background: #f8fafc;
        border-top: 2px solid #e2e8f0;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: #64748b;
    }

    .legend-color {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        border: 1px solid #cbd5e1;
    }

    .legend-color.available {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.3));
    }

    .legend-color.unavailable {
        background: #f1f5f9;
    }

    .legend-color.booking {
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .calendar-grid {
            grid-template-columns: 60px repeat(7, 1fr);
        }

        .day-name {
            font-size: 0.65rem;
        }

        .day-date {
            font-size: 1rem;
        }
    }

    @media (max-width: 768px) {
        .calendar-grid {
            grid-template-columns: 50px repeat(7, minmax(80px, 1fr));
            overflow-x: auto;
        }

        .day-header {
            padding: 0.75rem 0.25rem;
        }

        .day-cell {
            min-height: 50px;
        }
    }

    /* Modal */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease-out;
    }

    .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
    }

    .modal-content {
        position: relative;
        background: white;
        border-radius: 20px;
        max-width: 600px;
        width: 90%;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease-out;
    }

    .modal-header {
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
        color: white;
        padding: 1.5rem 2rem;
        border-radius: 20px 20px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .modal-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        color: white;
        font-size: 1.25rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    .modal-body {
        padding: 2rem;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<script>
console.log('DEBUG calendar template: Total de bookings recebidos:', {{ bookings|length }});
{% for booking in bookings %}
console.log('  Booking {{ booking.id }}: {{ booking.customer_name }} em {{ booking.date }} às {{ booking.hour }}');
{% endfor %}
</script>
<div class="calendar-page">
    <!-- Hero Header -->
    <div class="hero-header">
        <div class="hero-content">
            <div class="hero-title">
                <div class="hero-icon">
                    <i class="fas fa-calendar-week"></i>
                </div>
                <div>
                    <h1>Calendário Semanal</h1>
                    <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Visualização de 24 horas</p>
                </div>
            </div>

            <!-- Actions -->
            <div style="display: flex; align-items: center; gap: 1rem;">
                <!-- Relógio em Tempo Real -->
                <div class="live-clock">
                    <div class="clock-time" id="liveTime">--:--:--</div>
                    <div class="clock-date" id="liveDate">--/--/----</div>
                </div>

                <!-- New Booking Button -->
                <button onclick="openNewBookingModal()" class="btn-new-booking">
                    <i class="fas fa-plus"></i>
                    Novo Agendamento
                </button>
            </div>
        </div>
    </div>

    <!-- Calendar Controls -->
    <div class="calendar-controls">
        <div class="nav-buttons">
            <a href="?week_offset={{ request.GET.week_offset|default:0|add:'-1' }}{% if selected_professional %}&professional={{ selected_professional.id }}{% endif %}" class="nav-btn" title="Semana anterior">
                <i class="fas fa-chevron-left"></i>
            </a>
            <span class="current-week">
                {{ week_start|date:"d/m" }} - {{ week_end|date:"d/m/Y" }}
            </span>
            <a href="?week_offset={{ request.GET.week_offset|default:0|add:'1' }}{% if selected_professional %}&professional={{ selected_professional.id }}{% endif %}" class="nav-btn" title="Próxima semana">
                <i class="fas fa-chevron-right"></i>
            </a>
        </div>

        <div style="display: flex; gap: 1rem; align-items: center;">
            <!-- Filtro de Profissional -->
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <label for="professional-filter" style="font-size: 0.875rem; color: #64748b; font-weight: 500;">
                    <i class="fas fa-filter"></i> Profissional:
                </label>
                <select id="professional-filter" onchange="filterByProfessional(this.value)"
                        style="padding: 0.5rem 1rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; color: #1e293b; cursor: pointer;">
                    <option value="">Todos</option>
                    {% for prof in professionals %}
                    <option value="{{ prof.id }}" {% if selected_professional and selected_professional.id == prof.id %}selected{% endif %}>
                        {{ prof.display_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <a href="?{% if request.GET.week_offset %}week_offset={{ request.GET.week_offset }}{% endif %}" class="btn-today">
                <i class="fas fa-calendar-day"></i> Hoje
            </a>

            <!-- View Toggle -->
            <div style="display: flex; gap: 0.5rem; margin-left: 1rem; padding-left: 1rem; border-left: 1px solid #e5e7eb;">
                <a href="{% url 'dashboard:calendar' %}" class="view-toggle-btn active">
                    <i class="fas fa-calendar-week"></i> Semana
                </a>
                <a href="{% url 'dashboard:calendar_day' %}" class="view-toggle-btn">
                    <i class="fas fa-calendar-day"></i> Dia
                </a>
            </div>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="calendar-container">
        <div class="calendar-grid">
            <!-- Header Row -->
            <div class="calendar-header">
                <div class="time-column-header">Hora</div>
                {% for day in week_days %}
                <div class="day-header {% if day.is_today %}today{% endif %}">
                    <div class="day-name">{{ day.name }}</div>
                    <div class="day-date">{{ day.date.day }}</div>
                </div>
                {% endfor %}
            </div>

            <!-- Time Rows (24 horas) -->
            {% for hour in hours %}
                <!-- Time Label -->
                <div class="time-cell">{{ hour }}</div>

                <!-- Day Cells -->
                {% for day in week_days %}
                <div class="day-cell"
                     data-date="{{ day.date|date:'Y-m-d' }}"
                     data-hour="{{ hour }}"
                     data-weekday="{{ day.date.weekday }}">

                    <!-- Bookings for this cell -->
                    {% for booking in bookings %}
                        <!-- DEBUG: booking.date={{ booking.date }}, day.date={{ day.date }}, booking.hour={{ booking.hour }}, hour={{ hour }} -->
                        {% if booking.date == day.date and booking.hour == hour %}
                        <div class="booking status-{{ booking.status }}"
                             style="top: {{ booking.offset|stringformat:'f' }}%; height: {{ booking.height|stringformat:'f' }}%; min-height: 35px; z-index: 100;"
                             onclick="openBookingModal({{ booking.id }})"
                             title="{{ booking.customer_name }} - {{ booking.service.name }} - {{ booking.time_display }}">
                            <div class="booking-customer">
                                <i class="fas fa-clock" style="font-size: 0.65rem; opacity: 0.8;"></i>
                                {{ booking.time_display }} - {{ booking.customer_name }}
                            </div>
                            <div class="booking-service">{{ booking.service.name }}</div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endfor %}
            {% endfor %}
        </div>

        <!-- Legend -->
        <div class="calendar-legend">
            <div class="legend-item">
                <div class="legend-color available"></div>
                <span>Horário de Atendimento</span>
            </div>
            <div class="legend-item">
                <div class="legend-color unavailable"></div>
                <span>Fora do Horário</span>
            </div>
            <div class="legend-item">
                <div class="legend-color booking"></div>
                <span>Agendamento</span>
            </div>
        </div>
    </div>

    <!-- DEBUG: Painel de Bookings -->
    <div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px;">
        <h3 style="margin: 0 0 1rem 0; color: #92400e;">🐛 DEBUG: Bookings Carregados ({{ bookings|length }})</h3>
        {% if bookings %}
        <table style="width: 100%; font-size: 0.875rem; border-collapse: collapse;">
            <thead>
                <tr style="background: #fde68a;">
                    <th style="padding: 0.5rem; text-align: left; border: 1px solid #f59e0b;">ID</th>
                    <th style="padding: 0.5rem; text-align: left; border: 1px solid #f59e0b;">Cliente</th>
                    <th style="padding: 0.5rem; text-align: left; border: 1px solid #f59e0b;">Data</th>
                    <th style="padding: 0.5rem; text-align: left; border: 1px solid #f59e0b;">Hora</th>
                    <th style="padding: 0.5rem; text-align: left; border: 1px solid #f59e0b;">Serviço</th>
                    <th style="padding: 0.5rem; text-align: left; border: 1px solid #f59e0b;">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in bookings %}
                <tr style="background: white;">
                    <td style="padding: 0.5rem; border: 1px solid #fde68a;">{{ booking.id }}</td>
                    <td style="padding: 0.5rem; border: 1px solid #fde68a;">{{ booking.customer_name }}</td>
                    <td style="padding: 0.5rem; border: 1px solid #fde68a;">{{ booking.date }}</td>
                    <td style="padding: 0.5rem; border: 1px solid #fde68a;">{{ booking.hour }} (exibir: {{ booking.time_display }})</td>
                    <td style="padding: 0.5rem; border: 1px solid #fde68a;">{{ booking.service.name }}</td>
                    <td style="padding: 0.5rem; border: 1px solid #fde68a;">{{ booking.status }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: #92400e; margin: 0;">Nenhum booking encontrado para exibir.</p>
        {% endif %}
    </div>

    <!-- Modal de Detalhes do Agendamento -->
    <div id="bookingModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeBookingModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-calendar-check"></i> Detalhes do Agendamento</h2>
                <button class="modal-close" onclick="closeBookingModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <div style="text-align: center; padding: 3rem;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--brand-primary);"></i>
                    <p style="margin-top: 1rem; color: #64748b;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Novo Agendamento -->
    <div id="newBookingModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeNewBookingModal()"></div>
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2><i class="fas fa-plus"></i> Novo Agendamento</h2>
                <button class="modal-close" onclick="closeNewBookingModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="newModalBody">
                <div style="text-align: center; padding: 3rem;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--brand-primary);"></i>
                    <p style="margin-top: 1rem; color: #64748b;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>
</div>

{{ availability_by_weekday|json_script:"availability-data" }}

<script>
// Funções do Modal
function openBookingModal(bookingId) {
    const modal = document.getElementById('bookingModal');
    const modalBody = document.getElementById('modalBody');

    // Mostrar modal
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Prevenir scroll da página

    // Carregar conteúdo via AJAX
    fetch(`/dashboard/agendamentos/${bookingId}/`)
        .then(response => response.text())
        .then(html => {
            // Extrair apenas o conteúdo relevante (sem o layout completo)
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const content = doc.querySelector('.booking-details, .card, main, .content') || doc.body;

            modalBody.innerHTML = content.innerHTML;
        })
        .catch(error => {
            modalBody.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #ef4444;"></i>
                    <p style="margin-top: 1rem; color: #64748b;">Erro ao carregar detalhes do agendamento.</p>
                </div>
            `;
            console.error('Erro ao carregar agendamento:', error);
        });
}

function closeBookingModal() {
    const modal = document.getElementById('bookingModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Funções do Modal de Novo Agendamento
function openNewBookingModal() {
    const modal = document.getElementById('newBookingModal');
    const modalBody = document.getElementById('newModalBody');

    // Mostrar modal
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Prevenir scroll da página

    // Carregar formulário de novo agendamento via AJAX
    fetch('/dashboard/agendamentos/novo/')
        .then(response => response.text())
        .then(html => {
            // Extrair apenas o formulário (sem o layout completo)
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Procurar pelo formulário ou conteúdo principal
            const form = doc.querySelector('form') || doc.querySelector('.booking-form') || doc.querySelector('main') || doc.body;
            
            modalBody.innerHTML = form.innerHTML;
            
            // Reconfigurar o formulário para submissão via AJAX
            const formElement = modalBody.querySelector('form');
            if (formElement) {
                formElement.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitNewBookingForm(formElement);
                });
            }
        })
        .catch(error => {
            modalBody.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #ef4444;"></i>
                    <p style="margin-top: 1rem; color: #64748b;">Erro ao carregar formulário de agendamento.</p>
                </div>
            `;
            console.error('Erro ao carregar formulário:', error);
        });
}

function closeNewBookingModal() {
    const modal = document.getElementById('newBookingModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Função para submeter o formulário via AJAX
function submitNewBookingForm(form) {
    const formData = new FormData(form);
    const submitButton = form.querySelector('button[type="submit"]');
    
    // Desabilitar botão durante envio
    if (submitButton) {
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
    }
    
    fetch('/dashboard/agendamentos/novo/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.redirected) {
            // Se houve redirecionamento (sucesso), fechar modal e recarregar página
            closeNewBookingModal();
            window.location.reload();
        } else {
            // Se não houve redirecionamento, provavelmente há erros no formulário
            return response.text();
        }
    })
    .then(html => {
        if (html) {
            // Atualizar o modal com os erros
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const form = doc.querySelector('form') || doc.querySelector('.booking-form') || doc.querySelector('main') || doc.body;
            
            document.getElementById('newModalBody').innerHTML = form.innerHTML;
            
            // Reconfigurar o evento de submit
            const newForm = document.getElementById('newModalBody').querySelector('form');
            if (newForm) {
                newForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitNewBookingForm(newForm);
                });
            }
        }
    })
    .catch(error => {
        console.error('Erro ao enviar formulário:', error);
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-calendar-check"></i> Confirmar agendamento';
        }
    });
}
    document.body.style.overflow = ''; // Restaurar scroll
}

// Função para filtrar por profissional
function filterByProfessional(professionalId) {
    const urlParams = new URLSearchParams(window.location.search);

    if (professionalId) {
        urlParams.set('professional', professionalId);
    } else {
        urlParams.delete('professional');
    }

    // Manter o week_offset se existir
    const weekOffset = urlParams.get('week_offset');

    // Construir nova URL
    let newUrl = window.location.pathname + '?';
    if (weekOffset) {
        newUrl += 'week_offset=' + weekOffset;
        if (professionalId) {
            newUrl += '&professional=' + professionalId;
        }
    } else if (professionalId) {
        newUrl += 'professional=' + professionalId;
    } else {
        newUrl = window.location.pathname;
    }

    window.location.href = newUrl;
}
</script>

<script>
// Marcar células como disponíveis/indisponíveis baseado nos horários de atendimento
document.addEventListener('DOMContentLoaded', function() {
    console.log('DEBUG - Iniciando marcação de disponibilidade');

    const availabilityByWeekday = JSON.parse(document.getElementById('availability-data').textContent);
    console.log('DEBUG - availability_by_weekday:', availabilityByWeekday);

    // Para cada célula do calendário
    document.querySelectorAll('.day-cell').forEach(cell => {
        const weekday = parseInt(cell.dataset.weekday);
        const hourStr = cell.dataset.hour;
        const availability = availabilityByWeekday[weekday] || [];

        if (availability.length > 0) {
            console.log(`DEBUG - Dia ${weekday}, Hora ${hourStr}, Regras:`, availability);
        }

        let isAvailable = false;
        let isBreakTime = false;

        // Verificar se está em algum período de disponibilidade
        availability.forEach(rule => {
            const startTime = rule.start_time;
            const endTime = rule.end_time;

            console.log(`DEBUG - Comparando ${hourStr} com ${startTime} - ${endTime}`);

            if (hourStr >= startTime && hourStr < endTime) {
                // Verificar se não está no intervalo
                if (rule.break_start && rule.break_end) {
                    if (hourStr >= rule.break_start && hourStr < rule.break_end) {
                        isBreakTime = true;
                        console.log(`DEBUG - ${hourStr} está no intervalo`);
                        return;
                    }
                }
                isAvailable = true;
                console.log(`DEBUG - ${hourStr} está disponível`);
            }
        });

        if (isBreakTime) {
            cell.classList.add('break-time');
        } else if (isAvailable) {
            cell.classList.add('available');
        } else {
            cell.classList.add('unavailable');
        }
    });

    // Atualizar relógio em tempo real
    function updateClock() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');

        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const year = now.getFullYear();

        document.getElementById('liveTime').textContent = `${hours}:${minutes}:${seconds}`;
        document.getElementById('liveDate').textContent = `${day}/${month}/${year}`;
    }

    // Atualizar a cada segundo
    updateClock();
    setInterval(updateClock, 1000);

    // Adicionar indicador de hora atual no calendário
    function updateTimeIndicator() {
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinutes = now.getMinutes();

        // Remover indicador anterior se existir
        const oldIndicator = document.getElementById('current-time-indicator');
        if (oldIndicator) {
            oldIndicator.remove();
        }

        // Calcular posição: cada hora tem 60px (altura da célula)
        // Posição = (hora * 60) + (minutos * 60/60) + offset do header
        const calendarGrid = document.querySelector('.calendar-grid');
        if (calendarGrid) {
            // Calcular altura do header dinamicamente
            const headerElement = document.querySelector('.day-header');
            const headerHeight = headerElement ? headerElement.offsetHeight : 60;
            
            const indicator = document.createElement('div');
            indicator.id = 'current-time-indicator';
            indicator.style.cssText = `
                position: absolute;
                left: 0;
                right: 0;
                height: 2px;
                background: #ef4444;
                z-index: 1000;
                pointer-events: none;
                box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
            `;

            // 60px é a altura da célula de hora + offset do header
            // Cada minuto = 1 pixel (60 minutos = 60 pixels de altura da célula)
            const topPosition = headerHeight + (currentHour * 60) + currentMinutes;
            indicator.style.top = `${topPosition}px`;
            
            // Debug - remover depois
            console.log(`Debug: Hora atual: ${currentHour}:${currentMinutes.toString().padStart(2, '0')}`);
            console.log(`Debug: Header height: ${headerHeight}px`);
            console.log(`Debug: Top position: ${topPosition}px`);
            console.log(`Debug: Cálculo: ${headerHeight} + (${currentHour} * 60) + ${currentMinutes} = ${topPosition}`);

            // Adicionar bolinha vermelha no início da linha
            const dot = document.createElement('div');
            dot.style.cssText = `
                position: absolute;
                left: -6px;
                top: -5px;
                width: 12px;
                height: 12px;
                background: #ef4444;
                border-radius: 50%;
                border: 2px solid white;
                box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
            `;
            indicator.appendChild(dot);

            calendarGrid.appendChild(indicator);
        }
    }

    // Atualizar indicador de hora imediatamente e a cada minuto
    updateTimeIndicator();
    setInterval(updateTimeIndicator, 60000);
});
</script>
{% endblock %}
