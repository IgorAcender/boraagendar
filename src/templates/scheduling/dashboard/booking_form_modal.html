{% load static %}
<div class="booking-form-card booking-modal-wrapper">
<style>
    .booking-modal-wrapper {
        background: transparent;
        border: none;
        box-shadow: none;
        padding: 0;
        margin: 0;
    }

    .booking-modal-wrapper form {
        margin: 0;
    }

    .booking-modal {
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
        border-radius: 22px;
        padding: 1.75rem;
        box-shadow: 0 30px 60px -25px rgba(15, 23, 42, 0.65);
        color: #0f172a;
        max-width: 780px;
        margin: 0 auto;
    }

    .booking-modal__hero {
        background: rgba(255, 255, 255, 0.14);
        border-radius: 18px;
        padding: 1.65rem 2rem;
        margin-bottom: 1.75rem;
        color: #f8fafc;
        position: relative;
        overflow: hidden;
    }

    .booking-modal__badge {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        background: rgba(15, 23, 42, 0.4);
        padding: 0.4rem 0.85rem;
        border-radius: 999px;
        margin-bottom: 0.85rem;
    }

    .booking-modal__hero h3 {
        margin: 0;
        font-size: 1.6rem;
        font-weight: 700;
        line-height: 1.3;
    }

    .booking-modal__hero p {
        margin: 0.9rem 0 1.1rem 0;
        font-size: 1rem;
        color: rgba(248, 250, 252, 0.85);
    }

    .booking-modal__hero-highlights {
        display: flex;
        flex-wrap: wrap;
        gap: 0.65rem;
    }

    .booking-modal__hero-highlights span {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        font-size: 0.82rem;
        background: rgba(15, 23, 42, 0.28);
        padding: 0.5rem 0.8rem;
        border-radius: 12px;
    }

    .booking-modal__form-wrapper {
        background: #ffffff;
        border-radius: 18px;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1.75rem;
    }

    .booking-modal__alert {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 1rem 1.2rem;
        border-radius: 12px;
        border: 1px solid rgba(239, 68, 68, 0.3);
        background: #fef2f2;
        color: #b91c1c;
        font-size: 0.92rem;
    }

    .booking-modal__grid {
        display: grid;
        gap: 1.5rem;
    }

    @media (min-width: 900px) {
        .booking-modal__grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .booking-modal__grid .span-2 {
            grid-column: 1 / -1;
        }
    }

    .booking-modal__section {
        background: #f8fafc;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        padding: 1.65rem;
        display: flex;
        flex-direction: column;
        gap: 1.35rem;
        position: relative;
        min-height: 160px;
    }

    .booking-modal__section-header {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .booking-modal__section-icon {
        width: 48px;
        height: 48px;
        border-radius: 16px;
        background: linear-gradient(140deg, var(--brand-primary), var(--brand-secondary));
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
    }

    .booking-modal__section-title h4 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 700;
        color: #1e293b;
    }

    .booking-modal__section-title span {
        display: block;
        margin-top: 0.25rem;
        font-size: 0.87rem;
        color: #64748b;
    }

    .booking-modal__hidden-field {
        display: none;
    }

    .services-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .service-card {
        background: #ffffff;
        border: 3px solid #e2e8f0;
        border-radius: 14px;
        padding: 1.25rem;
        transition: all 0.3s;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
        display: block;
        width: 100%;
        text-align: left;
        appearance: none;
        font: inherit;
        outline: none;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .service-card:hover {
        border-color: var(--brand-primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .service-card.selected {
        border-color: var(--brand-primary);
        border-width: 3px;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .service-card:focus-visible {
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
    }

    .service-card .service-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.35rem;
    }

    .service-card .service-meta {
        font-size: 0.85rem;
        color: #64748b;
        display: flex;
        gap: 0.75rem;
        margin-top: 0.75rem;
    }

    .service-card .service-meta span {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-weight: 600;
        color: #475569;
    }

    .service-description {
        margin-top: 0.4rem;
        font-size: 0.9rem;
        color: #64748b;
    }

    .professionals-grid {
        display: grid;
        gap: 1rem;
    }

    @media (min-width: 720px) {
        .professionals-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    .professional-card {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 0.75rem;
        text-align: center;
        transition: all 0.3s;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .professional-card:hover {
        border-color: var(--brand-primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .professional-card.selected {
        border-color: var(--brand-primary);
        border-width: 3px;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .professional-card-avatar {
        width: 60px;
        height: 60px;
        margin: 0 auto 0.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .professional-card-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }

    .professional-card-name {
        font-size: 0.85rem;
        font-weight: 600;
        color: #1e293b;
        margin-top: 0.25rem;
        text-align: center;
    }

    .professional-card-info {
        font-size: 0.75rem;
        color: #94a3b8;
    }

    .professional-card-any .professional-card-name {
        color: var(--brand-primary);
    }

    .bm-placeholder {
        background: #f1f5f9;
        border-radius: 14px;
        padding: 1.2rem;
        text-align: center;
        font-size: 0.9rem;
        color: #475569;
    }

    .calendar-widget {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .calendar-month {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1e293b;
    }

    .calendar-nav {
        display: flex;
        gap: 0.5rem;
    }

    .calendar-nav-btn {
        width: 36px;
        height: 36px;
        border: none;
        background: #f1f5f9;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        color: #64748b;
    }

    .calendar-nav-btn:hover {
        background: var(--brand-primary);
        color: white;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
    }

    .calendar-day-header {
        text-align: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
        padding: 0.75rem 0.25rem;
        text-transform: uppercase;
        background: #f8fafc;
        border-radius: 4px;
    }

    .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
        border: 2px solid transparent;
    }

    .calendar-day:hover {
        background: #f1f5f9;
    }

    .calendar-day.disabled,
    .calendar-day.other-month {
        color: #cbd5e1;
        cursor: not-allowed;
        background: #f8fafc;
    }

    .calendar-day.selected {
        background: var(--brand-primary);
        color: white;
        border-color: var(--brand-primary);
        font-weight: 700;
    }

    .calendar-day.today {
        border-color: var(--brand-primary);
        color: var(--brand-primary);
        font-weight: 700;
    }

    .slots-section {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .slots-info {
        background: #eef2ff;
        border-radius: 12px;
        padding: 0.85rem 1rem;
        font-size: 0.85rem;
        color: #4338ca;
        display: flex;
        align-items: center;
        gap: 0.6rem;
    }

    .slots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.65rem;
    }

    .slot-card {
        background: #ffffff;
        border: 3px solid #cbd5e1;
        border-radius: 14px;
        padding: 0.875rem 0.5rem;
        text-align: center;
        transition: all 0.2s;
        cursor: pointer;
        text-decoration: none;
        color: #1e293b;
        font-weight: 600;
    }

    .slot-card:hover {
        background: #f8fafc;
        border-color: var(--brand-primary);
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
    }

    .slot-card.selected {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        border-color: var(--brand-primary);
    }

    .booking-modal__actions {
        display: flex;
        justify-content: flex-end;
    }

    .booking-modal__submit {
        min-width: 220px;
        padding: 1rem 1.6rem;
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
        color: #ffffff;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.55rem;
        box-shadow: 0 10px 25px -12px rgba(99, 102, 241, 0.6);
        transition: transform 0.18s ease, box-shadow 0.18s ease;
    }

    .booking-modal__submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 18px 32px -16px rgba(99, 102, 241, 0.65);
    }

    @media (max-width: 768px) {
        .booking-modal {
            padding: 1.25rem;
        }
        .booking-modal__form-wrapper {
            padding: 1.45rem;
        }
        .booking-modal__hero {
            padding: 1.35rem 1.5rem;
        }
    }
</style>

<div class="booking-modal">
    <div class="booking-modal__hero">
        <span class="booking-modal__badge"><i class="fas fa-bolt"></i> Fluxo guiado</span>
        <h3>Crie um agendamento em segundos ✨</h3>
        <p>Escolha o serviço, selecione a data, defina quem atende, escolha o horário e finalize com os dados do cliente.</p>
        <div class="booking-modal__hero-highlights">
            <span><i class="fas fa-check-circle"></i> Somente horários livres</span>
            <span><i class="fas fa-user-friends"></i> Serviços e profissionais sincronizados</span>
            <span><i class="fas fa-bell"></i> Cliente pronto para receber notificações</span>
        </div>
    </div>

    <div class="booking-modal__form-wrapper">
        <form method="post">
            {% csrf_token %}

            {% if form.non_field_errors %}
            <div class="booking-modal__alert">
                <i class="fas fa-exclamation-triangle"></i>
                <div>{{ form.non_field_errors }}</div>
            </div>
            {% endif %}

            <div class="booking-modal__grid">
                <div class="booking-modal__section span-2" id="bmServiceSection">
                    <div class="booking-modal__section-header">
                        <div class="booking-modal__section-icon"><i class="fas fa-concierge-bell"></i></div>
                        <div class="booking-modal__section-title">
                            <h4>1. Escolha o serviço</h4>
                            <span>Os serviços carregam automaticamente com duração e preço</span>
                        </div>
                    </div>

                    <div class="booking-modal__hidden-field">{{ form.service }}</div>

                    {% if services %}
                    <div class="services-grid" id="bmServiceCards">
                        {% for service in services %}
                        <button type="button"
                                class="service-card"
                                data-service-id="{{ service.id }}"
                                data-category="{{ service.category|default_if_none:'' }}">
                            {% if service.category %}
                            <div class="service-meta"><span><i class="fas fa-tag"></i> {{ service.category }}</span></div>
                            {% endif %}
                            <div class="service-name">{{ service.name }}</div>
                            {% if service.description %}
                            <p class="service-description">{{ service.description }}</p>
                            {% endif %}
                            <div class="service-meta">
                                <span><i class="fas fa-clock"></i> {{ service.duration_minutes|default:"-" }} min</span>
                                <span><i class="fas fa-dollar-sign"></i> R$ {{ service.price|floatformat:2 }}</span>
                            </div>
                        </button>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="bm-placeholder">
                        Nenhum serviço cadastrado ainda. Cadastre um serviço para começar a agendar.
                    </div>
                    {% endif %}

                    {{ form.service.errors }}
                </div>

                <div class="booking-modal__section span-2" id="bmDateSection">
                    <div class="booking-modal__section-header">
                        <div class="booking-modal__section-icon"><i class="fas fa-calendar-alt"></i></div>
                        <div class="booking-modal__section-title">
                            <h4>2. Escolha a data</h4>
                            <span>Selecione o dia para desbloquear os horários</span>
                        </div>
                    </div>

                    <div class="booking-modal__hidden-field">{{ form.date }}</div>

                    <div class="calendar-widget">
                        <div class="calendar-header">
                            <div class="calendar-month" id="bmCalendarMonth"></div>
                            <div class="calendar-nav">
                                <button type="button" class="calendar-nav-btn" id="bmCalendarPrev" aria-label="Mês anterior"><i class="fas fa-chevron-left"></i></button>
                                <button type="button" class="calendar-nav-btn" id="bmCalendarNext" aria-label="Próximo mês"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                        <div class="calendar-grid" id="bmCalendarGrid"></div>
                    </div>

                    {{ form.date.errors }}
                </div>

                <div class="booking-modal__section span-2" id="bmProfessionalSection">
                    <div class="booking-modal__section-header">
                        <div class="booking-modal__section-icon"><i class="fas fa-user-tie"></i></div>
                        <div class="booking-modal__section-title">
                            <h4>3. Escolha o profissional</h4>
                            <span>Selecione quem irá realizar o atendimento</span>
                        </div>
                    </div>

                    <div class="booking-modal__hidden-field">{{ form.professional }}</div>

                    <div id="bmProfessionalCards" class="professionals-grid"></div>
                    <div id="bmProfessionalPlaceholder" class="bm-placeholder">
                        Selecione um serviço e uma data para ver os profissionais disponíveis.
                    </div>

                    {{ form.professional.errors }}
                </div>

                <div class="booking-modal__section span-2" id="bmTimeSection">
                    <div class="booking-modal__section-header">
                        <div class="booking-modal__section-icon"><i class="fas fa-clock"></i></div>
                        <div class="booking-modal__section-title">
                            <h4>4. Escolha o horário</h4>
                            <span>Defina o melhor horário disponível para o atendimento</span>
                        </div>
                    </div>

                    <div class="booking-modal__hidden-field">{{ form.time }}</div>

                    <div class="slots-section">
                        <div class="slots-info" id="bmSlotsInfo">
                            <i class="fas fa-info-circle"></i>
                            <span>Selecione um serviço, uma data e um profissional para listar os horários disponíveis.</span>
                        </div>
                        <div class="slots-grid" id="bmSlotList"></div>
                    </div>

                    {{ form.time.errors }}
                </div>

                <div class="booking-modal__section span-2">
                    <div class="booking-modal__section-header">
                        <div class="booking-modal__section-icon"><i class="fas fa-user-circle"></i></div>
                        <div class="booking-modal__section-title">
                            <h4>5. Dados do cliente</h4>
                            <span>Confirme as informações para contato e lembretes</span>
                        </div>
                    </div>
                    <div class="booking-modal__row two-columns">
                        <div class="booking-modal__field">
                            <label for="{{ form.customer_name.id_for_label }}">Nome <span class="required">*</span></label>
                            {{ form.customer_name }}
                            {{ form.customer_name.errors }}
                        </div>
                        <div class="booking-modal__field">
                            <label for="{{ form.customer_phone.id_for_label }}">Telefone / WhatsApp <span class="required">*</span></label>
                            {{ form.customer_phone }}
                            {{ form.customer_phone.errors }}
                        </div>
                    </div>
                    <div class="booking-modal__field">
                        <label for="{{ form.notes.id_for_label }}">Observações</label>
                        {{ form.notes }}
                        {{ form.notes.errors }}
                    </div>
                </div>
            </div>

            <div class="booking-modal__actions">
                <button type="submit" class="booking-modal__submit">
                    <i class="fas fa-calendar-plus"></i>
                    Salvar agendamento
                </button>
            </div>
        </form>
    </div>
</div>
</div>

{% if services_json %}
{{ services_json|json_script:"booking-services-data" }}
{% endif %}

<script>
    window.initializeDashboardBookingModal = function(rootElement) {
        const root = rootElement || document.getElementById('newBookingModalBody') || document;
        const container = root.querySelector('.booking-modal');
        if (!container || container.dataset.initialized === 'true') {
            return;
        }
        container.dataset.initialized = 'true';

        const servicesDataElement = root.querySelector('#booking-services-data');
        const servicesData = servicesDataElement ? JSON.parse(servicesDataElement.textContent) : [];
        const servicesMap = {};
        servicesData.forEach(service => { servicesMap[String(service.id)] = service; });

        const tenantSlug = "{{ tenant.slug }}";
        const todayString = "{{ today|date:'Y-m-d' }}";

        const serviceSelect = container.querySelector('#id_service');
        const professionalSelect = container.querySelector('#id_professional');
        const dateInput = container.querySelector('#id_date');
        const timeInput = container.querySelector('#id_time');

        const serviceCards = Array.from(container.querySelectorAll('.service-card'));
        const professionalContainer = container.querySelector('#bmProfessionalCards');
        const professionalPlaceholder = container.querySelector('#bmProfessionalPlaceholder');
        const slotsInfo = container.querySelector('#bmSlotsInfo');
        const slotList = container.querySelector('#bmSlotList');
        const serviceSection = container.querySelector('#bmServiceSection');
        const dateSection = container.querySelector('#bmDateSection');
        const professionalSection = container.querySelector('#bmProfessionalSection');
        const timeSection = container.querySelector('#bmTimeSection');

        let selectedServiceId = serviceSelect ? serviceSelect.value || null : null;
        let selectedProfessionalId = professionalSelect ? professionalSelect.value || null : null;
        let selectedDate = dateInput ? dateInput.value || null : null;
        let selectedSlotIso = null;
        let calendarInstance = null;

        if (dateInput) {
            dateInput.setAttribute('min', todayString);
        }

        function scrollToSection(section) {
            if (section && typeof section.scrollIntoView === 'function') {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function resetProfessionalSelection() {
            selectedProfessionalId = null;
            if (professionalSelect) {
                professionalSelect.value = '';
            }
            selectedSlotIso = null;
            if (timeInput) {
                timeInput.value = '';
            }
            if (professionalContainer) {
                professionalContainer.innerHTML = '';
            }
            if (professionalPlaceholder) {
                professionalPlaceholder.style.display = 'block';
                professionalPlaceholder.innerHTML = 'Selecione um serviço e uma data para ver os profissionais disponíveis.';
            }
        }

        function resetDateAndTime(clearCalendar = true) {
            selectedDate = null;
            selectedSlotIso = null;
            if (dateInput) {
                dateInput.value = '';
            }
            if (timeInput) {
                timeInput.value = '';
            }
            if (clearCalendar && calendarInstance) {
                calendarInstance.clearSelection();
            }
            renderSlots([]);
        }

        function setService(serviceId, { scroll = true } = {}) {
            if (!serviceSelect) {
                return;
            }
            selectedServiceId = serviceId;
            serviceSelect.value = serviceId;
            serviceSelect.dispatchEvent(new Event('change', { bubbles: true }));

            serviceCards.forEach(card => {
                const isSelected = card.dataset.serviceId === serviceId;
                card.classList.toggle('selected', isSelected);
                card.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
            });

            resetDateAndTime();
            resetProfessionalSelection();
            renderProfessionalCards();
            if (scroll) {
                scrollToSection(dateSection);
            }
        }

        function renderProfessionalCards() {
            if (!professionalContainer || !professionalPlaceholder) {
                return;
            }

            professionalContainer.innerHTML = '';
            professionalPlaceholder.style.display = 'block';

            if (!selectedServiceId || !servicesMap[selectedServiceId]) {
                professionalPlaceholder.innerHTML = 'Selecione um serviço para ver os profissionais disponíveis.';
                return;
            }

            if (!selectedDate) {
                professionalPlaceholder.innerHTML = 'Selecione uma data antes de escolher o profissional.';
                return;
            }

            const professionals = servicesMap[selectedServiceId].professionals || [];
            if (!professionals.length) {
                professionalPlaceholder.innerHTML = 'Nenhum profissional ativo cadastrado para este serviço.';
                return;
            }

            professionalPlaceholder.style.display = 'none';

            const allowAutoAssign = servicesMap[selectedServiceId].has_auto_assign;
            const fragment = document.createDocumentFragment();

            if (allowAutoAssign) {
                fragment.appendChild(createProfessionalCard({
                    id: '',
                    name: 'Sem preferência',
                    color: '#6366f1',
                    initial: '∞',
                    isAuto: true,
                }));
            }

            professionals.forEach(professional => {
                fragment.appendChild(createProfessionalCard(professional));
            });

            professionalContainer.appendChild(fragment);
            updateProfessionalCardSelection();
        }

        function createProfessionalCard(professional) {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'professional-card';
            if (professional.isAuto) {
                button.classList.add('professional-card-any');
            }
            button.dataset.professionalId = professional.id === '' ? '' : String(professional.id);

            const avatar = document.createElement('div');
            avatar.className = 'professional-card-avatar';
            avatar.style.background = professional.color || '#6366f1';

            if (professional.photo_base64) {
                const img = document.createElement('img');
                img.src = professional.photo_base64;
                img.alt = professional.name;
                avatar.appendChild(img);
            } else if (professional.photo_url) {
                const img = document.createElement('img');
                img.src = professional.photo_url;
                img.alt = professional.name;
                avatar.appendChild(img);
            } else {
                avatar.textContent = professional.initial || '?';
            }

            const name = document.createElement('div');
            name.className = 'professional-card-name';
            name.textContent = professional.name;

            const info = document.createElement('div');
            info.className = 'professional-card-info';
            info.textContent = professional.isAuto ? 'Distribuição inteligente' : 'Selecionar';

            button.appendChild(avatar);
            button.appendChild(name);
            button.appendChild(info);

            button.addEventListener('click', () => {
                selectedProfessionalId = professional.id === '' ? '' : String(professional.id);
                if (professionalSelect) {
                    professionalSelect.value = selectedProfessionalId;
                    professionalSelect.dispatchEvent(new Event('change', { bubbles: true }));
                }
                updateProfessionalCardSelection();
                selectedSlotIso = null;
                if (timeInput) {
                    timeInput.value = '';
                }
                renderSlots([]);
                loadSlots();
                scrollToSection(timeSection);
            });

            return button;
        }

        function updateProfessionalCardSelection() {
            if (!professionalContainer) {
                return;
            }
            const cards = professionalContainer.querySelectorAll('.professional-card');
            cards.forEach(card => {
                card.classList.toggle('selected', card.dataset.professionalId === String(selectedProfessionalId ?? ''));
            });
        }

        function renderSlots(slots) {
            if (!slotList || !slotsInfo) {
                return;
            }

            slotList.innerHTML = '';
            slotsInfo.innerHTML = '<i class="fas fa-info-circle"></i><span>Selecione um serviço, uma data e um profissional para listar os horários disponíveis.</span>';

            if (!selectedServiceId) {
                return;
            }

            if (!selectedDate) {
                slotsInfo.innerHTML = '<i class="fas fa-hand-pointer"></i><span>Selecione uma data no calendário para continuar.</span>';
                return;
            }

            if (selectedProfessionalId === null || selectedProfessionalId === undefined) {
                slotsInfo.innerHTML = '<i class="fas fa-user-clock"></i><span>Escolha um profissional para listar os horários livres.</span>';
                return;
            }

            if (!slots.length) {
                slotsInfo.innerHTML = '<i class="fas fa-calendar-times"></i><span>Nenhum horário disponível para o dia selecionado.</span>';
                return;
            }

            slotsInfo.innerHTML = '<i class="fas fa-clock"></i><span>Escolha um horário disponível para continuar.</span>';

            slots.forEach(slot => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'slot-card';
                button.textContent = slot.time;
                button.dataset.slotStart = slot.start;

                button.addEventListener('click', () => {
                    selectedSlotIso = slot.start;
                    if (timeInput) {
                        timeInput.value = slot.time;
                        timeInput.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    highlightSelectedSlot();
                });

                slotList.appendChild(button);
            });

            highlightSelectedSlot();
        }

        function highlightSelectedSlot() {
            if (!slotList) {
                return;
            }
            const buttons = slotList.querySelectorAll('.slot-card');
            buttons.forEach(button => {
                button.classList.toggle('selected', button.dataset.slotStart === selectedSlotIso);
            });
        }

        function loadSlots() {
            if (!selectedServiceId || (!selectedProfessionalId && selectedProfessionalId !== '') || !selectedDate) {
                renderSlots([]);
                return;
            }

            if (slotsInfo) {
                slotsInfo.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Carregando horários disponíveis...</span>';
            }
            if (slotList) {
                slotList.innerHTML = '';
            }

            const professionalQuery = selectedProfessionalId === '' ? 'any' : selectedProfessionalId;
            const url = `/agendar/${tenantSlug}/api/horarios/?service_id=${selectedServiceId}&professional_id=${professionalQuery}&date=${selectedDate}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const slots = data.slots || [];
                    if (timeInput && timeInput.value) {
                        const matchedSlot = slots.find(slot => slot.time === timeInput.value);
                        selectedSlotIso = matchedSlot ? matchedSlot.start : null;
                    }
                    renderSlots(slots);
                    if (slots.length) {
                        scrollToSection(timeSection);
                    }
                })
                .catch(() => {
                    if (slotsInfo) {
                        slotsInfo.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Erro ao carregar horários. Tente novamente.</span>';
                    }
                });
        }

        serviceCards.forEach(card => {
            card.style.cursor = 'pointer';
            card.setAttribute('role', 'button');
            card.setAttribute('tabindex', '0');
            card.setAttribute('aria-pressed', card.classList.contains('selected') ? 'true' : 'false');
            card.addEventListener('click', () => {
                setService(card.dataset.serviceId);
            });
            card.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    setService(card.dataset.serviceId);
                }
            });
        });

        function initialiseFromForm() {
            const initialServiceId = selectedServiceId;
            const initialProfessionalId = selectedProfessionalId;
            const initialDate = selectedDate;
            const initialTime = timeInput ? timeInput.value : null;

            if (initialServiceId && servicesMap[initialServiceId]) {
                setService(initialServiceId, { scroll: false });

                if (initialProfessionalId !== null && initialProfessionalId !== undefined) {
                    const serviceData = servicesMap[initialServiceId];
                    const professionals = serviceData.professionals || [];
                    const hasProfessional = initialProfessionalId === '' || professionals.some(prof => String(prof.id) === String(initialProfessionalId));
                    if (hasProfessional) {
                        selectedProfessionalId = initialProfessionalId;
                        if (professionalSelect) {
                            professionalSelect.value = initialProfessionalId;
                        }
                        updateProfessionalCardSelection();
                    }
                }
            }

            if (initialDate) {
                selectedDate = initialDate;
                if (dateInput) {
                    dateInput.value = initialDate;
                }
                if (calendarInstance) {
                    calendarInstance.setSelectedDate(initialDate);
                }
            }

            if (initialTime) {
                if (timeInput) {
                    timeInput.value = initialTime;
                }
            }

            renderProfessionalCards();
            highlightSelectedSlot();
            if (selectedServiceId && selectedDate && (selectedProfessionalId !== null)) {
                loadSlots();
            }
        }

        class BookingCalendar {
            constructor(options) {
                this.monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                this.dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                this.currentDate = options.initialDate ? new Date(options.initialDate) : new Date();
                this.selectedDate = options.selectedDate ? new Date(options.selectedDate) : null;
                this.minDate = options.minDate ? new Date(options.minDate) : new Date();
                this.monthLabel = options.monthLabel;
                this.grid = options.grid;
                this.onSelect = options.onSelect;
                options.prevBtn.addEventListener('click', () => this.changeMonth(-1));
                options.nextBtn.addEventListener('click', () => this.changeMonth(1));
                this.render();
            }

            changeMonth(delta) {
                this.currentDate.setMonth(this.currentDate.getMonth() + delta);
                this.render();
            }

            clearSelection() {
                this.selectedDate = null;
                this.render();
            }

            setSelectedDate(dateStr) {
                this.selectedDate = new Date(dateStr);
                this.currentDate = new Date(dateStr);
                this.render();
            }

            render() {
                const month = this.currentDate.getMonth();
                const year = this.currentDate.getFullYear();
                this.monthLabel.textContent = `${this.monthNames[month]} ${year}`;
                this.grid.innerHTML = '';

            this.dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                this.grid.appendChild(header);
            });

                const firstDay = new Date(year, month, 1);
                const startDay = firstDay.getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 0; i < startDay; i++) {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'calendar-day disabled other-month';
                    this.grid.appendChild(placeholder);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const cell = document.createElement('div');
                    cell.className = 'calendar-day';
                    cell.textContent = day;

                    const isoDate = date.toISOString().split('T')[0];
                    const minDateIso = this.minDate.toISOString().split('T')[0];
                    if (isoDate < minDateIso) {
                        cell.classList.add('disabled');
                    } else {
                        cell.addEventListener('click', () => {
                            this.selectedDate = date;
                            this.render();
                            if (typeof this.onSelect === 'function') {
                                this.onSelect(isoDate);
                            }
                        });
                    }

                    if (this.selectedDate && this.isSameDate(date, this.selectedDate)) {
                        cell.classList.add('selected');
                    }

                    const today = new Date();
                    if (this.isSameDate(date, today)) {
                        cell.classList.add('today');
                    }

                    this.grid.appendChild(cell);
                }
            }

            isSameDate(a, b) {
                return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
            }
        }

        calendarInstance = new BookingCalendar({
            initialDate: selectedDate || todayString,
            selectedDate: selectedDate,
            minDate: todayString,
            monthLabel: container.querySelector('#bmCalendarMonth'),
            grid: container.querySelector('#bmCalendarGrid'),
            prevBtn: container.querySelector('#bmCalendarPrev'),
            nextBtn: container.querySelector('#bmCalendarNext'),
            onSelect: (isoDate) => {
                selectedDate = isoDate;
                if (dateInput) {
                    dateInput.value = isoDate;
                    dateInput.dispatchEvent(new Event('change', { bubbles: true }));
                }
                resetProfessionalSelection();
                renderProfessionalCards();
                loadSlots();
                scrollToSection(professionalSection);
            }
        });

        initialiseFromForm();
    };

    window.initializeDashboardBookingModal();
</script>
</div>
