{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}Políticas de Agendamento{% endblock %}

{% block extra_head %}
<style>
    .data-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-section {
        margin-bottom: 1.5rem;
    }

    .form-section-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: #111827;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-group label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.375rem;
        font-size: 0.875rem;
    }
    
    .help-text {
        display: block;
        color: #6b7280;
        font-size: 0.8125rem;
        margin-top: 0.375rem;
    }
    
    .toggle-wrapper {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
    }
    
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #d1d5db;
        transition: background-color 0.2s;
        border-radius: 24px;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: left 0.2s;
        border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
        background-color: #22c55e;
    }
    
    input:checked + .toggle-slider:before {
        left: 22px;
    }
    
    .toggle-label {
        font-weight: 600;
        color: #374151;
        font-size: 0.875rem;
        flex: 1;
    }
    
    .input-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .form-control {
        width: 100%;
        padding: 0.625rem;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 0.875rem;
        background: white;
        font-family: inherit;
        color: #111827;
        transition: border-color 0.2s;
    }
    
    .form-control:hover {
        border-color: #d1d5db;
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--brand-primary);
    }
    
    .form-control:disabled {
        background-color: #f3f4f6;
        color: #9ca3af;
        cursor: not-allowed;
    }
    
    .conditional-fields {
        margin-left: 1rem;
        padding-left: 1rem;
        border-left: 1px solid #e5e7eb;
        margin-top: 0.75rem;
    }
    
    .conditional-fields.hidden {
        display: none;
    }
    
    .form-actions {
        display: flex;
        gap: 0.75rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e5e7eb;
        margin-top: 1.5rem;
    }
    
    .btn-primary {
        padding: 0.625rem 1.25rem;
        background: var(--brand-primary);
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: opacity 0.2s;
    }
    
    .btn-primary:hover {
        opacity: 0.9;
    }

    .btn-cancel {
        padding: 0.625rem 1.25rem;
        background: white;
        color: #6b7280;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        text-decoration: none;
    }

    .btn-cancel:hover {
        border-color: #d1d5db;
    }
    
    .alert {
        padding: 0.75rem 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border: 1px solid;
    }
    
    .alert-success {
        background-color: #dcfce7;
        color: #166534;
        border-color: #86efac;
    }
    
    .alert-info {
        background-color: #dbeafe;
        color: #1e40af;
        border-color: #93c5fd;
    }

    @media (max-width: 768px) {
        .input-group {
            grid-template-columns: 1fr;
        }

        .data-card {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Políticas de Agendamento</h1>
    </div>
</div>

<div class="data-card">
    {% csrf_token %}
    
    <!-- Cancelamento -->
    <div class="form-section">
        <h3 class="form-section-title">Cancelamento de Agendamentos</h3>
        
        <div class="toggle-wrapper">
            <label class="toggle-switch">
                <input type="checkbox" name="allow_cancellation" id="allowCancellation" 
                       {% if policy.allow_cancellation %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <label for="allowCancellation" class="toggle-label">
                Permitir que clientes cancelem agendamentos
            </label>
        </div>
        
        <div class="conditional-fields" id="cancellationFields">
            <div class="form-group">
                <label for="minCancellationHours">
                    Antecedência mínima para cancelamento (em horas)
                </label>
                <input type="number" 
                       class="form-control" 
                       id="minCancellationHours"
                       name="min_cancellation_hours" 
                       value="{{ policy.min_cancellation_hours }}"
                       min="0"
                       step="1">
                <span class="help-text">
                    Cliente deve cancelar com pelo menos X horas de antecedência. Digite 0 para permitir cancelamento até o horário do agendamento.
                </span>
            </div>
            
            <div class="input-group">
                <div class="form-group">
                    <label for="maxCancellations">
                        Limite de cancelamentos
                    </label>
                    <input type="number" 
                           class="form-control" 
                           id="maxCancellations"
                           name="max_cancellations" 
                           value="{{ policy.max_cancellations }}"
                           min="0"
                           step="1">
                    <span class="help-text">
                        Número máximo de cancelamentos permitidos. Digite 0 para ilimitado.
                    </span>
                </div>
                
                <div class="form-group">
                    <label for="cancellationPeriodDays">
                        Período de contagem (em dias)
                    </label>
                    <input type="number" 
                           class="form-control" 
                           id="cancellationPeriodDays"
                           name="cancellation_period_days" 
                           value="{{ policy.cancellation_period_days }}"
                           min="1"
                           step="1">
                    <span class="help-text">
                        Período para contar os cancelamentos (ex: 30 dias).
                    </span>
                </div>
            </div>
            
            <div class="toggle-wrapper">
                <label class="toggle-switch">
                    <input type="checkbox" name="require_cancellation_reason" id="requireReason"
                           {% if policy.require_cancellation_reason %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
                <label for="requireReason" class="toggle-label">
                    Exigir motivo do cancelamento
                </label>
            </div>
        </div>
    </div>
    
    <!-- Reagendamento -->
    <div class="form-section">
        <h3 class="form-section-title">Reagendamento</h3>
        
        <div class="toggle-wrapper">
            <label class="toggle-switch">
                <input type="checkbox" name="allow_rescheduling" id="allowRescheduling"
                       {% if policy.allow_rescheduling %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <label for="allowRescheduling" class="toggle-label">
                Permitir que clientes reagendem seus agendamentos
            </label>
        </div>
        
        <div class="conditional-fields" id="reschedulingFields">
            <div class="form-group">
                <label for="minRescheduleHours">
                    Antecedência mínima para reagendamento (em horas)
                </label>
                <input type="number" 
                       class="form-control" 
                       id="minRescheduleHours"
                       name="min_reschedule_hours" 
                       value="{{ policy.min_reschedule_hours }}"
                       min="0"
                       step="1">
                <span class="help-text">
                    Cliente deve reagendar com pelo menos X horas de antecedência.
                </span>
            </div>
            
            <div class="input-group">
                <div class="form-group">
                    <label for="maxReschedulesPerBooking">
                        Limite de reagendamentos por agendamento
                    </label>
                    <input type="number" 
                           class="form-control" 
                           id="maxReschedulesPerBooking"
                           name="max_reschedules_per_booking" 
                           value="{{ policy.max_reschedules_per_booking }}"
                           min="0"
                           step="1">
                    <span class="help-text">
                        Quantas vezes o mesmo agendamento pode ser reagendado. Digite 0 para ilimitado.
                    </span>
                </div>
                
                <div class="form-group">
                    <label for="rescheduleWindowDays">
                        Janela de reagendamento (em dias)
                    </label>
                    <input type="number" 
                           class="form-control" 
                           id="rescheduleWindowDays"
                           name="reschedule_window_days" 
                           value="{{ policy.reschedule_window_days }}"
                           min="0"
                           step="1">
                    <span class="help-text">
                        Número máximo de dias no futuro que o cliente pode reagendar. Digite 0 para sem limite.
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Penalidades -->
    <div class="form-section">
        <h3 class="form-section-title">Penalidades e Notificações</h3>
        
        <div class="toggle-wrapper">
            <label class="toggle-switch">
                <input type="checkbox" name="block_on_limit_reached" id="blockOnLimit"
                       {% if policy.block_on_limit_reached %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <label for="blockOnLimit" class="toggle-label">
                Bloquear cliente ao atingir limite de cancelamentos
            </label>
        </div>
        
        <div class="conditional-fields" id="blockFields">
            <div class="form-group">
                <label for="blockDurationDays">
                    Duração do bloqueio (em dias)
                </label>
                <input type="number" 
                       class="form-control" 
                       id="blockDurationDays"
                       name="block_duration_days" 
                       value="{{ policy.block_duration_days }}"
                       min="1"
                       step="1">
                <span class="help-text">
                    Por quantos dias o cliente ficará impossibilitado de fazer novos agendamentos.
                </span>
            </div>
        </div>
        
        <div class="toggle-wrapper">
            <label class="toggle-switch">
                <input type="checkbox" name="notify_manager_on_abuse" id="notifyManager"
                       {% if policy.notify_manager_on_abuse %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <label for="notifyManager" class="toggle-label">
                Notificar gerente sobre cancelamentos excessivos
            </label>
        </div>
    </div>
    
    <div class="form-actions">
        <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i> Salvar Configurações
        </button>
        <a href="{% url 'dashboard:index' %}" class="btn-cancel">Cancelar</a>
    </div>
</form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const allowCancellation = document.getElementById('allowCancellation');
    const cancellationFields = document.getElementById('cancellationFields');
    const allowRescheduling = document.getElementById('allowRescheduling');
    const reschedulingFields = document.getElementById('reschedulingFields');
    const blockOnLimit = document.getElementById('blockOnLimit');
    const blockFields = document.getElementById('blockFields');
    
    // Toggle cancellation fields
    function toggleCancellationFields() {
        if (allowCancellation.checked) {
            cancellationFields.classList.remove('hidden');
            // Enable all inputs inside
            cancellationFields.querySelectorAll('input').forEach(input => {
                input.disabled = false;
            });
        } else {
            cancellationFields.classList.add('hidden');
            // Disable all inputs inside
            cancellationFields.querySelectorAll('input').forEach(input => {
                input.disabled = true;
            });
        }
    }
    
    // Toggle rescheduling fields
    function toggleReschedulingFields() {
        if (allowRescheduling.checked) {
            reschedulingFields.classList.remove('hidden');
            reschedulingFields.querySelectorAll('input').forEach(input => {
                input.disabled = false;
            });
        } else {
            reschedulingFields.classList.add('hidden');
            reschedulingFields.querySelectorAll('input').forEach(input => {
                input.disabled = true;
            });
        }
    }
    
    // Toggle block duration field
    function toggleBlockFields() {
        if (blockOnLimit.checked) {
            blockFields.classList.remove('hidden');
            blockFields.querySelectorAll('input').forEach(input => {
                input.disabled = false;
            });
        } else {
            blockFields.classList.add('hidden');
            blockFields.querySelectorAll('input').forEach(input => {
                input.disabled = true;
            });
        }
    }
    
    // Initial state
    toggleCancellationFields();
    toggleReschedulingFields();
    toggleBlockFields();
    
    // Event listeners
    allowCancellation.addEventListener('change', toggleCancellationFields);
    allowRescheduling.addEventListener('change', toggleReschedulingFields);
    blockOnLimit.addEventListener('change', toggleBlockFields);
    
    // Form validation
    document.getElementById('policiesForm').addEventListener('submit', function(e) {
        let isValid = true;
        
        // Validate cancellation fields if enabled
        if (allowCancellation.checked) {
            const maxCancellations = parseInt(document.getElementById('maxCancellations').value);
            const periodDays = parseInt(document.getElementById('cancellationPeriodDays').value);
            
            if (maxCancellations > 0 && periodDays <= 0) {
                alert('Se você definir um limite de cancelamentos, precisa definir o período de contagem.');
                isValid = false;
            }
        }
        
        // Validate rescheduling fields if enabled
        if (allowRescheduling.checked) {
            const maxReschedules = parseInt(document.getElementById('maxReschedulesPerBooking').value);
            
            if (maxReschedules < 0) {
                alert('O limite de reagendamentos não pode ser negativo.');
                isValid = false;
            }
        }
        
        // Validate block duration if enabled
        if (blockOnLimit.checked) {
            const blockDuration = parseInt(document.getElementById('blockDurationDays').value);
            
            if (blockDuration <= 0) {
                alert('A duração do bloqueio deve ser maior que zero.');
                isValid = false;
            }
        }
        
        if (!isValid) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}
