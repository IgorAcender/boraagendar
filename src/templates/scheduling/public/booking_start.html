{% extends "scheduling/public/base_public.html" %}
{% block title %}Agendar Horário{% endblock %}

{% block progress %}
{% if selected_service %}
<!-- Breadcrumb simples -->
<div style="padding: 1rem 0; color: var(--text-light); font-size: 0.875rem; opacity: 0.7;">
    <a href="?service=" style="color: var(--text-light); text-decoration: none; opacity: 0.7;">← Voltar aos {{ tenant.label_servico_plural }}</a>
    <span style="margin: 0 0.5rem;">›</span>
    <span style="color: var(--brand-primary); font-weight: 600;">{{ selected_service.name }}</span>
</div>
{% endif %}
{% endblock %}

{% block extra_head %}
<style>
    :root {
        --brand-primary: {{ branding.button_color_primary|default:"#667eea" }};
        --brand-secondary: {{ branding.button_color_secondary|default:"#764ba2" }};
        --bg-dark: {{ branding.background_color|default:"#0f172a" }};
        --text-light: {{ branding.text_color|default:"#e2e8f0" }};
        --highlight-color: {{ branding.highlight_color|default:"#FBBF24" }};
    }

    .form-section {
        margin-bottom: 2rem;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-light);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .section-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        color: var(--text-light);
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .form-group select,
    .form-group input {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid color-mix(in srgb, var(--text-light) 20%, transparent);
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.2s;
        background: var(--bg-dark);
        color: var(--text-light);
    }

    .form-group select:focus,
    .form-group input:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn-search {
        width: 100%;
        padding: 1rem;
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .btn-search:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    /* Available Slots */
    .slots-section {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 2px solid #e2e8f0;
    }

    .slots-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
        margin-top: 1.5rem;
    }

    @media (max-width: 768px) {
        .slots-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }
    }

    .slot-card {
        background: #ffffff;
        border: 3px solid #cbd5e1 !important;
        border-radius: 14px;
        padding: 0.875rem 0.5rem !important;
        text-align: center;
        transition: all 0.2s;
        cursor: pointer;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        min-height: 48px;
        box-shadow: none;
        text-decoration: none !important;
        box-sizing: border-box;
    }

    .slot-card:hover {
        background: #f8fafc;
        border-color: var(--brand-primary);
        border-width: 4px;
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
    }

    .slot-card:active {
        transform: scale(0.98);
        box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
    }

    .slot-time {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-light);
        line-height: 1.2;
        margin: 0 !important;
        padding: 0 !important;
        width: 100%;
        display: inline-block;
        vertical-align: middle;
        text-align: center;
    }

    /* Ajustar fonte em mobile para caber melhor */
    @media (max-width: 768px) {
        .slot-time {
            font-size: 0.875rem;
        }
    }

    .slot-date {
        display: none; /* Ocultar data no layout compacto */
    }

    .slot-professional {
        display: none; /* Ocultar profissional no layout compacto */
    }

    /* Calendar Widget Styles */
    .calendar-widget {
        background: var(--bg-dark);
        border: 2px solid color-mix(in srgb, var(--text-light) 20%, transparent);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        max-width: 100%;
        overflow: hidden;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid color-mix(in srgb, var(--text-light) 20%, transparent);
    }

    .calendar-month {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-light);
        text-align: center;
        flex: 1;
    }

    .calendar-nav {
        display: flex;
        gap: 0.5rem;
    }

    .calendar-nav-btn {
        width: 36px;
        height: 36px;
        border: none;
        background: color-mix(in srgb, var(--text-light) 15%, transparent);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--text-light);
        flex-shrink: 0;
    }

    .calendar-nav-btn:hover {
        background: var(--brand-primary);
        color: white;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        width: 100%;
        max-width: 100%;
    }

    .calendar-day-header {
        text-align: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: rgba(var(--text-light), 0.6);
        padding: 0.75rem 0.25rem;
        text-transform: uppercase;
        background: #f8fafc;
        border-radius: 4px;
        margin-bottom: 4px;
    }

    .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
        border: 2px solid transparent;
        min-height: 40px;
        font-size: 0.9rem;
        max-width: 100%;
        overflow: hidden;
        box-sizing: border-box;
    }

    .calendar-day:hover {
        background: #f1f5f9;
    }

    .calendar-day.disabled {
        color: #cbd5e1;
        cursor: not-allowed;
        background: #f8fafc;
    }

    .calendar-day.disabled:hover {
        background: #f8fafc;
    }

    .calendar-day.other-month {
        color: #cbd5e1;
    }

    .calendar-day.selected {
        background: var(--brand-primary);
        color: white;
        border-color: var(--brand-primary);
        font-weight: 700;
    }

    .calendar-day.today {
        border-color: var(--brand-primary);
        color: var(--brand-primary);
        font-weight: 700;
    }

    .calendar-day.today.selected {
        background: var(--brand-primary);
        color: white;
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
        .calendar-widget {
            padding: 1rem;
        }
        
        .calendar-day {
            min-height: 36px;
            font-size: 0.85rem;
        }
        
        .calendar-day-header {
            font-size: 0.7rem;
            padding: 0.5rem 0.125rem;
        }
        
        .calendar-month {
            font-size: 1.1rem;
        }
    }

    /* Hide the native date input */
    #date_input {
        display: none;
    }
        /* Estilos aplicados no .slot-card acima */
    }

    a.slot-card {
        color: var(--text-light) !important;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
    }

    .empty-icon {
        width: 100px;
        height: 100px;
        margin: 0 auto 1.5rem;
        background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        color: #9ca3af;
    }

    .empty-state h3 {
        font-size: 1.25rem;
        color: rgba(var(--text-light), 0.7);
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: rgba(var(--text-light), 0.5);
    }

    /* Professionals Grid */
    .professionals-section {
        margin-top: 2rem;
    }

    .professionals-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        padding: 1rem 0;
        margin-top: 1rem;
        max-width: 100%;
    }

    /* Em telas pequenas, 3 colunas */
    @media (max-width: 480px) {
        .professionals-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }
    }

    .professional-card {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 0.75rem;
        text-align: center;
        transition: all 0.3s;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        box-sizing: border-box;
    }

    .professional-card:hover {
        border-color: var(--brand-primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .professional-card.selected {
        border-color: var(--brand-primary);
        border-width: 3px;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .professional-card-avatar {
        width: 60px;
        height: 60px;
        margin: 0 auto 0.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* Ajustar avatar no mobile */
    @media (max-width: 480px) {
        .professional-card-avatar {
            width: 50px;
            height: 50px;
            font-size: 1.25rem;
        }
    }

    .professional-card-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }

    .professional-card-name {
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--text-light);
        margin-top: 0.25rem;
        white-space: normal;
        word-wrap: break-word;
        line-height: 1.2;
        height: auto;
        width: 100%;
        text-align: center;
    }

    /* Ajustar fonte do nome no mobile */
    @media (max-width: 480px) {
        .professional-card-name {
            font-size: 0.65rem;
            line-height: 1.1;
        }
    }

    .professional-card-bio {
        display: none; /* Ocultar bio no layout compacto */
    }

    .btn-select-professional {
        display: none; /* Ocultar boto no layout compacto */
    }

    /* Date Selection Section */
    .date-selection-section {
        margin-top: 2rem;
    }

    .date-selection-section .form-group {
        margin-bottom: 0;
    }

    .date-selection-section input[type="date"] {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.2s;
        background: white;
        color: #1e293b;
        box-sizing: border-box;
    }

    .date-selection-section input[type="date"]:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* Unified container for date + professional + slots */
    .booking-container {
        display: grid;
        gap: 2rem;
        margin-top: 2rem;
    }

    .section-divider {
        height: 1px;
        background: linear-gradient(90deg, transparent, color-mix(in srgb, var(--text-light) 20%, transparent), transparent);
        margin: 1.5rem 0;
    }

    /* Estilo para os blocos de serviços */
    .services-grid {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 0.5rem !important;
        margin-top: 1rem !important;
        width: 100% !important;
        position: relative !important;
        z-index: 1 !important;
    }

    .service-category-group {
        margin-bottom: 2rem !important;
    }

    .service-category-title {
        font-size: 1rem !important;
        font-weight: 700 !important;
        color: var(--text-light) !important;
        margin-bottom: 0.75rem !important;
    }

    .service-category-grid {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 0.5rem !important;
    }

    .service-card {
        background: white !important;
        border: 2px solid #e2e8f0 !important;
        border-radius: 12px !important;
        padding: 0.75rem !important;
        transition: all 0.3s !important;
        cursor: pointer !important;
        text-decoration: none !important;
        color: inherit !important;
        display: flex !important;
        align-items: flex-start !important;
        gap: 0.75rem !important;
        margin-bottom: 0.75rem !important;
        min-height: auto !important;
        box-shadow: none !important;
        position: relative !important;
        width: 100% !important;
        box-sizing: border-box !important;
        visibility: visible !important;
        opacity: 1 !important;
        transform: translateZ(0) !important;
        overflow: visible !important;
    }

    .service-card:hover {
        border-color: var(--brand-primary) !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15) !important;
    }

    .service-card.selected {
        border-color: var(--brand-primary) !important;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08)) !important;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2) !important;
    }

    .service-card-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .service-card-image {
        width: 60px;
        height: 60px;
        flex-shrink: 0;
        background: #f1f5f9;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
    }

    .service-name {
        font-size: 0.95rem !important;
        font-weight: 700 !important;
        color: var(--text-light) !important;
        margin-bottom: 0.25rem !important;
        display: block !important;
    }

    .service-meta {
        display: flex !important;
        gap: 0.75rem !important;
        align-items: center !important;
        font-size: 0.8rem !important;
        color: rgba(var(--text-light), 0.6) !important;
    }

    .service-price {
        font-weight: 600 !important;
        color: var(--brand-primary) !important;
    }

    .service-duration {
        display: flex !important;
        align-items: center !important;
        gap: 0.25rem !important;
    }

    .service-description {
        margin-top: 0.25rem !important;
        color: #94a3b8 !important;
        font-size: 0.75rem !important;
        line-height: 1.3 !important;
        display: block !important;
    }

    /* Esconder o select original */
    .hidden-select {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Service Selection -->
{% if not selected_service %}
<div class="form-section">
    <h2 class="section-title">
        <div class="section-icon">
            <i class="fas fa-concierge-bell"></i>
        </div>
        {{ tenant.label_servico }}
    </h2>

    <form method="get" id="serviceForm">
        <div class="form-group">
            <label for="id_service">Qual {{ tenant.label_servico|lower }} Você deseja?</label>
            <!-- Escondemos o select original, mas mantemos para compatibilidade com o backend -->
            <div class="hidden-select">
                {{ form.service }}
            </div>
            <div class="services-grid" id="servicesGrid" data-rendered="server">
                {% if has_service_categories %}
                    {% regroup services by category as service_categories %}
                    {% for category in service_categories %}
                    <div class="service-category-group">
                        <div class="service-category-title">
                            {% if category.grouper %}
                                {{ category.grouper }}
                            {% else %}
                                Outros {{ tenant.label_servico_plural|lower }}
                            {% endif %}
                        </div>
                        <div class="service-category-grid">
                            {% for service in category.list %}
                            <div class="service-card" data-service-id="{{ service.id }}" onclick="window.location.href='?service={{ service.id }}'">
                                <div class="service-card-image">
                                    {% if service.photo %}
                                        <img src="{{ service.photo.url }}" alt="{{ service.name }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                                    {% else %}
                                        <i class="fas fa-scissors"></i>
                                    {% endif %}
                                </div>
                                <div class="service-card-content">
                                    <div class="service-name">{{ service.name }}</div>
                                    <div class="service-meta">
                                        <span class="service-price">R$ {{ service.price|floatformat:2 }}</span>
                                        <span class="service-duration">
                                            <i class="fas fa-clock" style="font-size: 0.7rem;"></i>
                                            {{ service.duration_minutes|default:"60" }} min
                                        </span>
                                    </div>
                                    {% if service.description %}
                                    <div class="service-description">{{ service.description }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-concierge-bell"></i>
                        </div>
                        <h3>Nenhum serviço disponível</h3>
                        <p>Entre em contato para verificar nossos serviços.</p>
                    </div>
                    {% endfor %}
                {% else %}
                    {% for service in services %}
                    <div class="service-card" data-service-id="{{ service.id }}" onclick="window.location.href='?service={{ service.id }}'">
                        <div class="service-card-image">
                            {% if service.photo %}
                                <img src="{{ service.photo.url }}" alt="{{ service.name }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                            {% else %}
                                <i class="fas fa-scissors"></i>
                            {% endif %}
                        </div>
                        <div class="service-card-content">
                            <div class="service-name">{{ service.name }}</div>
                            <div class="service-meta">
                                <span class="service-price">R$ {{ service.price|floatformat:2 }}</span>
                                <span class="service-duration">
                                    <i class="fas fa-clock" style="font-size: 0.7rem;"></i>
                                    {{ service.duration_minutes|default:"60" }} min
                                </span>
                            </div>
                            {% if service.description %}
                            <div class="service-description">{{ service.description }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-concierge-bell"></i>
                        </div>
                        <h3>Nenhum serviço disponível</h3>
                        <p>Entre em contato para verificar nossos serviços.</p>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </form>
</div>
{% endif %}

<!-- Unified Booking Container (shown only after service selection) -->
{% if selected_service %}
<div class="booking-container">
    <!-- Date Selection -->
    <div class="date-selection-section">
        <h2 class="section-title">
            <div class="section-icon">
                <i class="fas fa-calendar"></i>
            </div>
            Data
        </h2>
        <div class="form-group">
            <label for="date_input">Qual data Você prefere?</label>
            
            <!-- Calendar Widget -->
            <div class="calendar-widget">
                <div class="calendar-header">
                    <div class="calendar-month" id="calendar-month-year"></div>
                    <div class="calendar-nav">
                        <button type="button" class="calendar-nav-btn" id="prev-month">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button type="button" class="calendar-nav-btn" id="next-month">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="calendar-grid" id="calendar-grid">
                    <!-- Calendar content will be generated by JavaScript -->
                </div>
            </div>
            
            <!-- Hidden native date input for form submission -->
            <input type="date" id="date_input" name="date"
                   value="{{ selected_date|date:'Y-m-d' }}"
                   min="{{ today|date:'Y-m-d' }}">
        </div>
    </div>

    <!-- Professional Selection -->
    {% if available_professionals %}
    <div class="professionals-section">
        <h2 class="section-title">
            <div class="section-icon">
                <i class="fas fa-users"></i>
            </div>
            {{ tenant.label_profissional }}
        </h2>

        <div class="professionals-grid">
            {% if has_auto_assign_professionals %}
            <!-- Opção: Qualquer Profissional -->
            <div class="professional-card professional-card-any"
                 data-professional-id="any">
                <div class="professional-card-avatar" style="background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));">
                    <i class="fas fa-users" style="font-size: 1.5rem; color: white;"></i>
                </div>
                <div class="professional-card-name" style="color: var(--brand-primary); font-weight: 700;">
                    Sem<br>Preferência
                </div>
            </div>
            {% endif %}
            {% for professional in available_professionals %}
            <div class="professional-card"
                 data-professional-id="{{ professional.id }}">
                <div class="professional-card-avatar" style="background: {{ professional.color }};">
                    {% if professional.photo_base64 %}
                        <img src="{{ professional.photo_base64 }}" alt="{{ professional.display_name }}">
                    {% elif professional.photo %}
                        <img src="{{ professional.photo.url }}" alt="{{ professional.display_name }}">
                    {% else %}
                        {{ professional.display_name|first|upper }}
                    {% endif %}
                </div>
                <div class="professional-card-name">{{ professional.display_name }}</div>
                {% if professional.bio %}
                <div class="professional-card-bio">{{ professional.bio }}</div>
                {% endif %}
                <div class="btn-select-professional">
                    <i class="fas fa-calendar-check"></i> Selecionar
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Time Slots Section -->
    <div class="slots-section" id="slotsContainer">
        {% if available_slots %}
        <h2 class="section-title">
            <div class="section-icon">
                <i class="fas fa-clock"></i>
            </div>
            Horários disponíveis
        </h2>

        <div class="slots-grid">
            {% for slot in available_slots %}
            <a class="slot-card btn-book"
               href="{% url 'public:booking_confirm' tenant_slug=tenant.slug %}?service={{ selected_service.id }}&professional={% if selected_professional %}{{ selected_professional.id }}{% else %}any{% endif %}&start={{ slot.start|date:'c' }}">
                <div class="slot-time">{{ slot.start|time:"H:i" }}</div>
            </a>
            {% endfor %}
        </div>
        {% elif selected_date %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-calendar-times"></i>
            </div>
            <h3>Nenhum Horário disponível</h3>
            <p>Não encontramos Horários disponíveis para a data selecionada. Tente outra data.</p>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-hand-pointer"></i>
            </div>
            <h3>Selecione uma data</h3>
            <p>Escolha uma data acima para ver os Horários disponíveis</p>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const serviceSelect = document.getElementById('id_service');
        const dateInput = document.getElementById('date_input');
        const tenantSlug = '{{ tenant.slug }}';
        const labelProfissional = '{{ tenant.label_profissional }}';
        
        // Capturar valores do contexto Django
        let selectedServiceId = '{% if selected_service %}{{ selected_service.id }}{% else %}{% endif %}';
        let selectedProfessionalId = '{% if selected_professional %}{{ selected_professional.id }}{% else %}any{% endif %}';
        let selectedDate = '{% if selected_date %}{{ selected_date|date:"Y-m-d" }}{% else %}{% endif %}';
        
        console.log('=== INITIAL VALUES ===');
        console.log('Selected Service ID:', selectedServiceId);
        console.log('Selected Professional ID:', selectedProfessionalId);
        console.log('Selected Date:', selectedDate);        // Calendar Widget Implementation
        class CustomCalendar {
            constructor() {
                this.currentDate = new Date();
                this.selectedDate = selectedDate ? new Date(selectedDate) : null;
                this.minDate = new Date('{{ today|date:"Y-m-d" }}');
                this.monthNames = [
                    'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                this.dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                this.init();
            }

            init() {
                this.render();
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('prev-month').addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                    this.render();
                });

                document.getElementById('next-month').addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                    this.render();
                });
            }

            render() {
                this.renderHeader();
                this.renderGrid();
            }

            renderHeader() {
                const monthYear = document.getElementById('calendar-month-year');
                monthYear.textContent = `${this.monthNames[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;
            }

            renderGrid() {
                const grid = document.getElementById('calendar-grid');
                grid.innerHTML = '';

                // Add day headers
                this.dayNames.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'calendar-day-header';
                    dayHeader.textContent = day;
                    grid.appendChild(dayHeader);
                });

                // Get first day of month and number of days
                const firstDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), 1);
                const lastDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDay = firstDay.getDay();

                // Add empty cells for days before month starts
                for (let i = 0; i < startingDay; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day other-month';
                    grid.appendChild(emptyDay);
                }

                // Add days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    dayElement.textContent = day;

                    const cellDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), day);
                    const cellDateString = cellDate.toISOString().split('T')[0];

                    // Check if day is disabled (before min date)
                    if (cellDate < this.minDate) {
                        dayElement.classList.add('disabled');
                    } else {
                        dayElement.addEventListener('click', () => {
                            this.selectDate(cellDate);
                        });
                    }

                    // Check if day is today
                    const today = new Date();
                    if (cellDate.toDateString() === today.toDateString()) {
                        dayElement.classList.add('today');
                    }

                    // Check if day is selected
                    if (this.selectedDate && cellDate.toDateString() === this.selectedDate.toDateString()) {
                        dayElement.classList.add('selected');
                    }

                    grid.appendChild(dayElement);
                }
            }

            selectDate(date) {
                this.selectedDate = date;
                const dateString = date.toISOString().split('T')[0];
                
                // Update hidden input
                dateInput.value = dateString;
                
                // Update selected date variable
                selectedDate = dateString;
                
                // Trigger change event to reload times
                dateInput.dispatchEvent(new Event('change'));
                
                // Re-render to show selection
                this.render();
            }
        }

        // Initialize calendar
        const calendar = new CustomCalendar();
        
        {% if not selected_service %}
        // Função para criar os cards de serviço
        function createServiceCards() {
            console.log('createServiceCards() chamada');

            const serviceSelect = document.getElementById('id_service');
            const servicesGrid = document.getElementById('servicesGrid');

            if (servicesGrid && servicesGrid.dataset.rendered === 'server') {
                console.log('Serviços renderizados no servidor; pulando renderização dinâmica.');
                return;
            }

            console.log('serviceSelect:', serviceSelect);
            console.log('servicesGrid:', servicesGrid);

            if (!serviceSelect || !servicesGrid) {
                console.error('Elementos necessários não encontrados');
                console.error('serviceSelect existe?', !!serviceSelect);
                console.error('servicesGrid existe?', !!servicesGrid);
                return;
            }

            const options = Array.from(serviceSelect.options);
            console.log('Total de options:', options.length);

            servicesGrid.innerHTML = '';

            // Filtrar opções válidas (ignorar opções vazias)
            const validOptions = options.filter(opt => opt.value && opt.value !== '');
            console.log('Valid options:', validOptions.length);
            console.log('Valid options:', validOptions.map(o => ({ value: o.value, text: o.text })));

            if (validOptions.length === 0) {
                console.log('Nenhum serviço válido encontrado, mostrando empty state');
                // Nenhum serviço disponível
                servicesGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-concierge-bell"></i>
                        </div>
                        <h3>Nenhum serviço disponível</h3>
                        <p>Entre em contato para verificar nossos serviços.</p>
                    </div>
                `;
                return;
            }

            console.log('Criando', validOptions.length, 'cards...');

            // Criar cards para cada serviço
            validOptions.forEach((option, index) => {
                console.log(`Criando card ${index + 1}:`, option.text);

                const serviceCard = document.createElement('div');
                serviceCard.className = 'service-card';
                serviceCard.dataset.serviceId = option.value;

                // Extrair nome do serviço (remover info extra entre parênteses)
                const serviceText = option.text;
                const serviceName = serviceText.split('(')[0].trim();

                serviceCard.innerHTML = `
                    <div class="service-name">${serviceName}</div>
                    <div class="service-description">
                        Clique para selecionar este serviço
                    </div>
                `;

                serviceCard.addEventListener('click', function() {
                    console.log('Card clicado, ID:', this.dataset.serviceId);
                    window.location.href = `?service=${this.dataset.serviceId}`;
                });

                servicesGrid.appendChild(serviceCard);
                console.log(`Card ${index + 1} adicionado ao grid`);
            });

            console.log('Finalizado! Total de cards no grid:', servicesGrid.children.length);
            console.log('Grid HTML:', servicesGrid.innerHTML.substring(0, 200));
        }

        // Executar IMEDIATAMENTE (não esperar DOMContentLoaded pois já estamos dentro dele)
        console.log('=== INICIANDO CRIAÇÃO DE CARDS ===');
        console.log('Timestamp:', new Date().toISOString());

        // Tentar múltiplas vezes para garantir
        // Solução definitiva - aguardar que o select esteja totalmente populado
        function waitForSelectAndCreateCards() {
            console.log('=== WAITING FOR SELECT TO BE READY ===');
            
            const serviceSelect = document.getElementById('id_service');
            if (!serviceSelect) {
                console.error('Select não encontrado, tentando novamente...');
                setTimeout(waitForSelectAndCreateCards, 100);
                return;
            }
            
            // Verificar se o select tem opções válidas
            const validOptions = Array.from(serviceSelect.options).filter(opt => opt.value && opt.value !== '');
            console.log('Opções válidas encontradas:', validOptions.length);
            
            if (validOptions.length === 0) {
                console.log('Select ainda sem opções, aguardando...');
                setTimeout(waitForSelectAndCreateCards, 100);
                return;
            }
            
            // Select está pronto, criar os cards
            console.log('Select pronto com', validOptions.length, 'opções válidas');
            createServiceCards();
            
            // Verificar se os cards foram criados
            setTimeout(() => {
                const grid = document.getElementById('servicesGrid');
                if (grid && grid.children.length === 0) {
                    console.log('Cards não foram criados, tentando novamente...');
                    createServiceCards();
                }
            }, 200);
        }
        
        // Iniciar o processo
        waitForSelectAndCreateCards();
        
        // Sistema adicional de fallback usando MutationObserver
        const observeSelectChanges = () => {
            const serviceSelect = document.getElementById('id_service');
            if (!serviceSelect) return;
            
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        console.log('Mudanças detectadas no select');
                        setTimeout(() => {
                            const validOptions = Array.from(serviceSelect.options).filter(opt => opt.value && opt.value !== '');
                            if (validOptions.length > 0) {
                                console.log('Opções detectadas via observer, criando cards...');
                                createServiceCards();
                                observer.disconnect(); // Parar de observar após sucesso
                            }
                        }, 50);
                    }
                });
            });
            
            observer.observe(serviceSelect, {
                childList: true,
                subtree: true
            });
            
            // Desconectar após 5 segundos para evitar vazamentos de memória
            setTimeout(() => observer.disconnect(), 5000);
        };
        
        observeSelectChanges();
        {% endif %}

        // Função para carregar slots automaticamente
        function autoLoadSlots() {
            console.log('=== AUTO LOAD SLOTS CHECK ===');
            console.log('Has Service:', !!selectedServiceId);
            console.log('Has Professional:', !!selectedProfessionalId);
            console.log('Has Date:', !!selectedDate);
            
            if (selectedDate && selectedServiceId && selectedProfessionalId) {
                console.log('Auto-loading slots with:', { selectedServiceId, selectedProfessionalId, selectedDate });
                loadAvailableSlots(selectedServiceId, selectedProfessionalId, selectedDate);
            } else {
                console.log('Missing data for auto-load, waiting for user selection');
            }
        }

        // Date selection - load slots when date changes
        if (dateInput) {
            dateInput.addEventListener('change', function() {
                console.log('Date changed to:', this.value);
                selectedDate = this.value;
                if (selectedDate && selectedServiceId && selectedProfessionalId) {
                    console.log('Loading slots for date change...');
                    loadAvailableSlots(selectedServiceId, selectedProfessionalId, selectedDate);
                } else {
                    console.log('Missing data after date change:', { selectedDate, selectedServiceId, selectedProfessionalId });
                }
            });
            
            // Auto-load slots if we already have a date
            if (selectedDate) {
                setTimeout(autoLoadSlots, 500);
            }
        }

        // Professional card selection
        const professionalCards = document.querySelectorAll('.professional-card');
        professionalCards.forEach(card => {
            card.addEventListener('click', function(e) {
                e.preventDefault();
                const professionalId = this.dataset.professionalId;
                selectProfessional(professionalId);
            });
        });

        // Auto-select default professional on load
        if (selectedProfessionalId) {
            const initialCard = document.querySelector(`[data-professional-id="${selectedProfessionalId}"]`);
            if (initialCard) {
                initialCard.classList.add('selected');
            }
        } else if (professionalCards.length > 0) {
            // Default to "any" if nothing selected
            const anyCard = document.querySelector('[data-professional-id="any"]');
            if (anyCard) {
                anyCard.classList.add('selected');
                selectedProfessionalId = 'any';
            } else {
                const firstCard = professionalCards[0];
                if (firstCard) {
                    firstCard.classList.add('selected');
                    selectedProfessionalId = firstCard.dataset.professionalId;
                }
            }
        }

        function selectProfessional(professionalId) {
            selectedProfessionalId = professionalId;

            // Update visual selection
            document.querySelectorAll('.professional-card').forEach(card => {
                card.classList.remove('selected');
            });
            const selectedCard = document.querySelector(`[data-professional-id="${professionalId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }

            // Load slots if date is selected
            if (selectedDate && selectedServiceId) {
                loadAvailableSlots(selectedServiceId, professionalId, selectedDate);
            }
        }

        function loadAvailableSlots(serviceId, professionalId, date) {
            console.log('=== LOADING AVAILABLE SLOTS ===');
            console.log('Service ID:', serviceId);
            console.log('Professional ID:', professionalId);
            console.log('Date:', date);
            console.log('Tenant Slug:', tenantSlug);
            
            const url = `/agendar/${tenantSlug}/api/horarios/?service_id=${serviceId}&professional_id=${professionalId}&date=${date}`;
            console.log('API URL:', url);

            fetch(url)
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response OK:', response.ok);
                    return response.json();
                })
                .then(data => {
                    console.log('API Response data:', data);
                    console.log('Slots received:', data.slots ? data.slots.length : 0);
                    if (data.slots) {
                        console.log('First slot example:', data.slots[0]);
                    }
                    renderSlots(data.slots, serviceId, professionalId);
                })
                .catch(error => {
                    console.error('Error loading slots:', error);
                });
        }

        function renderSlots(slots, serviceId, professionalId) {
            console.log('=== RENDERING SLOTS ===');
            console.log('Slots to render:', slots ? slots.length : 0);
            console.log('Service ID:', serviceId);
            console.log('Professional ID:', professionalId);
            
            const slotsContainer = document.getElementById('slotsContainer');
            console.log('Slots container found:', !!slotsContainer);
            
            if (!slotsContainer) {
                console.error('ERRO: slotsContainer não encontrado!');
                return;
            }

            if (!slots || slots.length === 0) {
                console.log('No slots available, showing empty state');
                slotsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <h3>Nenhum Horário disponível</h3>
                        <p>Não encontramos Horários disponíveis para a data selecionada. Tente outra data.</p>
                    </div>
                `;
                return;
            }

            console.log('Building slots HTML...');
            let slotsHTML = `
                <h2 class="section-title">
                    <div class="section-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    Horários disponíveis
                </h2>
                <div class="slots-grid">
            `;

            slots.forEach((slot, index) => {
                console.log(`Slot ${index}:`, slot);
                slotsHTML += `
                    <a class="slot-card btn-book" href="/agendar/${tenantSlug}/confirmar/?service=${serviceId}&professional=${professionalId}&start=${slot.start}">
                        <div class="slot-time">${slot.time}</div>
                    </a>
                `;
            });

            slotsHTML += '</div>';
            console.log('Setting innerHTML, HTML length:', slotsHTML.length);
            slotsContainer.innerHTML = slotsHTML;
            console.log('Slots rendered successfully');
        }
    });
</script>
{% endblock %}
