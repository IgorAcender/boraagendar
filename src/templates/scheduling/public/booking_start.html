{% extends "scheduling/public/base_public.html" %}
{% block title %}Agendar Horário{% endblock %}

{% block progress %}
<div class="progress-steps">
    <div class="progress-line" style="width: {% if selected_service and available_slots %}66%{% elif selected_service %}33%{% else %}0%{% endif %};"></div>

    <div class="step {% if not selected_service %}active{% else %}completed{% endif %}">
        <div class="step-circle">
            {% if selected_service %}<i class="fas fa-check"></i>{% else %}1{% endif %}
        </div>
        <div class="step-label">Escolher Serviço</div>
    </div>

    <div class="step {% if selected_service and not available_slots %}active{% elif available_slots %}completed{% endif %}">
        <div class="step-circle">
            {% if available_slots %}<i class="fas fa-check"></i>{% else %}2{% endif %}
        </div>
        <div class="step-label">Escolher Data</div>
    </div>

    <div class="step {% if available_slots %}active{% endif %}">
        <div class="step-circle">3</div>
        <div class="step-label">Confirmar</div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<style>
    .form-section {
        margin-bottom: 2rem;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .section-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        color: #334155;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .form-group select,
    .form-group input {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.2s;
        background: white;
        color: #1e293b;
    }

    .form-group select:focus,
    .form-group input:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn-search {
        width: 100%;
        padding: 1rem;
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .btn-search:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    /* Available Slots */
    .slots-section {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 2px solid #e2e8f0;
    }

    .slots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
    }

    @media (max-width: 768px) {
        .slots-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }
    }

    .slot-card {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.25rem;
        text-align: center;
        transition: all 0.3s;
        cursor: pointer;
    }

    .slot-card:hover {
        border-color: var(--brand-primary);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
    }

    .slot-time {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.5rem;
    }

    .slot-date {
        font-size: 0.875rem;
        color: #64748b;
        margin-bottom: 1rem;
    }

    .slot-professional {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        font-size: 0.875rem;
        color: #64748b;
        margin-bottom: 1rem;
    }

    .professional-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 700;
        color: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
    }

    .professional-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }

    .professional-name {
        font-weight: 500;
        color: #475569;
    }

    .btn-book {
        width: 100%;
        padding: 0.75rem;
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: all 0.2s;
    }

    .btn-book:hover {
        transform: translateY(-2px);
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
    }

    .empty-icon {
        width: 100px;
        height: 100px;
        margin: 0 auto 1.5rem;
        background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        color: #9ca3af;
    }

    .empty-state h3 {
        font-size: 1.25rem;
        color: #64748b;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: #94a3b8;
    }

    /* Professionals Grid */
    .professionals-section {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 2px solid #e2e8f0;
    }

    .professionals-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
    }

    .professional-card {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 16px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .professional-card:hover {
        border-color: var(--brand-primary);
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
    }

    .professional-card.selected {
        border-color: var(--brand-primary);
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        transform: translateY(-5px);
    }

    .professional-card.selected .btn-select-professional {
        background: linear-gradient(135deg, #10b981, #059669);
    }

    .professional-card-avatar {
        width: 80px;
        height: 80px;
        margin: 0 auto 1rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: 700;
        color: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .professional-card-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }

    .professional-card-name {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.5rem;
    }

    .professional-card-bio {
        font-size: 0.875rem;
        color: #64748b;
        line-height: 1.4;
        margin-bottom: 1rem;
        height: 2.8em;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .btn-select-professional {
        width: 100%;
        padding: 0.625rem;
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .professional-card:hover .btn-select-professional {
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<!-- Form Section -->
<div class="form-section">
    <h2 class="section-title">
        <div class="section-icon">
            <i class="fas fa-concierge-bell"></i>
        </div>
        Escolha o Serviço
    </h2>

    <form method="get" id="serviceForm">
        <div class="form-group">
            <label for="id_service">Qual serviço você deseja?</label>
            {{ form.service }}
        </div>
    </form>
</div>

<!-- Professionals Section -->
{% if available_professionals %}
<div class="professionals-section">
    <h2 class="section-title">
        <div class="section-icon">
            <i class="fas fa-users"></i>
        </div>
        Escolha o Profissional
    </h2>

    <div class="professionals-grid">
        {% for professional in available_professionals %}
        <a href="?service={{ selected_service.id }}&professional={{ professional.id }}&date={{ selected_date|default_if_none:'' }}" class="professional-card">
            <div class="professional-card-avatar" style="background: {{ professional.color }};">
                {% if professional.photo_base64 %}
                    <img src="{{ professional.photo_base64 }}" alt="{{ professional.display_name }}">
                {% elif professional.photo %}
                    <img src="{{ professional.photo.url }}" alt="{{ professional.display_name }}">
                {% else %}
                    {{ professional.display_name|first|upper }}
                {% endif %}
            </div>
            <div class="professional-card-name">{{ professional.display_name }}</div>
            {% if professional.bio %}
            <div class="professional-card-bio">{{ professional.bio }}</div>
            {% endif %}
            <div class="btn-select-professional">
                <i class="fas fa-calendar-check"></i> Selecionar
            </div>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}


<!-- Available Slots Section -->
{% if available_slots %}
<div class="slots-section">
    <h2 class="section-title">
        <div class="section-icon">
            <i class="fas fa-clock"></i>
        </div>
        Horários Disponíveis
    </h2>

    <div class="slots-grid">
        {% for slot in available_slots %}
        <div class="slot-card">
            <div class="slot-time">{{ slot.start|time:"H:i" }}</div>
            <div class="slot-date">{{ slot.start|date:"d/m/Y - l" }}</div>

            {% if slot.professional %}
            <div class="slot-professional">
                <div class="professional-avatar" style="background: {{ slot.professional.color }};">
                    {% if slot.professional.photo_base64 %}
                        <img src="{{ slot.professional.photo_base64 }}" alt="{{ slot.professional.display_name }}">
                    {% elif slot.professional.photo %}
                        <img src="{{ slot.professional.photo.url }}" alt="{{ slot.professional.display_name }}">
                    {% else %}
                        {{ slot.professional.display_name|first|upper }}
                    {% endif %}
                </div>
                <span class="professional-name">{{ slot.professional.display_name }}</span>
            </div>
            {% endif %}

            <a class="btn-book"
               href="{% url 'public:booking_confirm' tenant_slug=tenant.slug %}?service={{ selected_service.id }}{% if slot.professional %}&professional={{ slot.professional.id }}{% endif %}&start={{ slot.start|date:'c' }}">
                Reservar
            </a>
        </div>
        {% endfor %}
    </div>
</div>

{% elif selected_service %}
<div class="slots-section">
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-calendar-times"></i>
        </div>
        <h3>Nenhum horário disponível</h3>
        <p>Não encontramos horários disponíveis para a data selecionada. Tente outra data.</p>
    </div>
</div>
{% endif %}

<script>
    // Carregar profissionais via AJAX quando trocar o serviço
    document.addEventListener('DOMContentLoaded', function() {
        const serviceSelect = document.getElementById('id_service');
        const tenantSlug = '{{ tenant.slug }}';
        let selectedProfessionalId = null;
        let selectedServiceId = null;

        if (serviceSelect) {
            serviceSelect.addEventListener('change', function() {
                const serviceId = this.value;
                selectedServiceId = serviceId;
                selectedProfessionalId = null;

                if (!serviceId) {
                    // Se deselecionou, limpar profissionais e calendário
                    const professionalsSection = document.querySelector('.professionals-section');
                    if (professionalsSection) {
                        professionalsSection.remove();
                    }
                    const dateSection = document.querySelector('.date-selection-section');
                    if (dateSection) {
                        dateSection.remove();
                    }
                    const slotsSection = document.querySelector('.slots-section');
                    if (slotsSection) {
                        slotsSection.remove();
                    }
                    return;
                }

                // Fazer requisição AJAX
                fetch(`/agendar/${tenantSlug}/api/profissionais/?service_id=${serviceId}`)
                    .then(response => response.json())
                    .then(data => {
                        renderProfessionals(data.professionals, serviceId);
                    })
                    .catch(error => {
                        console.error('Erro ao carregar profissionais:', error);
                    });
            });
        }

        function renderProfessionals(professionals, serviceId) {
            // Remover seção antiga se existir
            let professionalsSection = document.querySelector('.professionals-section');
            if (professionalsSection) {
                professionalsSection.remove();
            }

            // Remover calendário e horários também
            const dateSection = document.querySelector('.date-selection-section');
            if (dateSection) {
                dateSection.remove();
            }
            const slotsSection = document.querySelector('.slots-section');
            if (slotsSection) {
                slotsSection.remove();
            }

            if (professionals.length === 0) {
                return;
            }

            // Criar nova seção
            const formSection = document.querySelector('.form-section');
            professionalsSection = document.createElement('div');
            professionalsSection.className = 'professionals-section';
            professionalsSection.innerHTML = `
                <h2 class="section-title">
                    <div class="section-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    Escolha o Profissional
                </h2>
                <div class="professionals-grid" id="professionalsGrid"></div>
            `;

            formSection.parentNode.insertBefore(professionalsSection, formSection.nextSibling);

            const grid = document.getElementById('professionalsGrid');
            professionals.forEach(prof => {
                const card = document.createElement('div');
                card.className = 'professional-card';
                card.dataset.professionalId = prof.id;

                let avatarContent = '';
                if (prof.photo_base64) {
                    avatarContent = `<img src="${prof.photo_base64}" alt="${prof.display_name}">`;
                } else if (prof.photo_url) {
                    avatarContent = `<img src="${prof.photo_url}" alt="${prof.display_name}">`;
                } else {
                    avatarContent = prof.display_name.charAt(0).toUpperCase();
                }

                card.innerHTML = `
                    <div class="professional-card-avatar" style="background: ${prof.color};">
                        ${avatarContent}
                    </div>
                    <div class="professional-card-name">${prof.display_name}</div>
                    ${prof.bio ? `<div class="professional-card-bio">${prof.bio}</div>` : ''}
                    <div class="btn-select-professional">
                        <i class="fas fa-calendar-check"></i> Selecionar
                    </div>
                `;

                // Adicionar evento de clique
                card.addEventListener('click', function(e) {
                    e.preventDefault();
                    selectProfessional(prof.id, serviceId);
                });

                grid.appendChild(card);
            });
        }

        function selectProfessional(professionalId, serviceId) {
            selectedProfessionalId = professionalId;

            // Remover classe selected de todos os cards
            document.querySelectorAll('.professional-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Adicionar classe selected ao card clicado
            const selectedCard = document.querySelector(`[data-professional-id="${professionalId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }

            // Mostrar seção de data
            showDateSelection(serviceId, professionalId);
        }

        function showDateSelection(serviceId, professionalId) {
            // Remover seção antiga se existir
            let dateSection = document.querySelector('.date-selection-section');
            if (dateSection) {
                dateSection.remove();
            }

            // Remover horários antigos
            const slotsSection = document.querySelector('.slots-section');
            if (slotsSection) {
                slotsSection.remove();
            }

            // Criar seção de data
            const professionalsSection = document.querySelector('.professionals-section');
            dateSection = document.createElement('div');
            dateSection.className = 'date-selection-section';
            dateSection.style.marginTop = '3rem';
            dateSection.style.paddingTop = '2rem';
            dateSection.style.borderTop = '2px solid #e2e8f0';
            dateSection.innerHTML = `
                <h2 class="section-title">
                    <div class="section-icon">
                        <i class="fas fa-calendar"></i>
                    </div>
                    Escolha a Data
                </h2>
                <div class="form-group">
                    <label for="date_picker">Qual data você prefere?</label>
                    <input type="date" id="date_picker" class="form-control"
                           style="width: 100%; padding: 0.875rem 1rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem;"
                           min="${new Date().toISOString().split('T')[0]}">
                </div>
            `;

            professionalsSection.parentNode.insertBefore(dateSection, professionalsSection.nextSibling);

            // Adicionar evento ao date picker
            const datePicker = document.getElementById('date_picker');
            datePicker.addEventListener('change', function() {
                const selectedDate = this.value;
                if (selectedDate) {
                    loadAvailableSlots(serviceId, professionalId, selectedDate);
                }
            });
        }

        function loadAvailableSlots(serviceId, professionalId, date) {
            // Fazer requisição AJAX para carregar horários
            const url = `/agendar/${tenantSlug}/api/horarios/?service_id=${serviceId}&professional_id=${professionalId}&date=${date}`;
            console.log('DEBUG - Carregando slots:', url);
            console.log('  serviceId:', serviceId);
            console.log('  professionalId:', professionalId);
            console.log('  date:', date);

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('DEBUG - Resposta da API:', data);
                    console.log('  Slots recebidos:', data.slots ? data.slots.length : 0);
                    renderSlots(data.slots, serviceId, professionalId);
                })
                .catch(error => {
                    console.error('Erro ao carregar horários:', error);
                });
        }

        function renderSlots(slots, serviceId, professionalId) {
            // Remover seção antiga se existir
            let slotsSection = document.querySelector('.slots-section');
            if (slotsSection) {
                slotsSection.remove();
            }

            // Criar nova seção
            const dateSection = document.querySelector('.date-selection-section');
            slotsSection = document.createElement('div');
            slotsSection.className = 'slots-section';

            if (slots.length === 0) {
                slotsSection.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <h3>Nenhum horário disponível</h3>
                        <p>Não encontramos horários disponíveis para a data selecionada. Tente outra data.</p>
                    </div>
                `;
            } else {
                slotsSection.innerHTML = `
                    <h2 class="section-title">
                        <div class="section-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        Horários Disponíveis
                    </h2>
                    <div class="slots-grid" id="slotsGrid"></div>
                `;

                dateSection.parentNode.insertBefore(slotsSection, dateSection.nextSibling);

                const grid = document.getElementById('slotsGrid');
                slots.forEach(slot => {
                    const slotCard = document.createElement('div');
                    slotCard.className = 'slot-card';
                    slotCard.innerHTML = `
                        <div class="slot-time">${slot.time}</div>
                        <div class="slot-date">${slot.date}</div>
                        <a class="btn-book" href="/agendar/${tenantSlug}/confirmar/?service=${serviceId}&professional=${professionalId}&start=${slot.start}">
                            Reservar
                        </a>
                    `;
                    grid.appendChild(slotCard);
                });

                return;
            }

            dateSection.parentNode.insertBefore(slotsSection, dateSection.nextSibling);
        }
    });
</script>
{% endblock %}
