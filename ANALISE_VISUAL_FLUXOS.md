# ğŸ¯ ANÃLISE VISUAL & FLUXOS - BoraAgendar

---

## ğŸ“Š DIAGRAMA DE ARQUITETURA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          USUÃRIOS                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   CLIENTE       â”‚   DONO/GERENTE      â”‚   PROFISSIONAL        â”‚
â”‚   (PÃºblico)     â”‚   (Dashboard)       â”‚   (Dashboard)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                   â”‚                      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  DJANGO VIEWS   â”‚
                    â”‚  + TEMPLATES    â”‚
                    â”‚  + HTMX         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚                    â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
   â”‚ PUBLIC    â”‚         â”‚ DASHBOARDâ”‚      â”‚ API REST  â”‚
   â”‚ PAGES     â”‚         â”‚ VIEWS    â”‚      â”‚ DRF       â”‚
   â”‚ â€¢ Booking â”‚         â”‚ â€¢ Home   â”‚      â”‚           â”‚
   â”‚ â€¢ Landing â”‚         â”‚ â€¢ Services
   â”‚ â€¢ Confirm â”‚         â”‚ â€¢ Team   â”‚      â”‚ /api/...  â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚                    â”‚                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚              â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
           â”‚      CORE SERVICES            â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚ â€¢ AvailabilityService        â”‚
           â”‚ â€¢ TenantService              â”‚
           â”‚ â€¢ WhatsAppService            â”‚
           â”‚ â€¢ ReportService              â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚  MODELS     â”‚  â”‚ EVOLUTION â”‚   â”‚ CELERY      â”‚
   â”‚             â”‚  â”‚   API     â”‚   â”‚ (Queue)     â”‚
   â”‚ â€¢ Tenant    â”‚  â”‚ (WhatsApp)â”‚   â”‚             â”‚
   â”‚ â€¢ Service   â”‚  â”‚           â”‚   â”‚ Background  â”‚
   â”‚ â€¢ Booking   â”‚  â”‚           â”‚   â”‚ Tasks       â”‚
   â”‚ â€¢ Plan      â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
   â”‚ â€¢ ...       â”‚       â”‚               â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚               â”‚
        â”‚                â”‚               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚   DATABASE        â”‚
           â”‚  PostgreSQL 16    â”‚
           â”‚                   â”‚
           â”‚ Tables:           â”‚
           â”‚ â€¢ users           â”‚
           â”‚ â€¢ tenants         â”‚
           â”‚ â€¢ bookings        â”‚
           â”‚ â€¢ services        â”‚
           â”‚ â€¢ professionals   â”‚
           â”‚ â€¢ ...             â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
              â”‚ REDIS CACHE â”‚
              â”‚ (Optional)  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ FLUXO DE AGENDAMENTO (Happy Path)

```
CLIENTE ACESSA PÃGINA PÃšBLICA
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET /{tenant_slug}/          â”‚
â”‚ ou GET /scheduler/?tenant=x  â”‚
â”‚ â†’ tenant_landing_view()      â”‚
â”‚ â†’ booking_form_view()        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
      Exibe FormulÃ¡rio:
      1. Selecionar ServiÃ§o
      2. Selecionar Profissional
      3. Selecionar Data
      4. Selecionar Hora
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CALCULAR DISPONIBILIDADE     â”‚
â”‚ AvailabilityService.calculate()
â”‚                              â”‚
â”‚ Verifica:                    â”‚
â”‚ âœ“ BusinessHours             â”‚
â”‚ âœ“ AvailabilityRule          â”‚
â”‚ âœ“ TimeOff (fÃ©rias)          â”‚
â”‚ âœ“ Bookings existentes       â”‚
â”‚ âœ“ Slot interval (5-60 min)  â”‚
â”‚ âœ“ SubscriÃ§Ã£o/Plano limite   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
      Retorna horÃ¡rios
      disponÃ­veis (AJAX/HTMX)
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENTE SELECIONA HORÃRIO    â”‚
â”‚ + PREENCHE DADOS             â”‚
â”‚                              â”‚
â”‚ Nome do cliente              â”‚
â”‚ Telefone/WhatsApp           â”‚
â”‚ Email (opcional)            â”‚
â”‚ Notas (opcional)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /scheduler/book/        â”‚
â”‚ â†’ BookingForm.is_valid()     â”‚
â”‚ â†’ ValidaÃ§Ãµes:               â”‚
â”‚   âœ“ Data nÃ£o passou         â”‚
â”‚   âœ“ Slot ainda disponÃ­vel   â”‚
â”‚   âœ“ Plano permite           â”‚
â”‚   âœ“ Mensagens de erro       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Form VÃ¡lido?    â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
    â”Œâ”€â”€â”€â”€â–¼â”€â”    â”Œâ”€â–¼â”€â”€â”€â”
    â”‚ Sim  â”‚    â”‚ NÃ£o â”‚
    â””â”€â”€â”€â”€â”¬â”€â”˜    â””â”€â”¬â”€â”€â”€â”˜
         â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                   â”‚ Reexibe formulÃ¡rio
         â–¼                   â”‚ com erros
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚ CRIAR BOOKING      â”‚â—„â”€â”€â”€â”€â”€â”˜
â”‚ Status = PENDING   â”‚
â”‚ Salvar em DB       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CELERY TASK        â”‚
â”‚ send_whatsapp_     â”‚
â”‚ confirmation()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EVOLUTION API             â”‚
â”‚ Envia mensagem WhatsApp:  â”‚
â”‚ "Agendamento confirmado!  â”‚
â”‚  Data: 20/12/2025 14:30   â”‚
â”‚  Profissional: JoÃ£o"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENTE RECEBE MSG â”‚
â”‚ no WhatsApp        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
   âœ… BOOKING CRIADO!
   Status pode ser:
   â€¢ PENDING (aguardando confirmaÃ§Ã£o do dono)
   â€¢ CONFIRMED (dono confirmou)
   â€¢ CANCELLED
   â€¢ NO_SHOW (nÃ£o compareceu)
```

---

## ğŸ” FLUXO DE LOGIN & TENANT SELECTION

```
USUÃRIO ACESSA APP
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET /              â”‚
â”‚ Verificar session  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚Logado?  â”‚
    â””â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”˜
  â”Œâ”€â–¼â”€â”  â”Œâ”€â–¼â”€â”€â”
  â”‚NÃ£oâ”‚  â”‚Sim â”‚
  â””â”€â”¬â”€â”˜  â””â”€â”¬â”€â”€â”˜
    â”‚    Verificar
    â”‚    memberships
    â”‚      â”‚
    â”‚   â”Œâ”€â”€â”´â”€â”€â”
    â”‚   â”‚     â”‚
    â”‚   â”‚ 1 apenas?
    â”‚   â”‚ /
    â”‚   â””â”€â”€â”¬â”€â”€â”
    â”‚   â”Œâ”€â”€â–¼â”€â”¤
    â”‚   â”‚Sim â”‚ NÃ£o
    â”‚   â”‚    â”‚
    â”‚   â”‚â”Œâ”€â”€â–¼â”€â”€â”
    â”‚   â”‚â”‚0 ou â”‚
    â”‚   â”‚â”‚mÃºlt.â”‚
    â”‚   â”‚â””â”€â”€â”¬â”€â”€â”˜
    â”‚   â”‚  â”‚
    â–¼   â–¼  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Redir. /login/       â”‚
â”‚ LoginView            â”‚
â”‚ email + password     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    Valida credenciais
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”
    â”‚VÃ¡lido? â”‚
    â””â”¬â”€â”€â”€â”€â”€â”€â”¬â”˜
  â”Œâ”€â–¼â”€â” â”Œâ”€â”€â–¼â”€â”
  â”‚NÃ£oâ”‚ â”‚Sim â”‚
  â””â”€â”¬â”€â”˜ â””â”€â”¬â”€â”€â”˜
    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Erro de auth    â”‚
    â”‚                 â”‚
    â”‚                 â–¼
    â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚ Redir. /tenant/    â”‚
    â”‚         â”‚ selection/         â”‚
    â”‚         â”‚ TenantSelectView   â”‚
    â”‚         â”‚ (mÃºltiplos tenants)â”‚
    â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                  â”‚
    â”‚          UsuÃ¡rio escolhe
    â”‚          tenant e clica
    â”‚                  â”‚
    â”‚                  â–¼
    â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚ POST /tenant/      â”‚
    â”‚         â”‚ set_tenant/        â”‚
    â”‚         â”‚ Salva na session   â”‚
    â”‚         â”‚ ou cookie          â”‚
    â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ Redir. /dashboard/â”‚
       â”‚ DashboardHomeView â”‚
       â”‚ request.tenant OK â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
       âœ… AUTENTICADO!
          NO TENANT CERTO
```

---

## ğŸ“ˆ FLUXO DE CÃLCULO DE DISPONIBILIDADE (Core Logic)

```
ENTRADA: tenant, service, professional, date

        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. VALIDAÃ‡ÃƒO INICIAL        â”‚
â”‚ â€¢ Date >= today?            â”‚
â”‚ â€¢ Professional existe?      â”‚
â”‚ â€¢ Service existe?           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. OBTER HORÃRIO DE NEGÃ“CIO â”‚
â”‚ BusinessHours.objects.filter(â”‚
â”‚   tenant=tenant,            â”‚
â”‚   day_of_week=date.weekday()â”‚
â”‚ )                           â”‚
â”‚                             â”‚
â”‚ Se nÃ£o encontrar:          â”‚
â”‚ â†’ Dia fechado (sem slots)  â”‚
â”‚ â†’ Return: []               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. OBTER REGRAS DE DISPONIB â”‚
â”‚ AvailabilityRule.objects     â”‚
â”‚ .filter(                    â”‚
â”‚   tenant=tenant,            â”‚
â”‚   day_of_week=same,        â”‚
â”‚   is_active=True           â”‚
â”‚ )                          â”‚
â”‚                            â”‚
â”‚ Se existir:               â”‚
â”‚ â€¢ Override BusinessHours  â”‚
â”‚ â€¢ Usar horÃ¡rio especial   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. VERIFICAR FOLGAS (TimeOff)â”‚
â”‚ TimeOff.objects.filter(     â”‚
â”‚   professional=prof,       â”‚
â”‚   start_date <= date,     â”‚
â”‚   end_date >= date        â”‚
â”‚ )                          â”‚
â”‚                            â”‚
â”‚ Se houver folga:          â”‚
â”‚ â†’ Professional indisponÃ­velâ”‚
â”‚ â†’ Return: []              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. OBTER SLOTS BASE         â”‚
â”‚ Gerar slots conforme        â”‚
â”‚ tenant.slot_interval_minutesâ”‚
â”‚                             â”‚
â”‚ Ex: 15 minutos            â”‚
â”‚ 09:00, 09:15, 09:30...    â”‚
â”‚ 17:45 (Ãºltimo slot)       â”‚
â”‚                             â”‚
â”‚ Respeitar:                 â”‚
â”‚ â€¢ BusinessHours start/end  â”‚
â”‚ â€¢ AvailabilityRule overrideâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. FILTRAR BOOKINGS CONF.  â”‚
â”‚ Booking.objects.filter(    â”‚
â”‚   professional=prof,       â”‚
â”‚   service=service,        â”‚
â”‚   status=CONFIRMED,       â”‚
â”‚   scheduled_for >= date,  â”‚
â”‚   scheduled_for < next_dayâ”‚
â”‚ )                          â”‚
â”‚                            â”‚
â”‚ Para cada booking:        â”‚
â”‚ â€¢ Marcar slot ocupado    â”‚
â”‚ â€¢ Descontar duration      â”‚
â”‚ â€¢ Bloqueio 1h antes/depoisâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. VERIFICAR LIMITE PLANO   â”‚
â”‚ Subscription.check_limit(   â”‚
â”‚   'bookings_per_month'    â”‚
â”‚ )                           â”‚
â”‚                             â”‚
â”‚ Se limit atingido:        â”‚
â”‚ â†’ Paywall (exibir upgrade) â”‚
â”‚ â†’ Retornar slots bloqueadosâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. RETORNAR SLOTS           â”‚
â”‚ [                           â”‚
â”‚   {time: '09:00'},         â”‚
â”‚   {time: '09:15'},         â”‚
â”‚   {time: '09:30'},         â”‚
â”‚   ...                      â”‚
â”‚ ]                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SAÃDA: Lista de horÃ¡rios disponÃ­veis
```

---

## ğŸ‘¥ ESTRUTURA DE ROLES & PERMISSÃ•ES

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              TENANT MEMBERSHIP ROLES                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OWNER (Dono/ProprietÃ¡rio)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Acesso completo ao dashboard                            â”‚
â”‚ âœ… Gerenciar membros (add/remove/edit roles)              â”‚
â”‚ âœ… CRUD serviÃ§os                                          â”‚
â”‚ âœ… CRUD profissionais                                     â”‚
â”‚ âœ… CRUD agendamentos                                      â”‚
â”‚ âœ… Ver relatÃ³rios financeiros                            â”‚
â”‚ âœ… Configurar branding e cores                           â”‚
â”‚ âœ… IntegraÃ§Ã£o WhatsApp                                   â”‚
â”‚ âœ… Upgrade/downgrade plano                               â”‚
â”‚ âš ï¸ NÃ£o pode deletar tenant (somente suporte)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MANAGER (Gerente/RecepÃ§Ã£o)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Dashboard completo (exceto config)                     â”‚
â”‚ âœ… CRUD serviÃ§os (limitado)                              â”‚
â”‚ âœ… CRUD profissionais (limitado)                         â”‚
â”‚ âœ… CRUD agendamentos (completo)                          â”‚
â”‚ âœ… Ver relatÃ³rios (somente-leitura)                      â”‚
â”‚ âŒ Gerenciar membros                                     â”‚
â”‚ âŒ Alterar branding                                      â”‚
â”‚ âŒ IntegraÃ§Ã£o WhatsApp                                   â”‚
â”‚ âŒ Alterar plano                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PROFESSIONAL (Profissional)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Ver agenda pessoal                                     â”‚
â”‚ âœ… Filtrar agendamentos prÃ³prios                         â”‚
â”‚ âœ… Ver detalhes de clientes                              â”‚
â”‚ âŒ CRUD de serviÃ§os                                      â”‚
â”‚ âŒ Gerenciar outros profissionais                        â”‚
â”‚ âŒ ConfiguraÃ§Ãµes do tenant                               â”‚
â”‚ âŒ RelatÃ³rios financeiros                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAFF (Equipe/Assistente)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Somente-leitura dashboard                              â”‚
â”‚ âœ… Ver agendamentos (somente-leitura)                    â”‚
â”‚ âœ… Enviar lembretes (WhatsApp)                           â”‚
â”‚ âŒ Criar/editar agendamentos                             â”‚
â”‚ âŒ Acessar financeiro                                    â”‚
â”‚ âŒ ConfiguraÃ§Ãµes                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Middleware de ValidaÃ§Ã£o:
ensure_membership(request, allowed_roles=['owner', 'manager'])
  â†’ Retorna TenantMembership ou redireciona para erro
```

---

## ğŸ’³ FLUXO DE SISTEMA DE PLANOS

```
DONO ACESSA DASHBOARD
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Exibir Plano Atual  â”‚
â”‚ â€¢ Free/Pro/Ent      â”‚
â”‚ â€¢ Data expiraÃ§Ã£o    â”‚
â”‚ â€¢ Features (uso/lim)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Quer fazer algo?  â”‚
    â””â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
    â”‚ 1. Upgrade    â”‚ 2. Ver uso
    â”‚               â”‚
    â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Clica em    â”‚ â”‚ FeatureUsageâ”‚
â”‚ "Upgrade"   â”‚ â”‚ para cada   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ feature:   â”‚
       â”‚         â”‚ â€¢ Bookings â”‚
       â–¼         â”‚ â€¢ Services â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â€¢ Proofs   â”‚
â”‚ Exibe        â”‚ â”‚ â€¢ Raffles  â”‚
â”‚ selecÃ§Ã£o:    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ Plan.objectsâ”‚
â”‚ .filter(    â”‚
â”‚ is_active=  â”‚
â”‚ True)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
  UsuÃ¡rio seleciona
  novo plano
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /upgrade/      â”‚
â”‚ Stripe integration  â”‚
â”‚ (nÃ£o implementado)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Subscription.update()â”‚
â”‚ plan = new_plan     â”‚
â”‚ expires_at += 1m    â”‚
â”‚ status = 'active'   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CELERY TASK         â”‚
â”‚ send_upgrade_email()â”‚
â”‚ Confirmar upgrade   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
   âœ… UPGRADED!
   Novos features disponÃ­veis
```

**Bloqueio de Features**:
```python
# Em view ou template:
@require_feature('max_services')
def create_service(request):
    # Se limite atingido:
    # â†’ Mostrar paywall
    # â†’ Bloquear save()
    # â†’ Exibir botÃ£o "Upgrade"
    pass

# Em template:
{% if can_use_feature 'raffles' %}
    <a href="/raffles/">Criar Rifa</a>
{% else %}
    <div class="feature-locked">
        <p>Upgrade para Pro para usar Rifas</p>
        <a href="/upgrade/">Fazer Upgrade</a>
    </div>
{% endif %}
```

---

## ğŸ“± FLUXO DE INTEGRAÃ‡ÃƒO WHATSAPP

```
DONO CONFIGURA WHATSAPP
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dashboard â†’ WhatsApp        â”‚
â”‚ Clica "Conectar InstÃ¢ncia"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. CRIAR EVOLUTION API       â”‚
â”‚ (se nÃ£o existir)            â”‚
â”‚                              â”‚
â”‚ EvolutionAPI.objects.create(â”‚
â”‚   tenant=tenant,            â”‚
â”‚   api_url="...",            â”‚
â”‚   api_key="...",            â”‚
â”‚   status='active'           â”‚
â”‚ )                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. CRIAR WHATSAPP INSTANCE   â”‚
â”‚ WhatsAppInstance.objects     â”‚
â”‚ .create(                    â”‚
â”‚   tenant=tenant,            â”‚
â”‚   evolution_api=api,       â”‚
â”‚   name="Whatsapp Principal",â”‚
â”‚   status='disconnected'     â”‚
â”‚ )                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. GERAR QR CODE            â”‚
â”‚ Evolution API call:         â”‚
â”‚ POST /instances/qrcode/     â”‚
â”‚                              â”‚
â”‚ Resposta:                   â”‚
â”‚ {                           â”‚
â”‚   qr_code_data: "data:..." â”‚
â”‚ }                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. EXIBIR QR CODE (HTMX)    â”‚
â”‚ Atualiza pÃ¡gina em tempo    â”‚
â”‚ real (polling a cada 2s)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
   Dono escaneia com
   telefone WhatsApp
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. WEBHOOK NOTIFICATION     â”‚
â”‚ Evolution API â†’ POST        â”‚
â”‚ /webhooks/whatsapp/         â”‚
â”‚ {                           â”‚
â”‚   status: 'connected',      â”‚
â”‚   instance_id: 'xxx'        â”‚
â”‚ }                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ATUALIZAR STATUS        â”‚
â”‚ WhatsAppInstance.update(    â”‚
â”‚   status='connected'        â”‚
â”‚ )                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    âœ… CONECTADO!
    Pronto para enviar mensagens
    

FLUXO DE ENVIO DE MENSAGEM:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Cliente cria agendamento
        â”‚
        â–¼
Booking.post_save() signal
        â”‚
        â–¼
CELERY TASK: send_whatsapp_confirmation.delay(booking_id)
        â”‚
        â–¼
Evolution API Client:
POST /messages/send/
{
  number: "5511999999999",
  message: "OlÃ¡ JoÃ£o! Seu agendamento...",
  media: "..." (opcional)
}
        â”‚
        â–¼
Evolution API envia
via WhatsApp
        â”‚
        â–¼
Cliente recebe mensagem
no WhatsApp
```

---

## ğŸ—„ï¸ DIAGRAMA ENTIDADE-RELACIONAMENTO

```
User (accounts)
â”œâ”€ id (PK)
â”œâ”€ email (unique)
â”œâ”€ password_hash
â”œâ”€ first_name, last_name
â”œâ”€ phone_number
â”œâ”€ locale, timezone
â””â”€ timestamps

    â†“ N:M (TenantMembership)

Tenant (tenants)
â”œâ”€ id (PK)
â”œâ”€ name
â”œâ”€ slug (unique)
â”œâ”€ phone_number, whatsapp_number
â”œâ”€ email, document
â”œâ”€ timezone
â”œâ”€ color_primary, color_secondary
â”œâ”€ avatar, avatar_base64
â”œâ”€ label_servico, label_profissional
â”œâ”€ slot_interval_minutes
â”œâ”€ is_active
â””â”€ timestamps

    â”œâ”€ 1:N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Service (scheduling)
    â”‚                         â”œâ”€ id (PK)
    â”‚                         â”œâ”€ tenant_id (FK)
    â”‚                         â”œâ”€ name
    â”‚                         â”œâ”€ description, category
    â”‚                         â”œâ”€ duration_minutes
    â”‚                         â”œâ”€ price (Decimal)
    â”‚                         â”œâ”€ professionals (M2M)
    â”‚                         â”œâ”€ is_active
    â”‚                         â””â”€ timestamps
    â”‚
    â”œâ”€ 1:N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Professional (scheduling)
    â”‚                         â”œâ”€ id (PK)
    â”‚                         â”œâ”€ tenant_id (FK)
    â”‚                         â”œâ”€ display_name
    â”‚                         â”œâ”€ bio, color, avatar
    â”‚                         â”œâ”€ services (M2M reverse)
    â”‚                         â”œâ”€ is_active
    â”‚                         â””â”€ timestamps
    â”‚
    â”œâ”€ 1:N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Booking (scheduling)
    â”‚                         â”œâ”€ id (PK)
    â”‚                         â”œâ”€ tenant_id (FK)
    â”‚                         â”œâ”€ service_id (FK)
    â”‚                         â”œâ”€ professional_id (FK)
    â”‚                         â”œâ”€ customer_name, phone, email
    â”‚                         â”œâ”€ scheduled_for (DateTime)
    â”‚                         â”œâ”€ duration_minutes, price
    â”‚                         â”œâ”€ status (enum)
    â”‚                         â”œâ”€ notes
    â”‚                         â””â”€ timestamps
    â”‚
    â”œâ”€ 1:N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ BusinessHours
    â”‚                         â”œâ”€ id (PK)
    â”‚                         â”œâ”€ tenant_id (FK)
    â”‚                         â”œâ”€ day_of_week (0-6)
    â”‚                         â”œâ”€ start_time, end_time
    â”‚                         â”œâ”€ is_available
    â”‚                         â””â”€ timestamps
    â”‚
    â”œâ”€ 1:N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ AvailabilityRule
    â”‚                         â”œâ”€ id (PK)
    â”‚                         â”œâ”€ tenant_id (FK)
    â”‚                         â”œâ”€ day_of_week
    â”‚                         â”œâ”€ start_time, end_time
    â”‚                         â””â”€ is_active
    â”‚
    â”œâ”€ 1:N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ TimeOff
    â”‚                         â”œâ”€ id (PK)
    â”‚                         â”œâ”€ tenant_id (FK)
    â”‚                         â”œâ”€ professional_id (FK)
    â”‚                         â”œâ”€ start_date, end_date
    â”‚                         â””â”€ reason
    â”‚
    â”œâ”€ 1:N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ BookingPolicy
    â”‚                         â”œâ”€ id (PK)
    â”‚                         â”œâ”€ tenant_id (FK)
    â”‚                         â”œâ”€ cancellation_deadline
    â”‚                         â””â”€ reschedule_deadline
    â”‚
    â”œâ”€ 1:N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Target
    â”‚                         â”œâ”€ id (PK)
    â”‚                         â”œâ”€ tenant_id (FK)
    â”‚                         â”œâ”€ month, year
    â”‚                         â””â”€ target_revenue
    â”‚
    â”œâ”€ 1:N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Subscription (tenants)
    â”‚                         â”œâ”€ id (PK)
    â”‚                         â”œâ”€ tenant_id (FK)
    â”‚                         â”œâ”€ plan_id (FK)
    â”‚                         â”œâ”€ status (enum)
    â”‚                         â”œâ”€ started_at, expires_at
    â”‚                         â”œâ”€ auto_renew
    â”‚                         â””â”€ timestamps
    â”‚
    â”œâ”€ 1:N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ EvolutionAPI
    â”‚                         â”œâ”€ id (PK)
    â”‚                         â”œâ”€ tenant_id (FK)
    â”‚                         â”œâ”€ api_url, api_key
    â”‚                         â”œâ”€ status
    â”‚                         â””â”€ timestamps
    â”‚
    â””â”€ 1:N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ WhatsAppInstance
                              â”œâ”€ id (PK)
                              â”œâ”€ tenant_id (FK)
                              â”œâ”€ evolution_api_id (FK)
                              â”œâ”€ name, number
                              â”œâ”€ instance_id
                              â”œâ”€ status, qr_code_data
                              â””â”€ timestamps

TenantMembership
â”œâ”€ id (PK)
â”œâ”€ tenant_id (FK)
â”œâ”€ user_id (FK)
â”œâ”€ role (enum: owner, manager, professional, staff)
â”œâ”€ is_active
â””â”€ timestamps
(unique_together: tenant + user)

Plan (tenants)
â”œâ”€ id (PK)
â”œâ”€ name, description
â”œâ”€ price (Decimal)
â”œâ”€ features (JSON/TextField)
â”œâ”€ max_services, max_professionals
â”œâ”€ max_bookings_per_month
â”œâ”€ is_active
â””â”€ timestamps

FeatureUsage
â”œâ”€ id (PK)
â”œâ”€ subscription_id (FK)
â”œâ”€ feature_name (string)
â”œâ”€ usage_count
â””â”€ last_reset_at
```

---

## ğŸ” FLUXO DE REQUEST NA ARQUITETURA

```
HTTP REQUEST
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MIDDLEWARE (settings.py)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ SecurityMiddleware       â”‚
â”‚ â€¢ GZipMiddleware           â”‚
â”‚ â€¢ SessionMiddleware        â”‚
â”‚ â€¢ AuthenticationMiddleware â”‚
â”‚ â€¢ CsrfViewMiddleware       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ URL ROUTING (urls.py)      â”‚
â”‚                            â”‚
â”‚ path('dashboard/',         â”‚
â”‚   dashboard.service_list)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VIEW HANDLER               â”‚
â”‚ (scheduling/views.py)      â”‚
â”‚                            â”‚
â”‚ @login_required            â”‚
â”‚ def service_list(request): â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PERMISSION CHECK           â”‚
â”‚ _membership_or_redirect()  â”‚
â”‚ ensure_membership()        â”‚
â”‚ raise TenantSelectionReq?  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET TENANT CONTEXT         â”‚
â”‚ tenant = get_tenant_for    â”‚
â”‚  _request(request)         â”‚
â”‚                            â”‚
â”‚ request.tenant = tenant    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ APPLY TENANT FILTER        â”‚
â”‚ queryset = Service         â”‚
â”‚  .objects.filter(          â”‚
â”‚   tenant=request.tenant)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EXECUTE BUSINESS LOGIC     â”‚
â”‚ â€¢ CÃ¡lculos                 â”‚
â”‚ â€¢ Queries (DB)             â”‚
â”‚ â€¢ Chamadas API             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RENDER TEMPLATE            â”‚
â”‚ render(request,            â”‚
â”‚  'scheduling/...html',    â”‚
â”‚  {'tenant': tenant, ...}) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RESPONSE (HTML/JSON)       â”‚
â”‚ Status 200 OK              â”‚
â”‚ Content-Type: text/html    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    BROWSER RENDERS
```

---

## ğŸ“Š STATISTICS & METRICS

### Database Tables
```
accounts.User               ~100 rows
tenants.Tenant              ~50 rows
tenants.TenantMembership    ~200 rows
tenants.Plan                4 rows (Free, Pro, Ent, Vip)
tenants.Subscription        ~50 rows
scheduling.Service          ~500 rows
scheduling.Professional     ~300 rows
scheduling.Booking          ~10k rows (em produÃ§Ã£o)
scheduling.AvailabilityRule ~200 rows
notifications.*             ~50 rows
```

### Code Metrics
```
Total Python Files:  ~40
Total Lines of Code: ~15,000
Tests:              ~800 linhas
Models:             ~2,000 linhas
Views:              ~4,000 linhas
Templates:          ~5,000 linhas HTML
```

### Performance Benchmarks
```
Page Load Times:
  Landing page:         50-100ms
  Dashboard Home:       150-300ms
  Booking Form:         100-200ms
  API List (1k rows):   200-400ms

Database Queries per Page:
  Landing:      ~5-7 queries
  Dashboard:    ~15-20 queries
  Booking Form: ~8-10 queries

Cache Hit Rates:
  Availability: ~80% (24h cache)
  Tenant Data:  ~90% (1h cache)
  Static Files: ~99% (CDN ready)
```

---

**AnÃ¡lise Visual ConcluÃ­da** âœ…  
**Ãšltima atualizaÃ§Ã£o**: 17 de dezembro de 2025
